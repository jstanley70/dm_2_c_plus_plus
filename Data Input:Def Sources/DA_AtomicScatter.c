//Macintosh HD:CodeWarriorª DR/3 Gold Ä:Metrowerks  C/C++ Ä:Projects:D.M. v2.0:Sources.Jim:Data Input/Def Sources:DA_AtomicScatter.c#include	"Diffract_INCs.h"#include	"AtomicScatter.h"enum{	FINISHED = 1,	ATOMNAME,	AMPRECT,	SCROLLAA,	GETAA,	ENTER1,	AAVALUE,	AACLICK,	POPUPMENUAA};#define DLOG_ATOMICSCATTER 1007void	AtomicScatter::DoDefine(short atomicNum,short theBeam){	short 			item,type,n = 0,	theSelect , oldSelect;	Handle 			theHandle;	/*pascal Boolean 	TheFilter();*/	Crystal			*theCrystal;	short			beamType;	long			theResult;	Rect			theRect;	GrafPtr			oldPort;	PopUpMenu		*thePopMenu;		if(atomicNum == 0)return;	GetPort(&oldPort);	this->theDialog = DM_GetNewDialog(DLOG_ATOMICSCATTER, 0L,(WindowPtr)-1L);	beamType = theBeam;	if(atomicNum != 0){		GetAtomicAmps(atomicNum,beamType);	}		theCrystal = (Crystal*)D_new(Crystal);	theCrystal->InitCrystal(0);	theCrystal->GetAtomicSymbol(atomicNum,gTheText);	GetDItem(theDialog,ATOMNAME,&gType,&gTheHandle,&gTheRect);	SetIText(gTheHandle,c2pstr(gTheText));	InitListings();	SetListings();	gTheCell.h = 1;	gTheCell.v = 0;	GetDItem		(theDialog,AAVALUE,&type,&gTheHandle,&gTheRect);	sprintf			(gTheText,"%6.2f",atomicAmps[0]);	LSetSelect		(true,gTheCell,theAtomAmpList);	SetIText		(gTheHandle,c2pstr(gTheText));	SelIText		(theDialog,AAVALUE,0,32767);	thePopMenu	=	(PopUpMenu*)D_new(PopUpMenu);	thePopMenu 	-> 	Init(theDialog,POPUPMENUAA,121,beamType);	theSelect = oldSelect = AAVALUE;	while(1 != 2){		SystemTask();				ModalDialog(TheFilterUPP,&item);		switch(item){			case ENTER1:							GetDItem(theDialog,ATOMNAME,&type,&theHandle,&theRect);				GetIText(theHandle,pTheText);				atomicNum = theCrystal->TheAtomicNum(p2cstr(pTheText));				if(atomicNum == 0)break;				SetAtomicAmps(atomicNum,beamType);								SetListings();				thePopMenu->SetPopUp();				break;			case FINISHED:			case CANCELCLICK: 				thePopMenu->DoClose();				if(theAtomAmpList != 0L)					LDispose(theAtomAmpList);				DM_DisposDialog(&(this->theDialog));				theCrystal->DoClose();				return;				case AACLICK:			case ENTERCLICK:				GetDItem		(theDialog,AAVALUE,&type,&theHandle,&theRect);				GetIText		(theHandle,pTheText);				atomicAmps[gTheCell.v] = atof(p2cstr(pTheText));				gTheCell.h = 1;				c2pstr			(gTheText);				LSetCell(&(gTheText[1]),(short)(gTheText[0]),gTheCell,theAtomAmpList);								if(gTheCell.v == 22){					LSetSelect		(false,gTheCell,theAtomAmpList);					gTheCell.v = 0;					SetListings();					SysBeep(10);					sprintf			(gTheText,"%6.2f",atomicAmps[gTheCell.v]);					LSetSelect		(true,gTheCell,theAtomAmpList);					SetIText		(theHandle,c2pstr(gTheText));					SelIText		(theDialog,AAVALUE,0,32767);					break;				}				GetDItem		(theDialog,AAVALUE,&type,&theHandle,&theRect);				LSetSelect		(false,gTheCell,theAtomAmpList);				sprintf			(gTheText,"%6.2f",atomicAmps[++gTheCell.v]);				LSetSelect		(true,gTheCell,theAtomAmpList);				SetIText		(theHandle,c2pstr(gTheText));				SelIText		(theDialog,AAVALUE,0,32767);				LAutoScroll		(theAtomAmpList);				break;			case AAVALUE:			case ATOMNAME:				break;			case AMPRECT:				HandleListRect();				GetDItem(theDialog,AAVALUE,&type,&theHandle,&theRect);				sprintf(gTheText,"%6.2f",atomicAmps[gTheCell.v]);				SetIText(theHandle,c2pstr(gTheText));				SelIText(theDialog,AAVALUE,0,32767);				break;			case SCROLLAA:				GlobalToLocal(&(gTheEvent.where));				LClick(gTheEvent.where,gTheEvent.modifiers,theAtomAmpList);				break;							case GETAA:				GETATOM: GetDItem(theDialog,ATOMNAME,&type,&theHandle,&theRect);				GetIText(theHandle,pTheText);				atomicNum = theCrystal->TheAtomicNum(p2cstr(pTheText));				if(atomicNum == 0) break;				GetAtomicAmps(atomicNum,beamType);				SetListings();				break;							case POPUPMENUAA:								theResult = thePopMenu->DoPopUp();				if(LoWord(theResult))					beamType = LoWord(theResult);				thePopMenu->SetPopUp();								GetDItem(theDialog,ATOMNAME,&type,&theHandle,&theRect);				GetIText(theHandle,pTheText);				atomicNum = theCrystal->TheAtomicNum(p2cstr(pTheText));								if(atomicNum == 0) break;				GetAtomicAmps(atomicNum,beamType);				SetListings();				break;			default:				break;			case ML_UPDATE_EVT:					BeginUpdate(theDialog);				UpdtDialog(theDialog,theDialog->visRgn);				if(!gAppleEvtsOK){					HiliteOK(theDialog);				}				EndUpdate(theDialog);				break;		}	}}void	AtomicScatter::InitListings(void){	FontInfo 	theFont;	short		textHeight;	Point		cellSize;	Handle 		theHandle;	Rect 		theRect,				rBounds;	short		type;			GetDItem(theDialog,AMPRECT,&type,&theHandle,&theRect);		GetFontInfo(&theFont);	textHeight = theFont.ascent + theFont.descent + theFont.leading;	SetRect(&rBounds,0,0,2,23);	cellSize.h = (theRect.right - theRect.left - 2) / 2;	cellSize.v = textHeight;	theAtomAmpList = LNew(&theRect,&rBounds,cellSize,0,theDialog,true,false,false,true);	(*theAtomAmpList)->selFlags = 0x80;		return;}void	AtomicScatter::SetListings(void){	short 		i;	Cell 		theCell;	Handle 		theHandle;	Rect 		theRect;	short 		type,n;	double 		s;		GetDItem(theDialog,AMPRECT,&type,&theHandle,&theRect);	PenSize(2,2);	InsetRect(&theRect,-2,-2);	dm_FrameRect(&theRect);		PenSize(1,1);	dm_FrameRect(&theRect);	PenNormal();	theCell.h = 0;	n = 0;	for(i = 0 ; i <= 22 ; i++){		theCell.v = i;		s = n;		s /= 100;		sprintf(gTheText,"%6.2f",s);		c2pstr(gTheText);		LSetCell(&(gTheText[1]),(short)(gTheText[0]),theCell,theAtomAmpList);		if(n >= 200 && n < 300) n += 50;		if(n >= 100 && n < 200) n += 20;		if(n >= 50 && n < 100) n += 10;		if(n < 50 ) n += 5;	}	theCell.h = 1;	for(i = 0 ; i <= 22 ; i++){		theCell.v = i;		sprintf(gTheText,"%6.2f",atomicAmps[i]);		c2pstr(gTheText);		LSetCell(&(gTheText[1]),(short)(gTheText[0]),theCell,theAtomAmpList);	}	return;}void AtomicScatter::HandleListRect(void){	Point thePoint;	Cell theCell;	short i,k;	Rect theRect;	Boolean flag;	GlobalToLocal(&(gTheEvent.where));	SetPort(theDialog);	flag = LClick(gTheEvent.where,gTheEvent.modifiers,theAtomAmpList);	GetMouse(&thePoint);	SetRect(&theRect,-5,-5,-5,-5);	theCell.h = 1;	for(i = 0;i <= 22;i++){		theCell.v = i;		for(k = 0;k <= 1;k++){			theCell.h = k;			LRect(&theRect,theCell,theAtomAmpList);			if(PtInRect(thePoint,&theRect)){				gTheCell.v = theCell.v;				gTheCell.h = theCell.h;			}		}	}	if(gTheCell.h == 0){		LSetSelect(false,gTheCell,theAtomAmpList);		gTheCell.h = 1;		LSetSelect(true,gTheCell,theAtomAmpList);	}}void AtomicScatter::SetAtomicAmps(short atomicNum,short beamType){	short 		i;	short 		**newScatters;	Handle 		theReshandle;	Crystal 	*theCrystal;	Cell 			theCell;	ResType 	rType;	short 		*theValue;	UseResFile(g_AppResFile);			switch(beamType)	{		case 1:			rType = 'Atom';			break;		case 2:			rType = 'XrSc';			break;		case 3:			rType = 'NSCT';			break;	}	theCell.h = 1;	newScatters = (short**)D_NewHandle(23 * sizeof(short));	D_HLock((Handle)newScatters);	theValue = *newScatters;	for(i = 0 ; i <= 22 ; i++,theValue++){		short length;				theCell.v = i;		length = sizeof(char) * 255;		LGetCell	(&(gTheText[1]),&length,theCell,theAtomAmpList);		gTheText[0] 	= 	(char)length;		p2cstr				(pTheText);		atomicAmps[i] 	= 	atof(gTheText);		*theValue = Round((double)(atomicAmps[i] * 100.));	}	D_HUnlock((Handle)newScatters);		theReshandle = GetResource(rType,atomicNum);		if(theReshandle != 0L){				if(Question(CANT_OPEN_FROM_FNDR)){			 ReleaseResource(theReshandle);       KillHandle((Handle*)&newScatters);			return;		}		GetResInfo((Handle)theReshandle,&atomicNum,&rType,(unsigned char*)gTheText);		ReleaseResource(theReshandle);	}else{		theCrystal = (Crystal*)D_new(Crystal);		theCrystal->GetAtomicSymbol(atomicNum,gTheText);		D_delete		(theCrystal);		c2pstr			(gTheText);	}	#if defined(_newkey_)		gDefault->SetPreferenceFile	((Handle)newScatters,atomicNum,rType,gTheText);	#endif			KillHandle								((Handle*)&newScatters);	UpdateResFile							(g_AppResFile);	FlushVol			(0L,0);		return;}Boolean		AtomicScatter::GetAtomicAmps(short atomicNum,short beamType){	short 	i;	short 	*aa;	ResType Type;	Handle 	theReshandle;		switch(beamType)	{		case 1:			Type = 'Atom';			break;		case 2:			Type = 'XrSc';			break;		case 3:			Type = 'NSCT';			break;				}			theReshandle = GetResource(Type,atomicNum);	if(theReshandle == 0L){		for(i = 0; i <= 22;i++)  atomicAmps[i] = 0.0;		return false;	}	aa = (short*)*theReshandle;	for(i = 0; i <= 22;i++)  atomicAmps[i] = (double)aa[i] / (double)100;	ReleaseResource(theReshandle);	return true;}#include "UextBoxFree.h"void AtomicScatter::SetGeneralListing(Cell startCell,Boolean hor,TextBoxFree		*textBox,short beam,short atomicNum){	Cell theCell;	short i;	double s;	short  n = 0;	GetAtomicAmps( atomicNum, beam);	theCell = startCell;	for(i = 0 ; i <= 22 ; i++){		if(hor)		theCell.h = i;		else		theCell.v = i;		s = n;		s /= 100;		sprintf(gTheText,"%6.2f",s);		textBox->SetListText(gTheText, 	theCell);		if(n >= 200 && n < 300) n += 50;		if(n >= 100 && n < 200) n += 20;		if(n >= 50 && n < 100) n += 10;		if(n < 50 ) n += 5;	}	theCell = startCell;	if(hor)		theCell.v += 1;	else		theCell.h += 1;			for(i = 0 ; i <= 22 ; i++){		if(hor)			theCell.h = i;		else			theCell.v = i;		sprintf(gTheText,"%6.2f",atomicAmps[i]);		textBox->SetListText(gTheText,theCell);	}}void AtomicScatter::sValues(double *theSs){	short i;	double s;	short  n = 0;		for(i = 0 ; i <= 22 ; i++){		s = n;		theSs[i] = s /= 100;		if(n >= 200 && n < 300) n += 50;		if(n >= 100 && n < 200) n += 20;		if(n >= 50 && n < 100) n += 10;		if(n < 50 ) n += 5;	}}void AtomicScatter::Kill(void){		D_delete(this);}