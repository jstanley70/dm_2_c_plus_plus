//0:Sources.Jim:Diffract:DI_Diffract.c#define		DIF_MAIN	10#include	"Diffract_INCs.h"#include	<shutdown.h>#include	<GestaltEqu.h>#include "ML_Multilog.h"//#define		KEY_VERSION	0   /* For comparing Key Version Numbers 2*/#include	"EveMacros.h"//#include "bughunt.h"#ifdef NETWORK_VERSION	#include	"MsgObject.h"	ComBlock*	theComBlock;	long		lastVerify; 	NMRec		theNMRec;	char		theNMString1[128];#endifextern short OpenResourceFile(void);extern void	TestNumObjects(void);Boolean			WrongSN(unsigned long);void			SetSN(void);void			SetGPR(long);void			main(void);long			restartProc(void);void			DoInits(void);extern	OSErr	InstallAppleEvents(void);char*			InitPrams(void);void			KillPrams(void);void			test(void);ProcPtr			DecodeRes(ResType,short);//void			SetPrefFiles(void);extern	PicHandle 	DoUserInfo(Rect*	thePicRect);void	main(){short			n = 0,m,progID;	PicHandle		thePicture;	char			theText[256];	char			*dummyCharPtr;	unsigned short	theResp;	WindowPtr		startupWindow;	PicHandle		startupPict;	#if defined(_newkey_)	unsigned long	theSN;	#endif#ifdef NETWORK_VERSION	unsigned char 	**theName;	Handle			theRes;	short			sNum,iErr;#endif	g_AppResFile	= CurResFile();	n = 0;	dummyCharPtr 	= (char*)0L;/*	SetApplLimit((Ptr)ApplicZone() + 512000);  */	MaxApplZone();		DoInits();	D_HandleInit();//	n = OpenResourceFile();	gDefault = gCurrentObj = (DiffractObject*)NUL;	gTheText = theText;	pTheText = (unsigned char*)theText;	startupWindow = GetNewCWindow(129,0L,(WindowPtr)-1L);	SetPort(startupWindow);	startupPict = GetPicture(129);	DetachResource((Handle)startupPict);//august 1996	DrawPicture(startupPict,&startupWindow->portRect);	KillPicture (startupPict);	WatchInstall();	StartWatch();#if defined(_newkey_)	gTheKeyHandle = (Handle)RBEHANDLE();	SetSN();	theResp =  RBEFINDFIRST(0x8802,&theSN,gTheKeyHandle);#endif	#ifdef NETWORK_VERSION	lastVerify 	= 0;	progID		= 67;	m 			= 17;	dummyCharPtr = InitPrams();		theComBlock	= (ComBlock*)new(ComBlock);		gCurrentObj	 =	gDefault = (DiffractObject*)AllocDiffractObj();			SetRect(&gTheRect,0,0,300,200);	StopWatch();	thePicture = DoUserInfo(&gTheRect);	StartWatch();	KillPicture(thePicture);	theName		= (unsigned char**)GetResource('DATA',128); /* users Name */	if(ResError() != 0 || (Handle)theName == NUL){		theName = (unsigned char**)NewHandle(128L * sizeof(char));		AddResource((Handle)theName,'DATA',128,"\pUser Name");		ChangedResource((Handle)theName);		WriteResource((Handle)theName);		theName = (unsigned char**)GetResource('DATA',128);	}	strcpy(gTheRoutine,"main");	D_HLock(theName);	p2cstr(*theName);	if(**theName == (char)0){		strcpy((char*)*theName,"Unknown User");	}		theRes 		= GetResource('ERIC',500);	sNum 		=  **((short**)(theRes));	sNum 		^= 0x7F29;									/* Program Serial Number */	ReleaseResource(theRes);	theComBlock->DoInit((char*)*theName,sNum,KEY_VERSION);	D_HUnlock(theName);	ReleaseResource((Handle)theName);		theComBlock->FindServer();	if(theComBlock->iErr != noErr){		theComBlock->theInfo->response = NO_KEY_ON_NET;		progID = 0;		goto NetKeyErrorHandle;	}		theComBlock->LogOn();	if(theComBlock->theInfo->response != LOGON_OK){		progID = 0;		goto NetKeyErrorHandle;	} else {		gSecure = 17;	//	theComBlock->BGInstall();	}#else	#if defined(_newkey_) && !defined(_DEMOVERS_/*added _*/)	theResp =  RBEFINDFIRST(0x8802,&theSN,gTheKeyHandle);	n = theResp;	if(theResp == E3_SUCCESS){		while(n == E3_SUCCESS && WrongSN(theSN)){			n =  RBEFINDNEXT(&theSN,gTheKeyHandle);		}		theResp = 101;	} else {		theResp = 100;		goto KeyErrors;	}	#else 			n = EVEStatus();			#endif	/*	3. I still haven't checked opening of saved files.n = 0; */				#if defined(_DEMOVERS_/*added _*/)			n = 0;			#endif		if(n != 0){		#if defined(_newkey_)			DisposHandle(gTheKeyHandle);			goto KeyErrors;		#else			n = EVEReset();		#endif		gCurrentObj	=	gDefault = (DiffractObject*)AllocDiffractObj(); // keeps cursor alive		StopWatch();		gCurrentObj->DoClose();		StopAlert(COPY_PROTECT,NUL); 		WatchRemove();		ExitToShell();	}	#if defined(_newkey_)		n = -1957;		n = RBEREAD(0x0000,(unsigned short*)&m,0xf85b,gTheKeyHandle);		dummyCharPtr = InitPrams();	#else		n = EVEEnable(InitPrams());				m = EVEChallenge(1,-1957);		n = EVEReset();	#endif	gCurrentObj	=	gDefault = (DiffractObject*)AllocDiffractObj();	gSecure = m;#endif			gDefault->SetObjectDrawTransferMode();	g_Monitor = gInColor;#ifdef NETWORK_VERSION	theComBlock->SaveAddress();		if(theComBlock->theInfo->response != PTR_SAVE_OK){		goto NetKeyErrorHandle;		m = 0;	}	#else		#if defined(_newkey_)		n 	= RBEREAD(0x02,(unsigned short*)&progID,2248,gTheKeyHandle);	#else		progID 	= EVEEnable(g_EVE_Read_Password);  /* Check Program ID */		progID 	= EVEChallenge(2,2248);		n 		= EVEReset();	#endif#endif		#ifndef _DEMOVERS_		/*progID = 67;	copy protect*/		if(progID != 67){							/* If Not D.M. Key */			goto AbortProc;		}	#endif	  	gTheWindowStart.h = 5;	gTheWindowStart.v = 45;		gCurrentObj->DoIdle(); 	/*m = 17;copy protect*/	#ifndef _DEMOVERS_	if(gSecure != 17){		gQuitFlag = gShutdown = true;	}	#endif	  #ifdef NETWORK_VERSION	theComBlock->DoConfirm();	theComBlock->WaitForMessage(&iErr);	if(iErr != 0)		progID = 0;	if(theComBlock->theInfo->response != CONFIRM_OK){		goto NetKeyErrorHandle;		gQuitFlag = true;	}#else	SetRect(&gTheRect,0,0,300,200);	StopWatch();	thePicture = DoUserInfo(&gTheRect);	StartWatch();	KillPicture(thePicture);	#if defined(_newkey_) && !defined(_DEMOVERS_/*added _*/)		KEYTEST(gQuitFlag);	#endif	if(gQuitFlag){		theResp = 2 + 4 * (short)sqrt(625.0);		goto KeyErrors;	}		#endif	StopWatch();	DisposeWindow(startupWindow);	#if defined(_newkey_)			gDefault->GetPreferenceFile();	#endif	while(!gQuitFlag){		gDebugVar = 0;		CSwitchboard();	}		QuitHere:	;								/* "return" address of @AbortProc */	if(gCurrentObj != (DiffractObject*)NUL){		CloseAllObjects();#ifdef NETWORK_VERSION		StartWatch();		theComBlock->LogOff();		StopWatch();#endif		WatchRemove();			gDefault->DoClose();	}	#ifdef NETWORK_VERSION//	theComBlock->BGRemove();//	theComBlock->LogOff();#else	#if !defined(_newkey_)		n = EVEReset();	#endif#endif	KillPrams();		TestNumObjects();		DeleteMenu(1001);	DeleteMenu(WINDOW_MENU);	ReleaseResource((Handle)g_Apple_Menu);	DisposeMenu(gTheWindowMenu);		if(gShutdown)		ShutDwnPower();	#ifdef __powerc__		DisposHandle(gTheKeyHandle);	#endif	WatchRemove();	ExitToShell();AbortProc:	;								/* Dummy routine address */	StopWatch();	StopAlert(COPY_PROTECT + 1,NUL);		/* Display message */	goto QuitHere;	#ifdef NETWORK_VERSIONNetKeyErrorHandle: ;	theComBlock->ShowResponse(133);	if(theComBlock->theInfo->response == NOT_ALLOWED){		theComBlock->GetInfo();		theComBlock->ShowAllUsers();	}	goto QuitHere;#endifKeyErrors:	;	gCurrentObj	=	gDefault = (DiffractObject*)AllocDiffractObj(); // keeps cursor alive	switch(theResp){		case 100:			StopWatch();			StopAlert(COPY_PROTECT + 1,NUL);			WatchRemove();			gDefault->DoClose();			ExitToShell();			break;		case 101:			StopWatch();			ParamText("\pThe serial number of the key and the program do not match.","\p","\p","\p");			StopAlert(1506,NUL);			WatchRemove();			gDefault->DoClose();			ExitToShell();			break;		case 102:			StopWatch();			ParamText("\pThe key does not support this software version.","\p","\p","\p");			StopAlert(1506,NUL);			WatchRemove();			gDefault->DoClose();			ExitToShell();			break;		default:			gDefault->DoClose();			goto QuitHere;			break;	}	goto QuitHere;}long restartProc()			{#ifdef NETWORK_VERSION	theComBlock->BGRemove();	theComBlock->LogOff();#endif	StopWatch();	WatchRemove();	ExitToShell();	return(0L);}void DoInits(){		short 	i;	Handle theMenuBar;			for(i = 0 ; i <= 40 ; i++)		MoreMasters();		InitGraf(&qd.thePort);	InitFonts();	FlushEvents(everyEvent, 0);	InitWindows();	InitMenus();	TEInit();	InitDialogs(NUL);	InitCursor();	InitPalettes();	//InitBugHunt();	//	CheckMessages		();  Not presently used	gShutdown		= false;	gAppleEvtsOK	= false;	theMenuBar = GetNewMBar(1000);	//ClearMenuBar	();/* July 1992 */	SetMenuBar		(theMenuBar);	/*KillMBHandle*/DisposeHandle	(theMenuBar);	DrawMenuBar		();		gTheHandle 	= GetResource('ERIC',500);  // This was added back in	UseResFile		(HomeResFile(gTheHandle));  ReleaseResource(gTheHandle);    	g_Apple_Menu 		= GetMenu(1001);	gTheWindowMenu  = NewMenu (WINDOW_MENU, "\pWindows");	AddResMenu			(g_Apple_Menu,'DRVR'); 	g_Group_ID 			= 0;	TheFilterUPP 		= NewModalFilterProc((ProcPtr)TheFilter);	SmallFilterUPP 	= NewModalFilterProc((ProcPtr)SmallFilter);	MLogFilterUPP       = NewModalFilterProc((ProcPtr)MLogFilter);//ericnew}char* InitPrams(){		GrafPtr 	thePort;#if !defined(powerc) && !defined(__powerc)	MenuHandle	fileMenuHandle;	long		result;#endif		GetWMgrPort(&thePort);	InitDialogSetUpParams();	g_Routine				= "Desktop Microscopist";	g_PatchCount			= 0;	//g_ThreadObj			=	(ThreadsObj*)D_new(ThreadsObj);	//g_ThreadObj->InitThreads();	gTheFile				= (FileObj*)D_new(FileObj);	gTheFile->file_is_Open 	= false;	g_MenuNums				=	8000; /*dec 1992 One More Attempt to solve the menu problem*/	gWaitTime 				= 2;	gInBackground			= false;	gVBL_Flag				= true;	gSkip_Menu_Init			= false;	gTopWindow				= NUL;	gMouseRgn				= NewRgn();	gTheRgn					= NewRgn();	gUpdateAll				= NewRgn();	gScreenSize 			= thePort->portRect;	gNotificationFlag		= false;	g_New_Menu 					= GetMenu(10);	g_Crystal_Menu 			= GetMenu(11);	g_PPT_Menu					= GetMenu(13);	g_Crystal_Menu2 		= GetMenu(14);		g_Crystal_Face_Menu		= GetMenu(15);		g_el_Tech_Menu				= GetMenu(17);	g_xRay_Tech_Menu			= GetMenu(18);	g_Table_Menu					= GetMenu(20);	g_Elastic_Constant		= GetMenu(26);   /* Added Jim July */	g_Palette_Menu			= GetMenu(177);	g_theFontMenu 			= DM_GetMenu(FONT);/* July 1992 28 */	g_theStyleMenu 			= DM_GetMenu(STYLE);/* July 1992 29*/	g_theSizeMenu 			= DM_GetMenu(SIZE);/* July 1992 30*/		g_theJustifyMenu 		= DM_GetMenu(JUSTIFY);/* July 1992 31*/		g_Microstruc_Tech_Menu  = DM_GetMenu(32); /* Added by J.T. Nov 1991 */	g_theColorMenu 					= DM_GetMenu(COLOR_TEXT_MENU);/* feb 1993 33*/	g_Crystal_Menu3         = GetMenu(52);		g_Base_Crystal_Menu			= GetMenu(53);//	g_Spectra_Menu         	= DM_GetMenu(62);	g_Exp_Man_Menu					= GetMenu(149);	g_Exp_Lat_Menu					= GetMenu(140);	g_Exp_Vol_Meth_Menu			= GetMenu(139);	g_Exp_Line_Meth_Menu		= GetMenu(138);//	g_Graph_Select_Menu			= GetMenu(SELECT_SPECTRA);	g_Pole_Figure_Menu			=	GetMenu(153);	g_Hier_Pict_Mode		= GetMenu(HIER_PICT_MODE);//bloch	InsertResMenu					(g_theFontMenu,'FONT',0);		g_Group_ID      = 0;	g_DebyeWaller   = false;	g_StructureEV   = 0;	g_Beam_Type				= 1;	gCount					= 0;	g_Hex_Four				=	true; /* Added by Jim in October */	gTheSelection 			= (SelectRect*)D_new(SelectRect);		gTheSelection->DoInit((WindowPtr)NUL);			g_Window_Number = 1;	g_EVE_Read_Password = D_NewPtr(17 * sizeof(char));	SetRect		(&gTheRect,-32000,-32000,32000,32000);	RectRgn		(gUpdateAll,&gTheRect);	gPrintRecHandle	= (THPrint)GrabResource('PREC',1000,"\pPage Setup",sizeof(TPrint));	//PrOpen();	sprintf((char*)g_EVE_Read_Password,"OjTzhppFdwpozeTx");	theSearchObj = 0L;#if defined(powerc) || defined(__powerc)		InstallAppleEvents();		gAppleEvtsOK = true;#else	if(Gestalt(gestaltVersion,&result) == 0){		#ifdef code68881			 if(Gestalt(gestaltFPUType,&result) == 0){			if(result == gestaltNoFPU){				result = StopAlert(NO_FPU,NUL);				gQuitFlag = true;				return(gTheText);			}else			{				result = 333;			}		}		#endif		if(Gestalt(gestaltSystemVersion,&result) == 0){			if(result >= 0x00000700){				InstallAppleEvents();				gAppleEvtsOK = true;			} else {				fileMenuHandle = (MenuHandle)GetResource('MENU',10);				DisableItem (fileMenuHandle, 9);			}		}	} else {		StopWatch();		AlertUser(3);	}#endiftheSearchObj = (SearchObject*)D_new(SearchObject);		theSearchObj->Init();	return((char*)g_EVE_Read_Password);	}void	KillPrams(){	D_delete(gTheFile);	if(gTheSelection->selectPict != (PicHandle)NUL){/*dec 1992*/		KillPicture(gTheSelection->selectPict);		gTheSelection->selectPict = 0L;	}	//g_ThreadObj->DoClose();	D_delete(gTheSelection);	ReleaseResource((Handle)g_New_Menu);	ReleaseResource((Handle)g_Crystal_Menu);	ReleaseResource((Handle)g_Crystal_Menu2);//	ReleaseResource((Handle)g_Spectra_Menu);	ReleaseResource((Handle)g_Crystal_Menu3);	ReleaseResource((Handle)gPrintRecHandle);	//PrClose();	FlushEvents(everyEvent,0);	DisposeRgn(gMouseRgn);	DisposeRgn(gTheRgn);	DisposeRgn(gUpdateAll);	KillPtr(g_EVE_Read_Password);	ReleaseResource((Handle)g_PPT_Menu);	ReleaseResource((Handle)g_Crystal_Face_Menu);/*	VRemove((QElemPtr)&gTheVBLTask);   */	ReleaseResource((Handle)g_el_Tech_Menu);	ReleaseResource((Handle)g_xRay_Tech_Menu);	ReleaseResource((Handle)g_Table_Menu);	ReleaseResource((Handle)g_Elastic_Constant);/* added Jim July 1991 */	ReleaseResource((Handle)g_Palette_Menu);	ReleaseResource		((Handle)g_theFontMenu);/* July 1992 */	ReleaseResource		((Handle)g_theSizeMenu);/* July 1992 */	ReleaseResource		((Handle)g_theStyleMenu);/* July 1992 */	ReleaseResource		((Handle)g_theJustifyMenu);/* July 1992 */	ReleaseResource		((Handle)g_Microstruc_Tech_Menu);/* Nov 1992 */	ReleaseResource		((Handle)g_Base_Crystal_Menu);/*dec 1992*/	ReleaseResource		((Handle)g_Exp_Man_Menu);/*Aug 1995*/	ReleaseResource		((Handle)g_Exp_Lat_Menu);/*Aug 1995*/	ReleaseResource		((Handle)g_Exp_Vol_Meth_Menu);/*Aug 1995*/	ReleaseResource		((Handle)g_Exp_Line_Meth_Menu);/*Aug 1995*/	ReleaseResource		((Handle)g_Hier_Pict_Mode);//bloch	ReleaseResource		((Handle)g_theColorMenu);/* Feb 1993 */	//ReleaseResource		((Handle)g_Graph_Select_Menu);	ReleaseResource		((Handle)g_Pole_Figure_Menu);	if(theSearchObj)theSearchObj->Kill();	PrClose();	ReleaseResource((Handle)gPrintRecHandle);		D_HandleReport();	}#if defined(_newkey_)	void	SetSN(void)	{		unsigned short	**theRes,theResp,i;		unsigned long	**theRes2,sNum;		DialogPtr		theDialog;		Boolean			dQuit = false;		short			resFile,type,theSelect;		Rect			theRect;		KeyMap			keyArray;							theRes 		= (unsigned short**)GetResource('ERIC',500);		if(theRes == NUL || ResError() != 0){			ParamText("\pEric's Resource Error.","\p","\p","\p");			StopWatch();			StopAlert(1506,NUL);			WatchRemove();			ExitToShell();		}		theRes2 		= (unsigned long**)GetResource('ERIC',501);		if(theRes2 == NUL || ResError() != 0){			ReleaseResource((Handle)theRes);			ParamText("\pEric's Resource Error 2.","\p","\p","\p");			StopWatch();			StopAlert(1506,NUL);			WatchRemove();			ExitToShell();		}		GetKeys(keyArray);		if(keyArray[1] == 4 && (*theRes2)[0] == 0x1EEB687D){			theResp			=  RBEFINDFIRST(0x8802,&sNum,gTheKeyHandle);				theDialog = GetNewDialog(710,NUL,(WindowPtr)-1L);			sprintf			(gTheText,"%ld",sNum);			GetDItem		(theDialog,3,&type,&gTheHandle,&theRect);			c2pstr			(gTheText);			SetIText		(gTheHandle,pTheText);			SelIText 		(theDialog,3,0,32767);			while(!dQuit){				ModalDialog(NUL,&theSelect);				switch(theSelect){					case DLOG_ENTER_OR_CR:					case 1:						GetIText(gTheHandle,pTheText);						p2cstr(pTheText);						sNum = atol(gTheText);						dQuit = true;						break;					case 2:						dQuit = true;						break;					default:						break;				}			}			DisposeDialog(theDialog);				sNum 			^= 0x7F29D51A;			(*theRes2)[0] 	= 0x5e6a4c5d;			(*theRes2)[1] 	= sNum;			**theRes 		= 0;			resFile			= HomeResFile((Handle)theRes2);			ChangedResource((Handle)theRes2);			WriteResource((Handle)theRes2);			ReleaseResource((Handle)theRes2);			ChangedResource((Handle)theRes);			WriteResource((Handle)theRes);			ReleaseResource((Handle)theRes);			gTheHandle = GetResource('DATA',128);			if(gTheHandle != NUL && ResError() == 0){				if(HomeResFile(gTheHandle) == resFile){					RmveResource(gTheHandle);					DisposHandle(gTheHandle);				} else {					ReleaseResource(gTheHandle);				}			}			for(i = 721 ; i <= 725 ; i++){				gTheHandle = GetResource('DATA',i);				if(gTheHandle != NUL && ResError() == 0){					if(HomeResFile(gTheHandle) == resFile){						RmveResource(gTheHandle);						DisposHandle(gTheHandle);					} else {						ReleaseResource(gTheHandle);					}				}			}			UpdateResFile(resFile);		} else {			ReleaseResource((Handle)theRes2);			ReleaseResource((Handle)theRes);		}	}		Boolean			WrongSN(unsigned long sNum)	{		unsigned long	**theRes,theNum;				theRes 		= (unsigned long**)GetResource('ERIC',501);		if(theRes == NUL || ResError() != 0){			ParamText("\pEric's Resource Error2.","\p","\p","\p");			StopWatch();			StopAlert(1506,NUL);			WatchRemove();			ExitToShell();		}		theNum 	= (*theRes)[1];		ReleaseResource((Handle)theRes);		theNum	^= 0x7F29D51A;		return false;		// This cuts out the SN Check for online updates				if(theNum == sNum){			return false;		}		return true;	}#endif/*void	SetPrefFiles(void){short 			vRefNum = 1;	HFileInfo		myCPB; 	unsigned char	fName[255];	short			index=1;										OSErr			err;               							FInfo			aFilesInfo;		err = GetVol(0,&vRefNum);	myCPB.ioNamePtr = fName;        do    {		myCPB.ioFDirIndex 	= index;         									myCPB.ioDirID 		= theFSSpec.parID;  									myCPB.ioVRefNum 	= vRefNum;     									err 				= PBGetCatInfo((CInfoPBPtr)&myCPB,false);				if (err == noErr){          	if (((myCPB.ioFlAttrib>>4) & 0x01) == 1){	         		theFSSpec.parID = myCPB.ioDirID;          		sprintf(gTheText,"Preference");         		ptocstr(theFSSpec.name);         		if(strcmp(theFSSpec.name,gTheText){         			done = true;         		}         		HFSEnumerateCat(theFSSpec,done);  				err = 0;  											} else { 				BlockMove((Ptr)&(myCPB.ioFlFndrInfo),(Ptr)&aFilesInfo,sizeof(FInfo));				if(aFilesInfo.fdType ==  'pref' && aFilesInfo.fdCreator == OWNER){                 	gTheFile->fileError = HOpen(myCPB.ioVRefNum,theFSSpec.parID,(unsigned char*)fName,(SignedByte)fsRdPerm,&gTheFile->pathRefNum);                  	goto FOUNDIT;				}			}        	index += 1;     											        } 															    } while (err == noErr);    sprintf(gTheText,"Preference D.M.");    ctopstr(gTheText);    iErr = Create(pTheText,vRefNum,OWNER,'pref');    return;	FOUNDIT:			}*/