//Table Sources:TA_DSpaceTable.c#include	"Diffract_INCs.h"#include 	"AtomData.h"#include	"a_D_Space.h"#include	"SF_MathLib.h"#include 	"JimsLib.h"void		D_Spacing_Table::DoInit(void){	inherited::DoInit(); 	data_Size			= sizeof(SpotInfo);	SetObjectWindowTitle("DSpace Table",200,266);	displayDspace = 1;	crystalNum2 = 5;	firstPlane = (Index*)D_new(Index);	firstPlane->Init(false,theCrystal[0]);	firstPlane->h = 3;	firstPlane->k = 3;	firstPlane->l = 3;	dspaceLow 	= 1.3;	minSF		= 0.1;	theListRect = ((GrafPtr)theWindow)->portRect;	theListRect.top += 50;	theListRect.left = 5;	theListRect.right -= 18;	theListRect.bottom -= 5;	numColumns = 3;			theCrystalButton = (CrystalButton*)D_new(CrystalButton);	theCrystalButton->DoInit();	theCrystalButton->Enable();		/*KillMBHandle*/DisposeHandle(theMenuBar);	theMenuBar = GetMenuBar();	DrawMenuBar();	objectType = D_SPACE_TABLE; /*New 9/11/92 */	if(gTheFile->file_is_Open){		return;	}		DoDefine();		return;}void D_Spacing_Table::SetObjectMenu(void){	theMenuBar = GetNewMBar(TABLE_MB);	ClearMenuBar();/* July 1992 */	SetMenuBar(theMenuBar);}void		D_Spacing_Table::DoClose(void){	firstPlane->DoClose();	(theCrystalButton)->DoClose();	inherited::DoClose();	return;}Boolean		D_Spacing_Table::DoContent(Point thePoint){	PenState theState;	GetPenState(&theState);	PenNormal();	if((theCrystalButton)->DoContent(thePoint)){		return true;		}	SetPenState(&theState);		DMForeColor(10 + crystalNum);	DMBackColor(BACKGROUND_COLOR);	return(inherited::DoContent(thePoint));	}void			D_Spacing_Table::DoIdle(void){		inherited::DoIdle();	return;}#define DEFINE_TABLE 500void		D_Spacing_Table::DoMenu(long	theResult){	short	theMenu,theItem;		theMenu = HiWord(theResult);	theItem = LoWord(theResult);		switch(theMenu){		case EDIT_MENU:			switch(theItem){				case CUT:				case COPY:				case PASTE:				case DO_CLEAR:					return;					break;				default:					break;			}			break;		case DEFINE_TABLE:			switch(theItem){				case 1:					//DoDefine();					DoDefineSetUp();					break;				case 3:					qsort(*theDataHandle,(long)(data_Count + 1),sizeof(SpotInfo),(_compare_function/*__cmp_func_Cmpfun**/)DspaceCompare);					sortMethod = 1;					DisplayList();					break;				case 4:					qsort(*theDataHandle,(long)(data_Count + 1),sizeof(SpotInfo),(_compare_function/*__cmp_func_Cmpfun**/)JimsStructFactCompare);					sortMethod = 2;					DisplayList();					break;				case 5:					/*MFTemp*/D_HLock(theDataHandle);					qsort(*theDataHandle,(long)(data_Count + 1),sizeof(SpotInfo),(_compare_function/*__cmp_func_Cmpfun**/)JimsStructFactCompare);					/*MFTemp*/D_HUnlock(theDataHandle);					sortMethod = 3;					DisplayList();					break;				case 7:					displayDspace = 1;					DisplayList();					break;				case 8:					displayDspace = 2;					DisplayList();					break;				case 9:					displayDspace = 3;					DisplayList();					break;				case 10:					displayDspace = 4;					DisplayList();					break;				default:					break;			}								break;		default:			break;	}	inherited::DoMenu(theResult);	return;}#define D_SPACE_DIALOG 500void D_Spacing_Table::DrawTheText(void){	short top,bottom;	char  theText[255];	inherited::DrawTheText();		bottom 	= theCrystalButton->theButtonRect.bottom;	top		= theCrystalButton->theButtonRect.top + 1;		theCrystalButton->DrawButtonRect(crystalNum + 10);	MoveTo(theListRect.left +12 ,theListRect.top - 10);	if(sortMethod == 3){			sprintf(theText," E.D. (Å)");		} else {			switch(g_StructureEV){				case 0:					sprintf(theText,"  S.F. Å");				break;				case 1:					sprintf(theText,"   Vg eV");				break;				case 2:					sprintf(theText,"   Ug Å-2");				break;			}	}		switch(displayDspace){		case 1:			sprintf(gTheText," HKL  dspace (Å)");		break;		case 2:			sprintf(gTheText," HKL  r.d. (Å-1)");		break;		case 3:			sprintf(gTheText," HKL  g-vector (mm)");		break;		case 4:			sprintf(gTheText," HKL  2Theta (°)");		break;	}	strcat(gTheText,theText);	DMForeColor(BLACK);	DrawString(c2pstr(gTheText));}void		D_Spacing_Table::MyCalculate(void){		short			h,k,l,i,maxRec;	SpotInfo 		*dspaces;	if(dspaceLow < .1)dspaceLow = .1;	h = SizeofReciprocalLattice(1.,0.,0.,1./dspaceLow,theCrystal[crystalNum]);	k = SizeofReciprocalLattice(0,1.,0.,1./dspaceLow,theCrystal[crystalNum]);	l = SizeofReciprocalLattice(0,0.,1.,1./dspaceLow,theCrystal[crystalNum]);	if(theDataHandle != 0L)		/*Temp*/KillHandle(&theDataHandle);		theDataHandle = SubCalcDSpacings(theCrystal[crystalNum],h,k,l,theBeamFlag,(double)minSF);	if(theDataHandle == 0L || gCount <= 0){		return;	}	data_Count = gCount + 1;	gCount = data_Count - 1;	dspaces = (SpotInfoPtr)(*theDataHandle);	i = 0;	while(i < data_Count && dspaces[i].x > dspaceLow )i++;		data_Count = i;		maxRec = 32700 / 25;		if(data_Count >= maxRec){		data_Count = maxRec;	}		/*MFTemp*/D_HLock(theDataHandle);			if(sortMethod >= 2){		qsort(*theDataHandle,(long)(data_Count),sizeof(SpotInfo),(_compare_function/*__cmp_func_Cmpfun**/)JimsStructFactCompare);	}		/*MFTemp*/D_HUnlock((Handle)theDataHandle);			if(data_Length >  data_Count){		D_RecoverMemory		(theDataHandle,data_Size,(long)data_Count);	}	data_Length 	= 	data_Count;			gNoBreak = true;				/* allow list to be drawn  */	if(data_Count >= maxRec){		WarnUser(2);	}	return;}void		D_Spacing_Table::DisplayList(void){	SpotInfoPtr  dspace;	double RofEwaldSphere;	short length,i;	Cell	theCell;	double electronMassRation;	dcomplex sF;		LDoDraw(false,theList);	TextFont(0);	TextSize(0); 	DMForeColor(10 + crystalNum);	DMBackColor(BACKGROUND_COLOR);	theCell.v = -1;	theCell.h = 0;	/*MFTemp*/D_HLock(theDataHandle);	dspace = (SpotInfoPtr)(*theDataHandle);	PenNormal();	RofEwaldSphere = 1. / wavelength;	firstPlane->Init(false,theCrystal[crystalNum]);	electronMassRation = 1. + ( (double)energy / 511.);	TextFont(1124);	TextSize(9);		for(i = 0; i < data_Count && gNoBreak;i++)	{		AllowBackground();		firstPlane->CopyPtrToIndex((Ptr)&(dspace[i]));		firstPlane->direction = false;		theCell.v = i;		theCell.h = 0;				firstPlane->SetListIndecies(theList,theCell);		switch(displayDspace)		{			case 1:				length = sprintf(gTheText,"%6.4f",dspace[i].x);				break;			case 2:				length = sprintf(gTheText,"%6.4f",1./dspace[i].x);				break;			case 3:				length = sprintf(gTheText,"%6.2f",cameraConstant/dspace[i].x);				break;			case 4:				length = sprintf(gTheText,"%6.4f",(360 / PI) * asin(wavelength/(2 * dspace[i].x)));				break;		}				theCell.h = 1;		LSetCell(gTheText,length,theCell,theList);				if(sortMethod == 3)		{				firstPlane->CopyPtrToIndex((Ptr)&(dspace[i]));	/*New 9/10/92*/	length = sprintf(gTheText,"%5.1f",firstPlane->TheExtinctionDist(RofEwaldSphere,electronMassRation,theBeamFlag));				theCell.h = 2;				LSetCell(gTheText,length,theCell,theList);		}else{			sF = dspace[i].sF;			sF = ConvertStructureFactor(sF,g_StructureEV,dspace[i].theCrystal->volume);						length = sprintf(gTheText,"%6.2f",Cabs(sF));			theCell.h = 2;			LSetCell(gTheText,length,theCell,theList);		}	}	LDoDraw(true,theList);	/*MFTemp*/D_HUnlock(theDataHandle);	DMForeColor(10 + crystalNum);	DMBackColor(BACKGROUND_COLOR);	LUpdate(theWindow->visRgn,theList); //	TextFont(0);//	TextSize(0);	newPictReq = true;	return;}void		D_Spacing_Table::DoPrint(void){	inherited::DoPrint();	DisplayList();	return;}void			D_Spacing_Table::DoKey(char	theChar){		inherited::DoKey(theChar);	return;}void			D_Spacing_Table::DoRefresh(void){	inherited::DoRefresh();		return;}void	D_Spacing_Table::DoHeaderPrint(Rect *topRect){	char theText[255];	sprintf(tabelTitle,"D-Space Table");	c2pstr(tabelTitle);	if(sortMethod == 3){			sprintf(theText," Ex.Dist. (Å)");		} else {			switch(g_StructureEV){				case 0:					sprintf(theText,"  S.F. Å");					break;				case 1:					sprintf(theText,"   Vg eV");				break;				case 2:					sprintf(theText,"   Ug Å-2");				break;			}	}			switch(displayDspace)	{		case 1:						sprintf(dataLabel,"    HKL   d-space (Å)");			break;		case 2:			sprintf(dataLabel,"    HKL  rcp.d-spc(Å-1)");						break;		case 3:				sprintf(dataLabel,"    HKL   g-vec.(mm)");					break;		case 4:			sprintf(dataLabel,"    HKL   2Theta (°)");			break;	}	strcat(dataLabel,theText);	c2pstr(dataLabel);	inherited::DoHeaderPrint(topRect);}void	D_Spacing_Table::DoDblClick(Point thePoint){	theCrystalButton->DoDblClick(thePoint);	return;}void	D_Spacing_Table::DoAuxWrite(void){	firstPlane->WriteIndex();	gTheFile->WriteShort(displayDspace);	gTheFile->WriteFloat(dspaceLow);	inherited::DoAuxWrite();	return;}void	D_Spacing_Table::DoAuxRead(void){	firstPlane->ReadIndex(theCrystal);	displayDspace	= gTheFile->ReadShort();	dspaceLow		= gTheFile->ReadFloat();		inherited::DoAuxRead();	return;}void D_Spacing_Table::SetButton(void){	Rect	theRect;	short 		width;			width = StringWidth("\pCrystal 1");	(theCrystalButton)->SetOwner((Ptr)theCrystal[crystalNum]);	SetRect(&theRect,6,6,width + 11,20);	sprintf(gTheText,"Crystal %d",crystalNum + 1);	theCrystalButton->SetButtonRect(theRect);	theCrystalButton->SetName(gTheText);		}void D_Spacing_Table::RationalizeData(void){		SpotInfoPtr	thePlane;	short i;			thePlane	= (SpotInfoPtr)(*theDataHandle);	/* reconnect crystals */	for(i = 0 ; i < data_Count ; i++, thePlane++){		thePlane->theCrystal = theCrystal[crystalNum];	}	}