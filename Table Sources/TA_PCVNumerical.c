#include	"Diffract_INCs.h"//ects:D.M. v2.0:Sources.Jim:Table Sources:TA_PCVNumerical.c#include	"PCVNumerical.h"enum{	CALCULATE  = 1,	QUITPCV,	DSPACE1,	DSPACE2,		ANGLE,	ACCELVOLT,	CAMCON_DSPACE, /* 7 */	CAMCON_PERIOD,			INPUTTEXT,	ZONEAXIS,	ORDER,	PERIODICITY,	INPUTACTION,	LISTRECT,		SCROLLRECT,/* 15*/	LENGTHBUTTON0, 		COMMENT,	DSPTOGVECTOR, /* 18 */	LENGTHBUTTON1,	COMMENT1,	POPUPMENU,	CALC__RADIUS	};#define	DLOG_PCVNUM 302#define ENTERCLICK -20#define CANCELCLICK -1void	PCVNumerical::Init(float wavelengthA,float cameraConstantA,short rCrystal){	double re;	short i;	refCrystal = rCrystal;			theVoltage = wavelengthA;	re = (1000. * theVoltage);			wavelength =  12.26 / (sqrt(re) * sqrt((1. + (0.0009788 * theVoltage))));	dspace1 = 1.0;	dspace2 = 1.0;	angle = 90;	cam_Con_GVect = cam_Con_Period = cameraConstantA;	buttonFlag = true;	dspaceFlag = true;	buttonFlag1 = true;	for(i = 0; i <= 9; i++){		theVolumes[i].diameter = 0;		theVolumes[i].laueZone = i + 1;		theVolumes[i].volume = 0;		theVolumes[i].periodicity = 0;			}}void PCVNumerical::DoDefine(void){	short 			i,item,type,n = 0;	Handle 			theHandle;	pascal Boolean 	TheFilter();	Rect			theRect;	double			conversion,theValue,re;	PopUpMenu  		*thePopMenu;/*dec 1992 this changes many things*/	long 			theResult;	theDialog = DM_GetNewDialog(DLOG_PCVNUM, 0L,(WindowPtr)-1L);	for(i = DSPACE1; i <= CAMCON_PERIOD;i++){		switch(i)		{			case DSPACE1:				sprintf(gTheText,"%5.3f",dspace1);				break;			case DSPACE2:				sprintf(gTheText,"%5.3f",dspace2);				break;			case ANGLE:				sprintf(gTheText,"%5.3f",angle);				break;			case ACCELVOLT:				sprintf(gTheText,"%5.3f",theVoltage);				break;			case CAMCON_PERIOD:				sprintf(gTheText,"%5.3f",cam_Con_Period);				break;			case CAMCON_DSPACE:				sprintf(gTheText,"%5.3f",cam_Con_GVect);				break;		}		GetDItem(theDialog,i,&type,&theHandle,&theRect);		SetIText(theHandle,c2pstr(gTheText));	}	InitList();	WriteList();		sprintf(gTheText,"1");	GetDItem(theDialog,INPUTTEXT,&type,&theHandle,&theRect);	SetIText(theHandle,c2pstr(gTheText));	thePopMenu 	= 	(PopUpMenu*)D_new(PopUpMenu);	thePopMenu	->	Init(theDialog,POPUPMENU,52,refCrystal + 1);		gTheCell.h = 0;	gTheCell.v = 0;	DoCalculate();	while(1 != 2){		SystemTask();		ModalDialog(TheFilterUPP,&item);		switch(item){			case ML_UPDATE_EVT:				BeginUpdate(theDialog);			UpdtDialog(theDialog,theDialog->visRgn);			if(!gAppleEvtsOK){				HiliteOK(theDialog);			}			EndUpdate(theDialog);			break;			case CALCULATE:				DoCalculate(); 				WriteList();				break;			case QUITPCV:			case CANCELCLICK: 				if(theList != 0L)					LDispose(theList);				thePopMenu->DoClose();				DM_DisposDialog(&(this->theDialog));							return;				case ENTERCLICK:			case INPUTACTION:				GetDItem(theDialog,INPUTTEXT,&type,&theHandle,&theRect);				GetIText(theHandle,pTheText);				if(gTheCell.h == 0){					theVolumes[gTheCell.v].laueZone = atoi(p2cstr(pTheText));				}else{					if(gTheCell.h == 1) theVolumes[gTheCell.v].diameter = atof(p2cstr(pTheText));				}				if(gTheCell.h <= 1){					c2pstr(gTheText);					LSetCell(&(gTheText[1]),(short)(gTheText[0]),gTheCell,theList);				}				LSetSelect(false,gTheCell,theList);				if(gTheCell.h >= 1){					gTheCell.h = 0;					gTheCell.v++;					if(gTheCell.v > 9)						gTheCell.v = 0;				}else{					gTheCell.h = 1;				}				LSetSelect(true,gTheCell,theList);				if(gTheCell.h == 1){					sprintf(gTheText,"%6.3f",theVolumes[gTheCell.v].diameter);				}				if(gTheCell.h == 0){					sprintf(gTheText,"%d",theVolumes[gTheCell.v].laueZone);				}				GetDItem(theDialog,INPUTTEXT,&type,&theHandle,&theRect);				SetIText(theHandle,c2pstr(gTheText));				SelIText(theDialog,INPUTTEXT,0,32767);				break;						case LENGTHBUTTON0:				GetDItem	(theDialog,CAMCON_PERIOD,&gType,&gTheHandle,&gTheRect);				GetIText	(gTheHandle,pTheText);				theValue 	= 	atof((p2cstr(pTheText)));				GetDItem		(theDialog,ACCELVOLT,&gType,&gTheHandle,&gTheRect);				GetIText		(gTheHandle,pTheText);				theVoltage 	= 	atof((p2cstr(pTheText)));				re 			= 	(1000. * theVoltage);						wavelength 	=  	12.26 / (sqrt(re) * sqrt((1. + (0.0009788 * theVoltage))));				if(buttonFlag){					GetDItem(theDialog,LENGTHBUTTON0,&gType,&gTheHandle,&gTheRect);					sprintf(gTheText,"Camera Length");					SetCTitle((ControlHandle)gTheHandle,c2pstr(gTheText));					GetDItem(theDialog,COMMENT,&gType,&gTheHandle,&gTheRect);					sprintf(gTheText,"mm");					SetIText(gTheHandle,c2pstr(gTheText));					if(fabs(wavelength) > 0.0)					conversion = theValue / (wavelength);					buttonFlag = false;				}else{					GetDItem(theDialog,LENGTHBUTTON0,&gType,&gTheHandle,&gTheRect);					sprintf(gTheText,"Camera Constant");					SetCTitle((ControlHandle)gTheHandle,c2pstr(gTheText));					GetDItem(theDialog,COMMENT,&gType,&gTheHandle,&gTheRect);					sprintf(gTheText,"mm-");					SetIText(gTheHandle,c2pstr(gTheText));					conversion = theValue * (wavelength);					buttonFlag = true;				}				GetDItem(theDialog,CAMCON_PERIOD,&gType,&gTheHandle,&gTheRect);				sprintf(gTheText,"%6.4f",conversion);				SetIText(gTheHandle,c2pstr(gTheText));				SelIText(theDialog,CAMCON_PERIOD,0,32767);				break;			case DSPTOGVECTOR:				if(dspaceFlag){					GetDItem(theDialog,DSPTOGVECTOR,&gType,&gTheHandle,&gTheRect);					sprintf(gTheText,"in mm");					SetCTitle((ControlHandle)gTheHandle,c2pstr(gTheText));					dspaceFlag = false;				}else{					GetDItem(theDialog,DSPTOGVECTOR,&gType,&gTheHandle,&gTheRect);					sprintf(gTheText,"in ");					SetCTitle((ControlHandle)gTheHandle,c2pstr(gTheText));					dspaceFlag = true;				}				break;			case LISTRECT:				HandleListRect();				GetDItem(theDialog,INPUTTEXT,&type,&theHandle,&theRect);				if(gTheCell.h == 0)					sprintf(gTheText,"%d",theVolumes[gTheCell.v].laueZone);				else{					sprintf(gTheText,"%5.3f",theVolumes[gTheCell.v].diameter);				}				SetIText(theHandle,c2pstr(gTheText));				SelIText(theDialog,INPUTTEXT,0,32767);				break;			case SCROLLRECT:				GlobalToLocal(&(gTheEvent.where));				LClick(gTheEvent.where,gTheEvent.modifiers,theList);				break;			case LENGTHBUTTON1:				GetDItem(theDialog,CAMCON_DSPACE,&gType,&gTheHandle,&gTheRect);				GetIText(gTheHandle,pTheText);				theValue = atof((p2cstr(pTheText)));				GetDItem(theDialog,ACCELVOLT,&gType,&gTheHandle,&gTheRect);				GetIText(gTheHandle,pTheText);				theVoltage = atof((p2cstr(pTheText)));				re = (1000. * theVoltage);						wavelength =  12.26 / (sqrt(re) * sqrt((1. + (0.0009788 * theVoltage))));				if(buttonFlag1){					GetDItem(theDialog,LENGTHBUTTON1,&gType,&gTheHandle,&gTheRect);					sprintf(gTheText,"Camera Length");					SetCTitle((ControlHandle)gTheHandle,c2pstr(gTheText));					GetDItem(theDialog,COMMENT1,&gType,&gTheHandle,&gTheRect);					sprintf(gTheText,"mm");					SetIText(gTheHandle,c2pstr(gTheText));					if(fabs(wavelength) > 0.0)					conversion = theValue / (wavelength);					buttonFlag1 = false;				}else{					GetDItem(theDialog,LENGTHBUTTON1,&gType,&gTheHandle,&gTheRect);					sprintf(gTheText,"Camera Constant");					SetCTitle((ControlHandle)gTheHandle,c2pstr(gTheText));					GetDItem(theDialog,COMMENT1,&gType,&gTheHandle,&gTheRect);					sprintf(gTheText,"mm-");					SetIText(gTheHandle,c2pstr(gTheText));					conversion = theValue * (wavelength);					buttonFlag1 = true;				}				GetDItem(theDialog,CAMCON_DSPACE,&gType,&gTheHandle,&gTheRect);				sprintf(gTheText,"%6.4f",conversion);				SetIText(gTheHandle,c2pstr(gTheText));				SelIText(theDialog,CAMCON_DSPACE,0,32767);				break;			case POPUPMENU:				theResult = thePopMenu->DoPopUp();				if(LoWord(theResult))					refCrystal = LoWord(theResult) - 1;				break;			default:				break;		}	}}void PCVNumerical::DoCalculate(){	double area;	short 			i,type,n = 0,order;	Handle 	theHandle;	Rect			theRect;	Index			*theIndex,*theZoneAxis;	Crystal			*theCrystal;	double			calcPeriodicity,angle;	double			dspace1A,dspace2A,dspacing1,dspacing2,					cameraLength,cameraLength1,theValue,re;											theCrystal 	= 	gCurrentObj->theCrystal[refCrystal];	theIndex	= 	(Index*)D_new(Index);;	theZoneAxis	= 	(Index*)D_new(Index);;	theIndex	->	DoInit(false,theCrystal);	theZoneAxis	->	DoInit(true,theCrystal);		for(i = DSPACE1; i <= CAMCON_PERIOD;i++){		GetDItem(theDialog,i,&type,&theHandle,&theRect);		GetIText(theHandle,pTheText);		theValue = atof(p2cstr(pTheText));		switch(i)		{			case DSPACE1:				dspace1 = theValue;				break;			case DSPACE2:				dspace2 = theValue;				break;			case ANGLE:				angle = theValue;				break;			case CAMCON_PERIOD:				if(!buttonFlag){					cameraLength = theValue;					cam_Con_Period = cameraLength * wavelength;				}else{					cam_Con_Period = theValue;					if(fabs(wavelength) > 0.0)					cameraLength = theValue / wavelength;				}				break;			case ACCELVOLT:				theVoltage = theValue;				re = (1000. * theVoltage);						wavelength =  12.26 / (sqrt(re) * sqrt((1. + (0.0009788 * theVoltage))));				break;			case CAMCON_DSPACE:				if(!buttonFlag1){					cameraLength1 = theValue;					cam_Con_GVect = cameraLength * wavelength;				}else{					cam_Con_GVect = theValue;					if(fabs(wavelength) > 0.0)					cameraLength1 = theValue / wavelength;				}				break;		}	}	GetDItem(theDialog,ORDER,&type,&theHandle,&theRect);	GetIText(theHandle,pTheText);	order = atof(p2cstr(pTheText));	dspacing1 = dspace1;	dspacing2 = dspace2;	if(!dspaceFlag){		dspace1A = cam_Con_GVect / dspacing1;		dspace2A = cam_Con_GVect / dspacing2;		dspacing1 = dspace1A;		dspacing2 = dspace2A;	}	area = dspacing1 * dspacing2 / sin(angle * PI / 180);	theZoneAxis->GetIndex(theDialog,ZONEAXIS);	theZoneAxis->reduceFlag = false;	theZoneAxis->SetIndex(theDialog,ZONEAXIS);	GetDItem		(theDialog,PERIODICITY,&type,&theHandle,&theRect);	sprintf			(gTheText,"%5.3f",theZoneAxis->Periodicity( order,cameraLength,wavelength,&calcPeriodicity));	SetIText		(theHandle,c2pstr(gTheText));		GetDItem		(theDialog,CALC__RADIUS,&type,&theHandle,&theRect);	sprintf			(gTheText,"%5.3f",calcPeriodicity);	SetIText		(theHandle,c2pstr(gTheText));NOTFOUND:		for(i = 0; i <= 9; i++){		if(theVolumes[i].laueZone == 0 || cameraLength == 0 || theVolumes[i].diameter == 0.0)			theVolumes[i].periodicity = 0.0;		else			theVolumes[i].periodicity = theVolumes[i].laueZone * wavelength										/ (1 - cos(atan(theVolumes[i].diameter / (2.0 * cameraLength))));			if(area > 0.0 && theVolumes[i].periodicity > 0.0)			theVolumes[i].volume = theVolumes[i].periodicity * area;		else			theVolumes[i].volume = 0.0;	}	theIndex->DoClose();	theZoneAxis->DoClose();}void	PCVNumerical::InitList(void){	FontInfo 	theFont;	short		textHeight;	Point		cellSize;	Handle theHandle;	Rect theRect,rBounds,aRect;	short	type;			GetDItem	(theDialog,LISTRECT,&type,&theHandle,&theRect);		SetRect		(&aRect,theRect.left - 2,theRect.top - 2,theRect.right + 2,theRect.bottom + 2);	dm_EraseRect	(&theRect);	dm_FrameRect	(&aRect);	GetFontInfo	(&theFont);	textHeight 	= 	theFont.ascent + theFont.descent + theFont.leading;	SetRect		(&rBounds,0,0,4,10);	cellSize.h 	= 	60;	cellSize.v 	= 	textHeight;	theList 	= 	LNew(&theRect,&rBounds,cellSize,0,theDialog,true,false,false,true);	(*theList)	->	selFlags = 0x80;	PenSize			(1,1);	dm_FrameRect		(&aRect);	PenNormal		();	return;}void	PCVNumerical::WriteList(void){	short i,k;	float theValue;	Cell theCell;	theCell.h = 0;	for(i = 0 ; i <= 9 ; i++){		theCell.v = i;		for(k = 0;k <= 3;k++){			theCell.h = k;			switch(k){				case 0:					theValue = theVolumes[i].laueZone;				break;				case 1:					theValue = theVolumes[i].diameter;				break;								case 2:					theValue = theVolumes[i].periodicity;				break;								case 3:					theValue = theVolumes[i].volume;				break;			}			if(k > 0){ 				if(k < 3)					sprintf(gTheText,"%8.3f",theValue);				else					sprintf(gTheText,"%8.0f",theValue);			}else	sprintf(gTheText,"%d",(short)theValue);					c2pstr(gTheText);			LSetCell(&(gTheText[1]),(short)(gTheText[0]),theCell,theList);		}	}	return;}void PCVNumerical::HandleListRect(void){	Point thePoint;	Cell theCell;	short i,k;	Rect theRect;	Boolean flag;	GlobalToLocal(&(gTheEvent.where));	SetPort(theDialog);	flag = LClick(gTheEvent.where,gTheEvent.modifiers,theList);	GetMouse(&thePoint);	SetRect(&theRect,-5,-5,-5,-5);	for(i = 0;i <= 9;i++){		theCell.v = i;		for(k = 0; k <= 3; k++){			theCell.h = k;			LRect(&theRect,theCell,theList);			if(PtInRect(thePoint,&theRect)){				gTheCell.v = theCell.v;				gTheCell.h = theCell.h;			}		}	}	if(gTheCell.h > 1){		LSetSelect(false,gTheCell,theList);		gTheCell.h = 1;		LSetSelect(true,gTheCell,theList);	}}void PCVNumerical::Kill(void){	D_delete(this);}