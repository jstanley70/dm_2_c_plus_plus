#include	"Diffract_INCs.h"#include	"Dir_Paths.h"short	SortListCrysByDecValue(ListParameters* spot1,ListParameters* spot2);void	SearchObject::StripAllFiles(void){	short 		type,i;	Handle 		theHandle;	Rect 		theRect;	ListCrystal	*lastFoundCrystal;	ListParameters *start,*oldStart;	double		theValue;	short		blockNums = 0,startBlock;	startBlock 	= 	GetItemValue		(theDialogSearch,FOM);	for(blockNums = startBlock; blockNums <= 3000;blockNums++){		totalFound 		= 	0;				GetDItem			(theDialogSearch,TOTALMATCH,&type,&theHandle,&theRect);		sprintf				(gTheText,"%d",totalFound); 		SetIText			(theHandle,c2pstr(gTheText));		theValue = blockNums;		SetItemValue		(theDialogSearch,FOM,theValue,0);				noOfDspace 		= 	-1;							qsort				(dspacings,(long)(10),sizeof(float),(_compare_function/*__cmp_func_Cmpfun**/)FloatCompare);		foundCrystals->FillMenuFrom(theCRYSMenu->theMenu,1);						foundCrystals	->	DoCloseAll();											StripFiles(blockNums);				FlushEvents(everyEvent,0);		if(totalFound == 0)return;		lastFoundCrystal = foundCrystals;				while(lastFoundCrystal != 0L){			if(lastFoundCrystal->dataBase == 1){				GetJPDSSearchCrystal(lastFoundCrystal->refNo1,lastFoundCrystal->refNo2);				lastFoundCrystal->CopyDMCrystal(testCrystal);				if(searchTypePopUp->lastResult >= VOL_SEARCH_D)	               	lastFoundCrystal->FOM = TestCrystalFOM(dspacings);			}			lastFoundCrystal = lastFoundCrystal->next;		}		oldStart = start = (ListParameters*)D_NewPtr(sizeof(ListParameters) * (totalFound + 2));		{						short n,j;						n = 0;		    foundCrystals->FillListVol(start, &n);			qsort(&start[1],n,sizeof(ListParameters),(_compare_function/*__cmp_func_Cmpfun**/)SortListCrysByDecValue);			foundCrystals->FillSortedList(start,j = 0,n);			j = -1;			for(i = 0; i < MAXEXPDSPACE; i++){				if(dspacings[i] > .78){					j++;				}			}			if(searchTypePopUp->lastResult <= TWO_THETA_SEARCH && j >= 2){				n = 0;			    foundCrystals->FillListFOM(start, &n);				qsort(&start[1],n,sizeof(ListParameters),(_compare_function/*__cmp_func_Cmpfun**/)SortListCrysByDecValue);				foundCrystals->FillSortedList(start,j = 0,n);			}			start++;			for(i = 0; i < n;i++,start++)			{				lastFoundCrystal = (ListCrystal*)start->address;				lastFoundCrystal->AppendItemsToMenu(theCRYSMenu->theMenu);			}					}		KillPtr((Ptr)oldStart);		EliminateRedundancies();		SaveStrippedCrystals();		if(Quit()){			totalFound--;			return;		}	}}void SearchObject::SaveStrippedCrystals(void){	short k,l; 	l 	= 	theCRYSMenu->P_CountMItems();	for(k = 1; k <= l;k++){		GetStrippedCryslal(k);	}}void SearchObject::GetStrippedCryslal(short theCrystalNo){	short theNumber;	//ListCrystal *hitCrystal;	long place1 = 0, place2 = 0;	theNumber = 0;	//hitCrystal = foundCrystals->GetCrystal(theCrystalNo,&theNumber);	DoNewCrystalList	(theCrystalNo,&place1,&place2,0);			//GetJPDSSearchCrystal	(hitCrystal->refNo1,hitCrystal->refNo2);	CreateNewFile();	return ;	}void SearchObject::CreateNewFile(void){	static char theText[255];	static long crystNum = 0;	char	aText[255],bText[255];	short		l,i;		testCrystal->GetSvals();	testCrystal->CellVolume();	//testCrystal->SetDSpace();	testCrystal->DetermineCrystalFaces();	testCrystal->DetermineVertices();	testCrystal->DetermineEdges();	testCrystal->ElasticConstantSymmetry();	l = strlen(testCrystal->formulaText);	if(!strncmp(theText,testCrystal->formulaText,20) || l < 2){		sprintf(bText,"_%d",crystNum);		l = strlen(bText);		strncpy(aText,testCrystal->formulaText,20 - l);		strcat(aText,bText);		crystNum++;	}else{		strncpy(aText,testCrystal->formulaText,20);	}	strcpy(theText,testCrystal->formulaText);		for(i = 0 ; i <= testCrystal->lastUserDef ; i++){		testCrystal->theUserAtoms[i]->DoClose();	}		testCrystal->lastUserDef = -1;		if(!gTheFile->CreateNewFile(CRYST_OBJ,aText))return;	strcpy(theText,testCrystal->formulaText);	if(!gTheFile->file_is_Open)		return; 	//testCrystal->FileWriteOldDesktop();	testCrystal->FileWriteCrystal();	gTheFile->DoFileClose();}void SearchObject::StripFiles(short blockNums){	short k;	short type;	Rect	theRect;	Handle theHandle;		for(k = 0; k <= 17;k++){		ListCrystal *lastCrystal;		totalFound++;		GetDItem(theDialogSearch,TOTALMATCH,&type,&theHandle,&theRect);		sprintf(gTheText,"%d",totalFound); 		SetIText(theHandle,c2pstr(gTheText));	    lastCrystal = foundCrystals->DoAdd(testCrystal,1,(long)blockNums,(long)k);		lastCrystal->FOM = 100;	}	return;}short	SortListCrysByDecValue(ListParameters* spot1,ListParameters* spot2){	short z1,z2;		z2 = (short)fabs((double)spot1->value);	z1 = (short)fabs((double)spot2->value);		return((short)((z1 < z2) ? -1 : ((z1 == z2) ? 0 : 1)));}