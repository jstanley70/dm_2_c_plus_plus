#include	"Diffract_INCs.h"#include	"Dir_Paths.h"Boolean bigScreenFlag;short	SortListCrysByIncreasingValue(ListParameters* spot1,ListParameters* spot2);short	SortListCrysByDecreasingValue(ListParameters* spot1,ListParameters* spot2);void	CrystalDisplay(DialogPtr theDialog,Crystal* theCrystal);#include 	"JimsLib.h"void  SearchObject::Init(void){	short i;		inherited::Init();		comparisonCrystal	=	(Crystal*)AllocCrystal(0);	testCrystal 		= 	(Crystal*)AllocCrystal(0);		foundCrystals 		=	(ListCrystal*)D_new(ListCrystal);	foundCrystals->DoInit(0);	foundCrystals->CopyDMCrystal(testCrystal);	minMatches 			=	0;	if((Ptr)testCrystal == (Ptr)NUL  || (Ptr)comparisonCrystal == (Ptr)NUL){		inherited::Kill();		return;	}		//for(i = 0; i <= 9; i++) 		//theElements[0][i] = true;	requiredFOM 		= 	85;	for(i = 0; i < 16;i++)logicFlags[i] = 0;/*Added for V2.0*/	logicFields.spaceGrpLow = 1;	logicFields.spaceGrpHigh = 230;	logicFields.volumeLow = 5;	logicFields.volumeHigh = 160;	logicFields.densityLow = 2;	logicFields.densityHigh = 14;	for(i = 0; i < 3;i++)logicFields.crysLow[i] = 2;	for(i = 3; i < 6;i++)logicFields.crysLow[i] = 90;	for(i = 0; i < 3;i++)logicFields.crysHigh[i] = 8;	for(i = 3; i < 6;i++)logicFields.crysHigh[i] = 90;		logicFields.crysSys = 7;	sprintf(logicFields.subFile,"Red3");	c2pstr(logicFields.subFile);	sprintf(logicFields.mineralName,"Sodium Chloride");	c2pstr(logicFields.mineralName);	sprintf(logicFields.pearsonSym,"oP23");	c2pstr(logicFields.pearsonSym);	sprintf(logicFields.organic,"BENZENE");	c2pstr(logicFields.organic);	sprintf(logicFields.author,"FRAZER");	c2pstr(logicFields.author);	sprintf(logicFields.CODEN,"ORGAN51");	c2pstr(logicFields.CODEN);		logicFields.cdfID = 1345;	logicFields.casNum = 1912;	logicFields.yearHigh = 1998;	logicFields.yearLow = 1998;}void	SearchObject::Kill(void)//Jim:Search:SE_SearchObject.c{	MenuHandle 		theMenu;	short 			theValue,i;		testCrystal->			DoClose();	if(comparisonCrystal)comparisonCrystal->			DoClose();	theMenu 		= 		GetMenu(304);	theValue 		= 		CountMItems(theMenu);		foundCrystals	->		KillAll();	for(i = 5; i <= theValue;i++) 			DelMenuItem(theMenu,5);	DeleteMenu((*theMenu)->menuID);	ReleaseResource((Handle)theMenu);	inherited::Kill();	}	Boolean 	SearchObject::DoDefine(){	short 			i,j,item,type,oldItem = 1;	Handle 			theHandle;	Rect 			theRect;	Boolean 		newFlag = true;		Boolean			oldElements[5][105];		GetPort(&oldPort);	//gScreenSize 	= 	oldPort->portRect;	maxElmnts 		= 	103;	for(i = 0; i <= 4; i++){		for(j = 0; j <= 104;j++)			oldElements[i][j] = theElements[i][j];	}	ExcludeElements		(0,1);	theDialog 		= 	DM_GetNewDialog(DLOG_FIRST, 0L,(WindowPtr)-1L);		GetDItem			(theDialog,PICTRECT,&type,&theHandle,&thePerTabRect);	stackNo 		= 	0;		GetDItem			(theDialog,15,&type,&theHandle,&theRect);	sprintf				(gTheText,"Set Search Chemistry - Unselected Elements are excuded");	c2pstr				(gTheText);	SetIText			(theHandle,pTheText);		GetDItem			(theDialog,ALLOYCOMP,&type,&theHandle,&theRect);	sprintf				(gTheText,"May be present");	c2pstr				(gTheText);	SetCTitle			((ControlHandle)theHandle,pTheText);	SetCtlValue			((ControlHandle)theHandle,1);		GetDItem			(theDialog,ALLOYCOMP + 1,&type,&theHandle,&theRect);	sprintf				(gTheText,"Must be present");	c2pstr				(gTheText);	SetCTitle			((ControlHandle)theHandle,pTheText);		for(i = 2; i <= 4;i++){		GetDItem		(theDialog,ALLOYCOMP + i,&type,&theHandle,&theRect);		HideControl		((ControlHandle)theHandle);	}	for(i = 0; i <= 4;i++){		GetDItem		(theDialog,ALOOYACEPT + i,&type,&theHandle,&theRect);		HideControl		((ControlHandle)theHandle);	}		GetDItem			(theDialog,3,&type,&theHandle,&theRect);	HideControl			((ControlHandle)theHandle);	oldItem 		= 	ALLOYCOMP;		while(1 != 2){		ModalDialog(TheFilterUPP,&item);		switch(item){			case REPLACE:				if(this->theDialog != 0L)					DM_DisposDialog(&(this->theDialog));				else{					SetPort(oldPort);					KillDialogMenuBar(); /*July 1992 */				}				return true;			case CANCEL:			case CANCELCLICK: 				for(i = 0; i <= 4; i++){					for(j = 0; j <= 104;j++)						theElements[i][j] = oldElements[i][j];				}				if(this->theDialog != 0L)					DM_DisposDialog(&(this->theDialog));				else{					SetPort		(oldPort);					KillDialogMenuBar(); /*July 1992 */				}				return 		false;						case ALLOYCOMP:			case ALLOYCOMP1:				SetPeriodicTable		(stackNo);								GetDItem				(theDialog,oldItem,&type,&theHandle,&theRect);				if(oldItem != item)					ExcludeElements		(stackNo,item - ALLOYCOMP);								SetCtlValue				((ControlHandle)theHandle,0);								GetDItem				(theDialog,item,&type,&theHandle,&theRect);				SetCtlValue				((ControlHandle)theHandle,1);								stackNo 			= 	item - ALLOYCOMP;				oldItem 			= 	item;								SetPeriodicTable		(stackNo);				break;						case PICTRECT:				PeriodicTable			();				break;			case ML_UPDATE_EVT:				BeginUpdate(theDialog);			UpdtDialog(theDialog,theDialog->visRgn);			if(!gAppleEvtsOK){				HiliteOK(theDialog);			}			EndUpdate(theDialog);			break;			default:				break;		}		if(newFlag == true){			SetPeriodicTable(0);			newFlag = false;		}	}}void	SearchObject::SearchByDSpace(float *oldDspacings,float cameraConstant1,float wavelength1,short typeDialog1){		Handle 				theHandle;	Rect					theRect;		MenuHandle		theMenu;			short					lastJPDS,lastCrystal,oldCrystal,								theValue;	short 				i,item,height,width,								theFOM,type;	short			n = 0;	Boolean		selectFlag = false;	float			floatValue;				 	 height = qd.screenBits.bounds.bottom - qd.screenBits.bounds.top;	 width	= qd.screenBits.bounds.right - qd.screenBits.bounds.left;	 	 	 if(width >= 640 && height >= 480){	 	theDialogSearch	= 	DM_GetNewDialog		(3011, 0L,(WindowPtr)-1L);	 	bigScreenFlag 	= true;	 } else {	 	theDialogSearch	= 	DM_GetNewDialog		(DLOG_SEARCH, 0L,(WindowPtr)-1L);	 	bigScreenFlag 	= false;	 }	dspacings 	= 	(float*)D_NewPtr	((MAXEXPDSPACE) * sizeof(float));	currentList	=	(float*)D_NewPtr	((MAXEXPDSPACE) * sizeof(float));	cameraConstant = cameraConstant1;	wavelength = wavelength1;		GetDItem	(theDialogSearch,CAMERACONSTANT,&type,&theHandle,&theRect);	sprintf		(gTheText,"%5.3f",cameraConstant);	SetIText	(theHandle,c2pstr(gTheText));		GetDItem	(theDialogSearch,WAVELENGTH,&type,&theHandle,&theRect);	sprintf		(gTheText,"%6.4f",wavelength);	SetIText	(theHandle,c2pstr(gTheText));					lastCrystal 	= 	1;	lastJPDS 		= 	1;			searchTypePopUp		= 	(PopUpMenu*)D_new (PopUpMenu);	searchTypePopUp->		Init		(theDialogSearch,SEARCH_TYPE_POPUP,27,typeDialog1);		 theCRYSMenu		= 	(PopUpMenu*)D_new (PopUpMenu);	theCRYSMenu->		Init			(theDialogSearch,POPUPCRYSTALS,109,1);	databaseMenu		= 	(PopUpMenu*)D_new				(PopUpMenu);	databaseMenu->		Init			(theDialogSearch,SEARCHDIFV2,133,1);	theMenu 		= 	GetMenu(304);	theValue 		= 	CountMItems			(theMenu);		for(i = 6; i <= theValue;i++) {		GetItem(theMenu,i,pTheText);		theCRYSMenu->P_AppendMenu(gTheText);	}	totalFound = theValue - 6;	if(totalFound < 0) totalFound = 0;	for(i = 5; i <= theValue;i++) {		DelMenuItem(theMenu,5);	}			DrawSearchRects			();	for(i = 0; i < MAXEXPDSPACE;i++){		if(oldDspacings[i] < .1)			dspacings[i] = -1;		else			dspacings[i] = oldDspacings[i];	}	ConvertDspaceToCurrentList();		InitListings			();	InitFoundListings		();	WriteList				();		gTheCell.h			= 	0;	gTheCell.v 			= 	0;		GetDItem		(theDialogSearch,INPUTDSPACE,&type,&theHandle,&theRect);		LSetSelect		(false,gTheCell,theDspaceList);	sprintf			(gTheText,"%5.3f",currentList[0]);	LSetSelect		(true,gTheCell,theDspaceList);	SetIText		(theHandle,c2pstr(gTheText));					if(searchTypePopUp->	lastResult >= VOL_SEARCH_D){		GetDItem	(theDialogSearch,FOMLABEL,&type,&theHandle,&theRect);		sprintf		(gTheText,"Exp. Vol.");		SetIText(theHandle,c2pstr(gTheText));	}				SelIText(theDialogSearch,INPUTDSPACE,0,32767);			while(1 != 2){		Boolean			flag;		ModalDialog(TheFilterUPP,&item);		switch(item){			short 	mark,lastSelect;			long 	place1,place2;			case ML_UPDATE_EVT:				BeginUpdate(theDialogSearch);			UpdtDialog(theDialogSearch,theDialogSearch->visRgn);			if(!gAppleEvtsOK){				HiliteOK(theDialogSearch);			}			EndUpdate(theDialogSearch);			break;			case SEARCH:							ConvertCurrentListToDspace();				StartWatch();/*dec 1992*/				DoSearchDspace(); 				WriteList();				StopWatch();/*dec 1992*/				theCRYSMenu->lastResult = 1;				theCRYSMenu->		SetPopUp();				searchTypePopUp->	SetPopUp();				databaseMenu->      SetPopUp();				lastCrystal 	= 	1;												GetDItem			(theDialogSearch,TOTALMATCH,&type,&theHandle,&theRect);				sprintf				(gTheText,"%d",totalFound); 				SetIText			(theHandle,c2pstr(gTheText));								break;			case QUITJPDS:			case CANCELCLICK: 								ConvertCurrentListToDspace();				for(i = 0; i < MAXEXPDSPACE; i++){					oldDspacings[i] = -1;					if(dspacings[i] > .1)oldDspacings[i] = dspacings[i] ;				}								if(totalFound > 0){	 					foundCrystals->FillMenuFrom(theMenu,5);					theValue 	= 	theCRYSMenu->P_CountMItems();					sprintf(gTheText,"-");					c2pstr(gTheText);					AppendMenu(theMenu,pTheText);					DisableItem(theMenu,5);					for(i = 2;i <= theValue;i++){						if(selectFlag){							mark = theCRYSMenu->P_GetItemMark	(i);							if(!mark){								theCRYSMenu->		P_DelMenuItem(i);								mark = 1;								foundCrystals	->	DeleteCrystal	(i,mark);								i--;								theValue--;								continue;							}						}						theCRYSMenu->P_GetItemText(i,gTheText);						AppendMenu(theMenu,pTheText);						EnableItem(theMenu,i + 4);					}				}								if(theDspaceList != 0L)					LDispose(theDspaceList);				theCRYSMenu->	DoClose();				searchTypePopUp->	DoClose();				databaseMenu->		DoClose();				if(this->theDialogSearch != 0L)					DM_DisposDialog(&(this->theDialogSearch));								KillPtr((Ptr)dspacings);				KillPtr((Ptr)currentList);				return;		case 33:			SaveStrippedCrystals();			goto THIS_SHOULD_BE_A_FUNCTION;			break;			case ENTERCLICK:			case ENTERDSPACE:				SetPort(theDialogSearch);				floatValue 	= 	GetItemValue		(theDialogSearch,INPUTDSPACE);				currentList[gTheCell.v] =  floatValue;				if(currentList[gTheCell.v] >= 0.0){					sprintf(gTheText,"%5.3f",floatValue);					c2pstr		(gTheText);					LSetCell	(&(gTheText[1]),(short)(gTheText[0]),gTheCell,theDspaceList);				}								GetDItem			(theDialogSearch,INPUTDSPACE,&type,&theHandle,&theRect);				LSetSelect			(false,gTheCell,theDspaceList);				sprintf(gTheText,"%5.3f",currentList[++gTheCell.v]);				LSetSelect(true,gTheCell,theDspaceList);				SetIText(theHandle,c2pstr(gTheText));				SelIText(theDialogSearch,INPUTDSPACE,0,32767);				WriteList();				LAutoScroll(theDspaceList);								break;			case SEARCHDIFV2:							 databaseMenu->DoPopUp	();				flag = true;				if(databaseMenu->P_GetCItemMark	()) flag = false;				databaseMenu->P_CheckCItem(flag);				databaseMenu->P_CheckItem(1,false);				if(databaseMenu->lastResult == 2)				{					databaseMenu->P_CheckItem(3,false);					databaseMenu->P_CheckItem(2,false);					for(i = 5; i <= databaseMenu->P_CountMItems();i++)						databaseMenu->P_CheckItem(i,true);				}				if(databaseMenu->lastResult == 3)				{					databaseMenu->P_CheckItem(2,false);					databaseMenu->P_CheckItem(3,false);					for(i = 5; i <= databaseMenu->P_CountMItems();i++)						databaseMenu->P_CheckItem(i,false);				}				sprintf(gTheText,"Search: ");				for(i = 5; i <= databaseMenu->P_CountMItems();i++){									if(databaseMenu->P_GetItemMark	(i))					{						char theText[255];						short	length;						databaseMenu->P_GetItemText	(i,theText);						length = strlen(gTheText);						gTheText[length] = theText[1];						gTheText[length + 1] = ' ';						gTheText[length + 2] = 0;					}									}				databaseMenu->P_SetItemText	(1,(char *)c2pstr(gTheText));				databaseMenu->lastResult  = 1;				databaseMenu->SetPopUp(); 				break;			case PRINT_FOUND:			PrOpen();				PrintFoundCrystals();			PrClose();				DrawSearchRects	();				WriteList		();				theCRYSMenu->	SetPopUp();				searchTypePopUp->SetPopUp();				CrystalDisplay	(theDialogSearch,testCrystal);				databaseMenu->SetPopUp();				break;			case JCPDFFULLDISPLAY:				if(totalFound < 1)					break;				if(lastCrystal < 1)					break;								JCPDFFullDisplay(lastCrystal);				SetPort				(theDialogSearch);				DrawSearchRects		();				WriteList			();				theCRYSMenu->		SetPopUp();				databaseMenu->		SetPopUp(); 				searchTypePopUp->	SetPopUp();				CrystalDisplay		(theDialogSearch,testCrystal);			break;			case POPUPCRYSTALS:				if(totalFound < 1)					break;				ConvertCurrentListToDspace	();				oldCrystal 	= 	lastCrystal;				lastCrystal = (short)theCRYSMenu->	DoPopUp();				if(theCRYSMenu->	lastResult > 1)					lastCrystal	= theCRYSMenu->	lastResult;				else					break;				if(lastCrystal == oldCrystal)					break;				THIS_SHOULD_BE_A_FUNCTION:				if(DoNewCrystalList	(lastCrystal,&place1,&place2,0)){					ListCrystal *hitCrystal;					short theNumber = 0;					WriteList		();										hitCrystal = foundCrystals->GetCrystal(lastCrystal - 1,&theNumber);					if(hitCrystal->dataBase < 3)HideDItem(theDialogSearch,JCPDFFULLDISPLAY);					else ShowDItem(theDialogSearch,JCPDFFULLDISPLAY);									}								for(i = 30 ; i <= 32 ; i++){					GetDItem(theDialogSearch,i,&type,&theHandle,&theRect);					dm_EraseRect(&theRect);				}												theFOM 		= 	TestCrystalFOM(dspacings);				GetDItem		(theDialogSearch,DISPLAYDATA,&type,&theHandle,&theRect);				sprintf			(gTheText,"FOM: %d",theFOM);				SetIText		(theHandle,c2pstr(gTheText));				CrystalDisplay	(theDialogSearch,testCrystal);				WriteList		();				 GetDItem(theDialogSearch,31,&gType,&gTheHandle,&gTheRect);				PlotComparativeLines		(gTheRect);				if(selectFlag){					if(theCRYSMenu-> 	P_GetItemMark		(lastCrystal))						theCRYSMenu-> 	P_CheckCItem	(false);					else						theCRYSMenu-> 	P_CheckCItem	(true);				}				theCRYSMenu->SetPopUp();				searchTypePopUp->		SetPopUp	();				databaseMenu->			SetPopUp(); 				break;			case INPUTDSPACE:				break;			case DSPACERECT:				HandleListRect	();				sprintf			(gTheText,"%5.3f",currentList[gTheCell.v]);				GetDItem		(theDialogSearch,INPUTDSPACE,&type,&theHandle,&theRect);				SetIText		(theHandle,c2pstr(gTheText));				SelIText		(theDialogSearch,INPUTDSPACE,0,32767);				break;			case DSPSCROLLRECT:				GlobalToLocal	(&(gTheEvent.where));				LClick			(gTheEvent.where,gTheEvent.modifiers,theDspaceList);				break;							case MSCROLLRECT:				GlobalToLocal	(&(gTheEvent.where));				LClick			(gTheEvent.where,gTheEvent.modifiers,theFoundList);				break;							case SEARCHCHEM:				DoDefine			();				SetPort				(theDialogSearch);				DrawSearchRects		();				WriteList			();				theCRYSMenu->		SetPopUp();				databaseMenu->		SetPopUp(); 				searchTypePopUp->	SetPopUp();				CrystalDisplay		(theDialogSearch,testCrystal);				break;							case DELETECRYS:				if(lastCrystal <= 1)					break;				theCRYSMenu->		P_DelCMenuItem();				i = 1;				foundCrystals	->	DeleteCrystal	(lastCrystal,i);								totalFound--;				if(lastCrystal > totalFound + 1) 					lastCrystal = totalFound + 1;								if(lastCrystal <= 1)					break;				if(DoNewCrystalList(lastCrystal,&place1,&place2,0)){					WriteList();				}								searchTypePopUp->	SetPopUp();				GetDItem(theDialogSearch,31,&gType,&gTheHandle,&gTheRect);				PlotComparativeLines(gTheRect);				CrystalDisplay(theDialogSearch,testCrystal);				break;			case SELECTCRYS:				GetDItem(theDialogSearch,SELECTCRYS,&type,&theHandle,&theRect);				if(GetCtlValue((ControlHandle)theHandle) == 0){					SetCtlValue((ControlHandle)theHandle,1);				} else {					SetCtlValue((ControlHandle)theHandle,0);				}								if(selectFlag){					short number;					selectFlag = false;					number = 	theCRYSMenu->	P_CountMItems();					for(i = 1;i <= number;i++)						theCRYSMenu->	P_CheckItem(i,false);				}else 					selectFlag = true;								break;			case FOM:			case TOTALMATCH:				break;			case REFERENCE:								testCrystal->	ReferenceDITL();				DrawSearchRects	();				WriteList		();				theCRYSMenu->	SetPopUp();				searchTypePopUp->SetPopUp();				CrystalDisplay	(theDialogSearch,testCrystal);				databaseMenu->SetPopUp();				break;			case ELIMINATEREDUN:				if(totalFound < 1)					continue;				EliminateRedundancies	();				lastCrystal 	= 		theCRYSMenu->lastResult ;				if(DoNewCrystalList		(lastCrystal,&place1,&place2,0)){					WriteList			();				}								theCRYSMenu->SetPopUp();				searchTypePopUp->SetPopUp();				databaseMenu->SetPopUp();				GetDItem(theDialogSearch,31,&gType,&gTheHandle,&gTheRect);/*Eric's changes*/				PlotComparativeLines(gTheRect);/*Jim Changes*/				CrystalDisplay(theDialogSearch,testCrystal);				break;			case SEARCH_TYPE_POPUP:				lastSelect = searchTypePopUp->lastResult;				ConvertCurrentListToDspace	();				searchTypePopUp->DoPopUp();				if(searchTypePopUp->lastResult < 1)					searchTypePopUp->lastResult = lastSelect;				if(searchTypePopUp->lastResult > 6){					SetSearchLogic();					DrawSearchRects	();					WriteList		();					theCRYSMenu->	SetPopUp();					searchTypePopUp->SetPopUp();					CrystalDisplay	(theDialogSearch,testCrystal);					databaseMenu->SetPopUp();					break;				}				if(lastSelect != searchTypePopUp->lastResult)					SetAndConvertLists();				break;										default:				break;		}	}}void SearchObject::SetAndConvertLists(void){	short type;	Rect theRect;	Handle theHandle;	if(searchTypePopUp->	lastResult > 6) return;	ConvertDspaceToCurrentList	();	WriteList		();	GetDItem	(theDialogSearch,FOMLABEL,&type,&theHandle,&theRect);	if(searchTypePopUp->	lastResult >= VOL_SEARCH_D){		if(bigScreenFlag){			sprintf		(gTheText,"      Experimental Volume");		} else {			sprintf		(gTheText,"Exp. Vol.");		}	}else{		if(bigScreenFlag){			sprintf		(gTheText,"Minimum Figure of Merit");		} else {			sprintf		(gTheText,"Min. FOM");		}	}	SetIText(theHandle,c2pstr(gTheText));}void	CrystalDisplay(DialogPtr theDialogSearch,Crystal *testCrystal){	short theLeft,theTop;	SetPort(theDialogSearch);	GetDItem(theDialogSearch,30,&gType,&gTheHandle,&gTheRect);/* Eric additions August 1993 */	theLeft = gTheRect.left + 65;	theTop  = gTheRect.top + 17;	TextFont(geneva);	TextSize(9);	testCrystal->		TableDisplayCrystal	(&theLeft,&theTop);	TextFont(0);	TextSize(0);}void	SearchObject::EliminateRedundancies(){	short 		baseN,compN,j,mark;	short 		theValue;	ListCrystal *compareCrystal,*baseCrystal;		theValue 	= 	theCRYSMenu->P_CountMItems();	for(baseN = 2;baseN <= theValue;baseN++){		j = 1;		baseCrystal = foundCrystals -> GetCrystal		(baseN,&j);		for(compN = baseN + 1; compN <= theValue;compN++){			if(baseN == compN)				continue;			j = 1;			compareCrystal = foundCrystals -> GetCrystal		(compN,&j);						if(fabs((double)((double)(double)compareCrystal->volume - (double)baseCrystal->volume)/(double)baseCrystal->volume) < .05)			{				if(compareCrystal->spaceGrp != baseCrystal->spaceGrp){					if(compareCrystal->spaceGrp > 1 && baseCrystal->spaceGrp > 1){						continue;					}				}				if(compareCrystal->year <=  baseCrystal->year)				{					theCRYSMenu->		P_DelMenuItem(compN);					mark = 1;					foundCrystals	->	DeleteCrystal	(compN,mark);					theValue--;					compN--;				}else{					theCRYSMenu->		P_DelMenuItem(baseN);					mark = 1;					foundCrystals	->	DeleteCrystal	(baseN,mark);					theValue--;					baseN--;					goto BOTTOM;				}			}		}		BOTTOM:	continue;	}	theCRYSMenu->lastResult = theValue;}short SearchObject::TestCrystalFOM(float *values){	short i,j = -1,maxDSpace,k,total;	float rValue[MAXEXPDSPACE],rValueStore[MAX_STORE_DSPACE];	Boolean noHit;	double denominator;			for(i = 0; i < MAXEXPDSPACE; i++){		if(values[i] > .78){			j++;			rValue[i] = 2.5 / values[i];		}	}	if(j < 0) return 100;	maxDSpace = -1;	for(i = 0; i < MAX_STORE_DSPACE;i++){		if(testCrystal->dspacings[i].x > .78){						if(fabs(testCrystal->dspacings[i].x - 2) < .00001 && testCrystal->dspacings[i].intensity < .00001)				continue;			maxDSpace++;			rValueStore[maxDSpace] = 2.5 / testCrystal->dspacings[i].x;					}	}	total = 0;	for(i = 0; i <= j;i++){		noHit = true;		k = 0;		while(k <= maxDSpace){			while(k < maxDSpace && fabs(rValueStore[k] -  rValueStore[k + 1]) < .010)k++;						if(rValue[i] <= rValueStore[k] + .019 && rValue[i] >= rValueStore[k] - .019){				total += j + 1 - i;				noHit = false;			}			k++;		}	}	denominator = (double)((j + 1) * (j + 2));	return (short)((double)200 * ((double)total / denominator));}short SearchObject::SearchFOM(unsigned short *storedRMap){	short i,k;	float theDspacings[MAX_STORE_DSPACE];	short j = -1,maxDSpace,total;	float rValue[MAXEXPDSPACE],rValueStore[MAX_STORE_DSPACE];	Boolean noHit;	if(minMatches == 0) return 100;	ReturnSearchFileDspace(storedRMap,theDspacings);	qsort(dspacings,(long)(MAXEXPDSPACE),sizeof(float),(_compare_function/*__cmp_func_Cmpfun**/)FloatCompare);	for(i = 0; i < MAXEXPDSPACE; i++){		if(dspacings[i] > .78){			j++;			rValue[i] = 2.5 / dspacings[i];		}	}	maxDSpace = -1;	for(i = 0; i < MAX_STORE_DSPACE;i++){		if(theDspacings[i] > .78){			rValueStore[i] = 2.5 / theDspacings[i];			maxDSpace++;		}	}	total = 0;	for(i = 0; i <= j;i++){		noHit = true;		k = 0;		while(k <= maxDSpace){			while(k < maxDSpace && fabs(rValueStore[k] -  rValueStore[k + 1]) < .010)k++;						if(rValue[i] <= rValueStore[k] + .019 && rValue[i] >= rValueStore[k] - .019){				total += j + 1 - i;				noHit = false;			}			k++;		}	}	return (short)((double)200 * ((double)total / (double)((j + 1) * (j + 2))));}void SearchObject::HandleListRect(void){	Point thePoint;	Cell theCell;	short i;	Rect theRect;	Boolean flag;	GlobalToLocal(&(gTheEvent.where));	SetPort(theDialogSearch);	flag = LClick(gTheEvent.where,gTheEvent.modifiers,theDspaceList);	GetMouse(&thePoint);	SetRect(&theRect,-5,-5,-5,-5);	theCell.h = 0;	for(i = 0;i < MAXEXPDSPACE;i++){		theCell.v = i;		LRect(&theRect,theCell,theDspaceList);		if(PtInRect(thePoint,&theRect)){			gTheCell.v = theCell.v;			gTheCell.h = theCell.h;		}	}		}void	SearchObject::InitListings(void){	FontInfo 	theFont;	short		textHeight;	Point		cellSize;	Handle 		theHandle;	Rect 		theRect,rBounds;	short		type;			GetDItem(theDialogSearch,DSPACERECT,&type,&theHandle,&theRect);		PenNormal();	GetFontInfo(&theFont);	textHeight = theFont.ascent + theFont.descent + theFont.leading;	SetRect(&rBounds,0,0,1,MAXEXPDSPACE);	cellSize.h = 62;	cellSize.v = textHeight;	theDspaceList = LNew(&theRect,&rBounds,cellSize,0,theDialogSearch,true,false,false,true);	(*theDspaceList)->selFlags = 0x80;	return;}void	SearchObject::SetListings(void){	short i;	Cell theCell;	theCell.h = 0;	for(i = 0 ; i < MAXEXPDSPACE ; i++){		theCell.v = i;		if(currentList[i] > 0.1)			sprintf(gTheText,"%5.3f",currentList[i]);		else			sprintf(gTheText,"0.0");				c2pstr(gTheText);		LSetCell(&(gTheText[1]),(short)(gTheText[0]),theCell,theDspaceList);	}	return;}void	SearchObject::ExcludeElements(short i,short j){	short k;	for(k = 0; k <= 104; k++){		if(theElements[i][k]) theElements[j][k] = false;	}			}void	SearchObject::SetPopUp(MenuHandle theMenu,Rect theRect,short theItem){	dm_EraseRect(&theRect);	dm_FrameRect(&theRect);	MoveTo(theRect.left + 1,theRect.bottom);	LineTo(theRect.right,theRect.bottom);	LineTo(theRect.right,theRect.top);	MoveTo(theRect.left + 4,theRect.bottom - 2);	GetItem(theMenu,theItem,pTheText);	DrawString(pTheText);}void	SearchObject::DoSearchDspace(){	short 		type,i;	Handle 		theHandle;	Rect 		theRect;	ListCrystal	*lastFoundCrystal;	ListParameters *start,*oldStart;	totalFound 		= 	0;		GetDItem			(theDialogSearch,TOTALMATCH,&type,&theHandle,&theRect);	sprintf				(gTheText,"%d",totalFound); 	SetIText			(theHandle,c2pstr(gTheText));		requiredFOM 	= 	GetItemValue		(theDialogSearch,FOM);		expVolume 		= 	requiredFOM;	noOfDspace 		= 	-1;				qsort				(dspacings,(long)(10),sizeof(float),(_compare_function/*__cmp_func_Cmpfun**/)FloatCompare);	foundCrystals->FillMenuFrom(theCRYSMenu->theMenu,1);	for(i = 0; i < MAXEXPDSPACE; i++) 			if(dspacings[i] > .2) noOfDspace++;		for(i = 0; i <= noOfDspace;i++) 			delDspace[i] = dspacings[i] * 10;				minMatches 		= 	(noOfDspace + 1) / 2;		foundCrystals	->	DoCloseAll();				if(searchTypePopUp->lastResult <= VOL_SEARCH_TWO){		if(databaseMenu->P_GetItemMark	(5))				RecursiveFindHFS();			if(databaseMenu->P_GetItemMark	(6))				FindJCPDS(); 	}	if(databaseMenu->P_GetItemMark	(7))			SearchJCPDFFiles(3); 			if(databaseMenu->P_GetItemMark	(8))			SearchJCPDFFiles(4); 	FlushEvents(everyEvent,0);	if(totalFound == 0)return;	lastFoundCrystal = foundCrystals;		while(lastFoundCrystal != 0L){		if(lastFoundCrystal->dataBase == 1){			GetJPDSSearchCrystal(lastFoundCrystal->refNo1,lastFoundCrystal->refNo2);			lastFoundCrystal->CopyDMCrystal(testCrystal);			if(searchTypePopUp->lastResult >= VOL_SEARCH_D)               	lastFoundCrystal->FOM = TestCrystalFOM(dspacings);		}		lastFoundCrystal = lastFoundCrystal->next;	}	oldStart = start = (ListParameters*)D_NewPtr(sizeof(ListParameters) * (totalFound + 2));	{				short n,j;				n = 0;	    foundCrystals->FillListVol(start, &n);		qsort(&start[1],n,sizeof(ListParameters),(_compare_function/*__cmp_func_Cmpfun**/)SortListCrysByDecreasingValue);		foundCrystals->FillSortedList(start,j = 0,n);		j = -1;		for(i = 0; i < MAXEXPDSPACE; i++){			if(dspacings[i] > .78){				j++;			}		}		if(searchTypePopUp->lastResult <= TWO_THETA_SEARCH && j >= 2){			n = 0;		    foundCrystals->FillListFOM(start, &n);			qsort(&start[1],n,sizeof(ListParameters),(_compare_function/*__cmp_func_Cmpfun**/)SortListCrysByDecreasingValue);			foundCrystals->FillSortedList(start,j = 0,n);		}		start++;		for(i = 0; i < n;i++,start++)		{			lastFoundCrystal = (ListCrystal*)start->address;			lastFoundCrystal->AppendItemsToMenu(theCRYSMenu->theMenu);		}	}	KillPtr((Ptr)oldStart);}          /* for the PBGetCatInfo call */          /* place to hold file name */void SearchObject:: RecursiveFindHFS(void){		FSSpec	theFSSpec;		if(gAppleEvtsOK){					gTheFile->fileError = GetDirPath(SEARCH_DMCRYSTALS,&theFSSpec);		gTheFile->DoFileError();		if(gTheFile->fileError) return;		/*theFSSpec.parID 	= GetDirIDFromFSSpec(theFSSpec);*/		HFSEnumerateCat(theFSSpec);	} else {		char fName[255];		HFileInfo		myCPB;			    gTheFile->fileError = HGetVol((unsigned char*)fName,&myCPB.ioVRefNum,&myCPB.ioDirID);	    if(gTheFile->fileError != 0) gTheFile->DoFileError();	    myCPB.ioNamePtr = (StringPtr)fName;	    sprintf(fName,"Desktop Crystals");	    c2pstr(fName);	    myCPB.ioFDirIndex = 0;	    PBGetCatInfo((CInfoPBPtr)&myCPB,false);	    theFSSpec.parID 	= myCPB.ioDirID;	    theFSSpec.vRefNum	= myCPB.ioDirID;	   	HFSEnumerateCat(theFSSpec);  	   	  }  } void SearchObject::HFSEnumerateCat(FSSpec	theFSSpec){ 																	/*EnumerateCatalog */    HFileInfo		myCPB; 	unsigned char	fName[255];	short			index=1;									/* for ioFDirIndex */	OSErr			err;               							/* the usual */	FInfo			aFilesInfo;    	myCPB.ioNamePtr = fName;        do    {		myCPB.ioFDirIndex 	= index;         									myCPB.ioDirID 		= theFSSpec.parID;  									myCPB.ioVRefNum 	= theFSSpec.vRefNum;     									err 				= PBGetCatInfo((CInfoPBPtr)&myCPB,false);				if (err == noErr){       if (((myCPB.ioFlAttrib>>4) & 0x01) == 1)      {	      	long oldID;       	oldID = theFSSpec.parID;     		theFSSpec.parID = myCPB.ioDirID; /* JTS 4/93 */     		HFSEnumerateCat(theFSSpec);       		if( Quit())return;								theFSSpec.parID = oldID;									} else { 				BlockMove((Ptr)&(myCPB.ioFlFndrInfo),(Ptr)&aFilesInfo,sizeof(FInfo));				if(aFilesInfo.fdType ==  CRYST_OBJ && aFilesInfo.fdCreator == OWNER){          gTheFile->fileError = HOpen(myCPB.ioVRefNum,theFSSpec.parID,(unsigned char*)fName,(SignedByte)fsRdPerm,&gTheFile->pathRefNum);										if(gTheFile->fileError != 0){						gTheFile->DoFileError();						index++;						continue;					}					         gTheFile->file_is_Open = true;                 	          if( Quit()){/*dec 1992*/						gTheFile->DoFileClose();						return ;					}					        	testCrystal->FileReadCrystal();        	        	if(RunTestDiffractDspace(testCrystal)){        		ListCrystal	*lastCrystal;        		totalFound++;        		if(Quit()){							totalFound--;							gTheFile->DoFileClose();              return ;						}                  			        		GetDItem(theDialogSearch,TOTALMATCH,&gType,&gTheHandle,&gTheRect);        		sprintf(gTheText,"%d",totalFound);        		SetIText(gTheHandle,c2pstr(gTheText));	        			        			        		lastCrystal = foundCrystals->DoAdd(testCrystal,0,theFSSpec.parID,(long)myCPB.ioVRefNum);        		lastCrystal->ChangeFileName((unsigned char*)fName);        		lastCrystal->FOM = TestCrystalFOM(dspacings);        		        	}					gTheFile->DoFileClose();				}			}        index += 1;     											/* increment the index for GetCatInfo */      } 															/* if (err == noErr) */    } while (err == noErr);} 																	/* EnumerateCatalog */Boolean SearchObject::RunTestDiffractDspace(Crystal* testCrystal){	short i,k;	double screen;		for(i = 0; i < testCrystal->noDifrntElem;i++){		if(!theElements[0][testCrystal->elementList[i]] && !theElements[1][testCrystal->elementList[i]]) return false;	}	for(i = 0; i <= 99;i++){		if(theElements[1][i]){			for(k = 0; k < testCrystal->noDifrntElem;k++) if(testCrystal->elementList[k] == i) goto FOUND;			return false;		}		FOUND:;	}		if(searchTypePopUp->lastResult >= VOL_SEARCH_D && searchTypePopUp->lastResult <= VOL_SEARCH_TWO ){		screen = expVolume * .10;		if(fabs(testCrystal->volumeReduced - expVolume) <= screen)		{		 	return true;		 }		 return false;	}	if(minMatches == 0) return true;			if(TestCrystalFOM(dspacings) >= requiredFOM) return true ;	return false;}Boolean SearchObject::DoNewCrystalList(short theCrystalNo,long *refNo1,long *refNo2,short display){	short theNumber;	ListCrystal *hitCrystal;	theNumber = 0;	hitCrystal = foundCrystals->GetCrystal(theCrystalNo - 1,&theNumber);	switch(hitCrystal->dataBase){		case 0:			{			short i;			i = 0;					strcpy(gTheText,(char*)hitCrystal->fileName);			c2pstr(gTheText);			*refNo1 = hitCrystal->refNo1;			*refNo2 = hitCrystal->refNo2;		 	gTheFile->fileError 	= 		HOpen((short)*refNo2,*refNo1,pTheText,(SignedByte)fsRdPerm,&(gTheFile->pathRefNum));			if(gTheFile->fileError != 0){				gTheFile->DoFileError();				return false;			}			gTheFile->file_is_Open 	= 		true;			BlockMove						((Ptr)gTheText,(Ptr)gTheFile->theFileInfo.sfFile.name,64L);			testCrystal->					FileReadCrystal();						gTheFile->						DoFileClose();			return true;			}			break;		case 1:			*refNo1 = 0;			*refNo2 = 0;			return 	GetJPDSSearchCrystal	(hitCrystal->refNo1,hitCrystal->refNo2);		break;		case 3:		case 4:			*refNo1 = 0;			*refNo2 = 0;			return GetSingleJCPDFSearchCrystal(hitCrystal->refNo1,					hitCrystal->refNo2,hitCrystal->dataBase,display);		break;	}		return false;	}void SearchObject::DoMenu(long theResult){	static short 	oldItem = 0,storedCrystal = 0;	short 			theItem,theMenu;	long			dirIDToSearch,ioVRefNum;	char 			theText[255],aText[255];	MenuHandle 		theMenuHnd;	short			markChar;		theMenu 	= 	HiWord(theResult);	theItem 	= 	LoWord(theResult);	theMenuHnd 	= 	GetMenu(theMenu);	GetItemMark(theMenuHnd,theItem,&markChar);	if(markChar && !(gTheEvent.modifiers & shiftKey)){		CheckItem			(theMenuHnd,theItem,false);		gCurrentObj->newPictReq = true;			return;	}	if(storedCrystal != 0){		CheckItem			(theMenuHnd,storedCrystal,false);	}else{		CheckItem			(theMenuHnd,oldItem,false);	}	storedCrystal = 0;	CheckItem			(theMenuHnd,theItem,true);	DoNewCrystalList	(theItem - 4,&dirIDToSearch,&ioVRefNum,0);	oldItem = theItem;	if(gTheEvent.modifiers & shiftKey){		ListCrystal *lastCrystal;		BlockMove			((Ptr)gTheFile->theFileInfo.sfFile.name,(Ptr)aText,64L);		testCrystal->		CrystalDef();		BlockMove			((Ptr)gTheFile->theFileInfo.sfFile.name,(Ptr)theText,64L);				if(strcmp			(p2cstr((unsigned char*)aText),p2cstr((unsigned char*)theText))){			 lastCrystal = foundCrystals->DoAdd(testCrystal,0,dirIDToSearch,ioVRefNum);		}		storedCrystal = theItem;		oldItem = 0;		return;	}		gCurrentObj->newPictReq = true;		//gCurrentObj->newPictEnable = true;}void SearchObject::DrawSearchRects(void){	Handle 	theHandle;	short	type;	Rect 	theRect;		PenNormal();		GetDItem(theDialogSearch,MATCHRECT,&type,&theHandle,&theRect);	InsetRect(&theRect,-1,-1);	dm_EraseRect(&theRect);	dm_FrameRect(&theRect);		GetDItem(theDialogSearch,DSPACERECT,&type,&theHandle,&theRect);	InsetRect(&theRect,-1,-1);	dm_EraseRect(&theRect);	dm_FrameRect(&theRect);}void	SearchObject::InitFoundListings(void){	FontInfo 	theFont;	short		textHeight;	Point		cellSize;	Handle 		theHandle;	Rect 		theRect,rBounds;	short		type;		GetDItem(theDialogSearch,MATCHRECT,&type,&theHandle,&theRect);			GetFontInfo(&theFont);	textHeight = theFont.ascent + theFont.descent + theFont.leading;	SetRect(&rBounds,0,0,3,MAX_STORE_DSPACE);	cellSize.h = 53;	cellSize.v = textHeight;	theFoundList = LNew(&theRect,&rBounds,cellSize,0,theDialogSearch,true,false,false,true);	(*theFoundList)->selFlags = 0x80;		PenNormal();	return;}void	SearchObject::WriteList(void){	short i,k;	Index *theIndex;	Cell theCell;		theIndex = (Index*)D_new(Index);	theIndex->DoInit(false,testCrystal);	cameraConstant 	= 	GetItemValue		(theDialogSearch,CAMERACONSTANT);	wavelength	 	= 	GetItemValue		(theDialogSearch,WAVELENGTH);	SetListings();		theCell.h = 0;	for(i = 0 ; i < MAX_STORE_DSPACE ; i++){		theCell.v = i;						for(k = 0; k <= 2; k++){			theCell.h = k;			switch(k){				case 0:					theIndex->h = testCrystal->dspacings[i].h;					theIndex->k = testCrystal->dspacings[i].k;					theIndex->l = testCrystal->dspacings[i].l;					theIndex->SetListIndex(theFoundList,theCell);					break;				case 1:										switch(searchTypePopUp->lastResult){						case DSPACE_SEARCH:						case VOL_SEARCH_D:						case USER_SEARCH_D:							if(testCrystal->dspacings[i].x < .1) sprintf(gTheText,"-0.0");							else sprintf(gTheText,"%5.3f",testCrystal->dspacings[i].x);							break;						case G_VECTOR_SEARCH:						case VOL_SEARCH_G:						case USER_SEARCH_G:							if(testCrystal->dspacings[i].x < .1) sprintf(gTheText,"-0.0");							else sprintf(gTheText,"%5.3f",cameraConstant/testCrystal->dspacings[i].x);							break;						case VOL_SEARCH_TWO:						case USER_SEARCH_TWO:						case TWO_THETA_SEARCH:							if(testCrystal->dspacings[i].x < .1) sprintf(gTheText,"-0.0");							else sprintf(gTheText,"%5.3f¡",(360 / PI) * asin(wavelength/(2 * testCrystal->dspacings[i].x)));							break;						default:							break;											}					c2pstr(gTheText);					LSetCell(&(gTheText[1]),(short)(gTheText[0]),theCell,theFoundList);					break;				case 2:					sprintf(gTheText,"%5.3f",(testCrystal->dspacings[i].intensity));					c2pstr(gTheText);					LSetCell(&(gTheText[1]),(short)(gTheText[0]),theCell,theFoundList);					break;			}					}			}	theIndex->DoClose();	return;}void	SearchObject::PlotRings(float scaleFactor,float scaleFactorY,short centerX,short centerY,double minPlottedX,double maxPlottedX){	Rect 		theRect;	short 		theX,theY,theNegX,theNegY,radius;	short 		i,startAngle;	double 		intensities[MAX_STORE_DSPACE];	double 		maxIntensity = 1;	MenuHandle	theMenu;	short		theValue;	Boolean		flag = false;	short		markChar;		theMenu 		= 	GetMenu(304);	theValue 		= 	CountMItems			(theMenu);		for(i = 6; i <= theValue;i++) {		GetItemMark(theMenu,i,&markChar);		if(markChar != noMark){			flag = true;		}	}	PenMode(gCurrentObj->gMode);	if(!flag)return;	switch(requiredFOM){		case G_VECTOR_SEARCH:		case VOL_SEARCH_G:		case USER_SEARCH_G:			gCurrentObj->DMForeColor/*PMForeColor*/(15);			//PenMode(blend);/*PenMode(patXor);*/			startAngle = 45;			for(i = 0; i < MAX_STORE_DSPACE;i++)			{				if(i > 0){					if(fabs((double)(testCrystal->dspacings[i].x - 							testCrystal->dspacings[i - 1].x)) < .05)						continue;				}				if((double)testCrystal->dspacings[i].x < .1)					continue;				radius = (short)(scaleFactor / (double)testCrystal->dspacings[i].x);				theX	= centerX + radius;				theY	= centerY + radius;				theNegX	= centerX - radius;				theNegY	= centerY - radius;				SetRect(&theRect,theNegX,theNegY,theX,theY);				dm_FrameOval(&theRect);			/*					FrameArc(&theRect,startAngle,90);				FrameArc(&theRect,startAngle - 90,-90);			*/			}		break;		case DSPACE_SEARCH:		case VOL_SEARCH_D:		case USER_SEARCH_D:			gCurrentObj->DMForeColor/*PMForeColor*/(15);		//	PenMode(blend);/*PenMode(patXor);*/ 			for(i = 0; i < MAX_STORE_DSPACE;i++)			{				if(	minPlottedX <= testCrystal->dspacings[i].x && maxPlottedX >= testCrystal->dspacings[i].x){										theX	= centerX + (short)(scaleFactor * (testCrystal->dspacings[i].x - minPlottedX));					if(testCrystal->dspacings[i].intensity > .1)						theY	= centerY - (short)(scaleFactorY * testCrystal->dspacings[i].intensity);					else						theY	= centerY - (short)(scaleFactorY);									SetRect(&theRect,theX,theY,theX + 1,centerY);						dm_PaintRect(&theRect);				}			}		break;		case TWO_THETA_SEARCH:		case VOL_SEARCH_TWO:		case USER_SEARCH_TWO:			gCurrentObj->DMForeColor/*PMForeColor*/(15);			//PenMode(blend);/*PenMode(patXor);*/			for(i = 0; i < MAX_STORE_DSPACE;i++)			{								if(maxIntensity <  testCrystal->dspacings[i].intensity)				{					maxIntensity =  testCrystal->dspacings[i].intensity;				}			}			for(i = 0; i < MAX_STORE_DSPACE;i++)			{				intensities[i] =  testCrystal->dspacings[i].intensity / maxIntensity;			}			centerY -= scaleFactorY;			for(i = 0; i < MAX_STORE_DSPACE;i++)			{				double theValue;				if(testCrystal->dspacings[i].x < .1)					continue;				theValue = (360 / PI) * asin(wavelength/(2 * testCrystal->dspacings[i].x));				if(	minPlottedX <= theValue && maxPlottedX >= theValue){					theX	= centerX + (short)(scaleFactor * (theValue - minPlottedX));					if(intensities[i] > .1)						theY	= centerY + (short)(scaleFactorY * intensities[i]);					else						theY	= centerY + (short)(scaleFactorY);									SetRect(&theRect,theX - 1,centerY,theX + 1,theY);						dm_PaintRect(&theRect);				}			}		break;		default:			break;	}	PenNormal();	}void	SearchObject::ConvertDspaceToCurrentList(void){	short i;	qsort(dspacings,(long)(MAXEXPDSPACE),sizeof(float),(_compare_function/*__cmp_func_Cmpfun**/)FloatCompare);	cameraConstant 	= 	GetItemValue		(theDialogSearch,CAMERACONSTANT);	wavelength	 	= 	GetItemValue		(theDialogSearch,WAVELENGTH);	for(i = 0; i < MAXEXPDSPACE; i++){		switch(searchTypePopUp->lastResult){			case DSPACE_SEARCH:			case VOL_SEARCH_D:			case USER_SEARCH_D:				currentList[i] = dspacings[i];				break;			case G_VECTOR_SEARCH:			case VOL_SEARCH_G:			case USER_SEARCH_G:				if(dspacings[i] > 0.1)					currentList[i] =  cameraConstant/dspacings[i];				else 					currentList[i] = -1.0;				break;			case TWO_THETA_SEARCH:			case USER_SEARCH_TWO:			case VOL_SEARCH_TWO:				if(dspacings[i] > 0.1)					currentList[i] =  (360 / PI) * asin(wavelength/(2 * dspacings[i]));				else 					currentList[i] = -1.0;				break;			default:				break;					}	}}void	SearchObject::ConvertCurrentListToDspace(void){	short i;	qsort(currentList,(long)(MAXEXPDSPACE),sizeof(float),(_compare_function/*__cmp_func_Cmpfun**/)FloatCompare);	cameraConstant 	= 	GetItemValue		(theDialogSearch,CAMERACONSTANT);	wavelength 	= 		GetItemValue		(theDialogSearch,WAVELENGTH);	for(i = 0; i < MAXEXPDSPACE; i++){		switch(searchTypePopUp->lastResult){			case DSPACE_SEARCH:			case VOL_SEARCH_D:			case USER_SEARCH_D:				dspacings[i] = currentList[i];				break;			case G_VECTOR_SEARCH:			case VOL_SEARCH_G:			case USER_SEARCH_G:				if(currentList[i] > 0.1)					dspacings[i] =  cameraConstant/currentList[i];				else 					dspacings[i] = -1.0;				break;			case TWO_THETA_SEARCH:			case USER_SEARCH_TWO:			case VOL_SEARCH_TWO:				if(currentList[i] > 0.01)					dspacings[i] =  wavelength / (2 * sin((PI/360) * currentList[i]));				else 					dspacings[i] = -1.0;				break;			default:				break;					}	}}short	SortListCrysByDecreasingValue(ListParameters* spot1,ListParameters* spot2){	short z1,z2;		z2 = (short)fabs((double)spot1->value);	z1 = (short)fabs((double)spot2->value);		return((short)((z1 < z2) ? -1 : ((z1 == z2) ? 0 : 1)));}short	SortListCrysByIncreasingValue(ListParameters* spot1,ListParameters* spot2){	short z1,z2;		z1 = (short)fabs((double)spot1->value);	z2 = (short)fabs((double)spot2->value);		return((short)((z1 < z2) ? -1 : ((z1 == z2) ? 0 : 1)));}