//s.Jim:Event/Memory:EV_SelectRect.c#include	"Diffract_INCs.h"#include	"SelectRect.h"//#include	"a_ImageObject.h"#include	"MenuDefs.h"Boolean IsWindowStill(WindowPtr	theWindow);SelectRect*			SelectRect::DoInit(WindowPtr	thisWindow){	theWindow = thisWindow;	SetRect(&theRect,0,0,0,0);	SetRect(&selectPictRect,-1,-1,1,1);	selectPict 		= OpenPicture(&selectPictRect);	dm_FrameRect(&selectPictRect);	ClosePicture();		lastClick.h = lastClick.v = 0;	isValid = false;	return(this);}Boolean			SelectRect::DoObjSelect(Point	thePoint){	Boolean	retValue;	lastClick = thePoint;	retValue = DoSelect(thePoint);	gCurrentObj->LocalRectToObj(&theRect);	return(retValue);}Boolean			SelectRect::DoSelect(Point	thePoint){	Point	startPoint,lastPoint,newPoint;	short	currentCursor;		currentCursor = gCurrentObj->theCursorID;	startPoint = lastPoint = thePoint;		PenSize(1,1);	if(isValid){		gCurrentObj->EraseTheFrame(&theRect);	}	isValid = false;	SetRect(&theRect,0,0,0,0);	Delay(12,&gLongScratch);	gCurrentObj->SetTheCursor(CROSS_CURSOR);		while(StillDown()){		gCurrentObj->DMForeColor(15);		GetMouse(&newPoint);		{			unsigned long	time;			SetMarqueePattern(NUL);			PenMode(patXor);			dm_FrameRect(&theRect);			Delay(2,&time);			dm_FrameRect(&theRect);		}		if(!EqualPt(newPoint,lastPoint)){			{				unsigned long	time;				SetMarqueePattern(NUL);				PenMode(patXor);				dm_FrameRect(&theRect);				Delay(2,&time);				dm_FrameRect(&theRect);			}			lastPoint = newPoint;			if(startPoint.h < lastPoint.h){				theRect.left 	= startPoint.h;				theRect.right 	= lastPoint.h;			} else {				theRect.right 	= startPoint.h;				theRect.left 	= lastPoint.h;			}			if(startPoint.v < lastPoint.v){				theRect.top 	= startPoint.v;				theRect.bottom 	= lastPoint.v;			} else {				theRect.bottom 	= startPoint.v;				theRect.top 	= lastPoint.v;			}			isValid = true;		}		gCurrentObj->DMForeColor(14);	}	PenNormal();	if(isValid){		EnableItem(GetMHandle(EDIT_MENU),CUT);		EnableItem(GetMHandle(EDIT_MENU),COPY);		EnableItem(GetMHandle(EDIT_MENU),PASTE);	} else {		DisableItem(GetMHandle(EDIT_MENU),CUT);		DisableItem(GetMHandle(EDIT_MENU),COPY);	}	gCurrentObj->SetTheCursor(currentCursor);	return	false;}	void			SelectRect::DoClose(void){	DoFrame();	if(selectPict != (PicHandle)NUL)/*dec 1992*/		KillPicture(selectPict);	D_delete(this);}void			SelectRect::DoObjFrame(void){	gCurrentObj->ObjRectToLocal(&theRect);	DoFrame();	gCurrentObj->LocalRectToObj(&theRect);}void			SelectRect::DoFrame(void){	//gCurrentObj->DMForeColor(15);	gCurrentObj->STDTheRectMarquee(&theRect);	//gCurrentObj->DMForeColor(14);}void			SelectRect::Reset(WindowPtr thisWindow){	GrafPtr	theOldPort;	DiffractObject	*theObj;	if(!thisWindow)return;	if(thisWindow != theWindow){		if(IsWindowStill(theWindow)){			GetPort(&theOldPort);			SetPort(theWindow);			theObj = (DiffractObject*)GetWRefCon(theWindow);			if(IsValidObj(theObj)){				theObj->EraseTheFrame(&theRect);			}			SetPort(theOldPort);		}		SetRect(&theRect,0,0,0,0);		theWindow = thisWindow;		isValid = false;		DisableItem(GetMHandle(EDIT_MENU),CUT);		DisableItem(GetMHandle(EDIT_MENU),COPY);	}}void		SelectRect::DoCopy(DiffractObject	*theObj){	PixMapHandle	thePixMap;	Point	*thePts;	Rect	tempRect,aRect;	if(FrontWindow() == theWindow){		if(IsValidObj(theObj)){			RgnHandle theRgn;			theObj->DMForeColor(1);			theObj->DMBackColor(0);					SetZone(SystemZone());			thePixMap = NewPixMap();			if(selectPict != (PicHandle)NUL)				KillPicture(selectPict);			tempRect = selectPictRect 	= theRect;			gCurrentObj->ObjRectToLocal(&tempRect);						InsetRect(&tempRect,1,1);			thePts = (Point*)&tempRect;			LocalToGlobal(&(thePts[0]));			LocalToGlobal(&(thePts[1]));			theRgn = D_NewRgn();			GetClip		(theRgn);			aRect = theWindow->portRect;			thePts = (Point*)&aRect;			LocalToGlobal(&(thePts[0]));			LocalToGlobal(&(thePts[1]));						RectRgn		(gTheRgn,&aRect);			D_SetClip		(gTheRgn);			selectPict 		= OpenPicture(&tempRect);									CopyBits(	(BitMap*)(*thePixMap),						(BitMap*)(*(((CGrafPtr)theWindow)->portPixMap)),						&tempRect,&tempRect,srcCopy,0L);					ClosePicture();			DisposPixMap(thePixMap);			SetZone(ApplicZone());			theObj->DMBackColor(BACKGROUND_COLOR);						D_SetClip(theRgn);			D_DisposeRgn(&theRgn);					}	}}	Boolean IsWindowStill(WindowPtr	theWindow){	WindowPtr thisWindow;		thisWindow = FrontWindow();	while(thisWindow != (WindowPtr)NUL){		if(thisWindow == theWindow)			return true;		thisWindow = (WindowPtr)(((WindowPeek)thisWindow)->nextWindow);	}	return false;}					