//s.Jim:Event/Memory:EV_InfoObject.c#include	"Diffract_INCs.h"#include 	"InfoObject.h"void	InfoObject::DoInit(short startValue){	short i;	ObjInfo	*thisEntry;	long	theSize;	num_Objs 	= 	0;	num_Obj_max = 	startValue;	objectID	=	0;	theSize		=	sizeof(ObjInfo) * num_Obj_max;	array = (ObjInfo**)NewHandle(theSize);	HLock((Handle)array);	thisEntry	=	*array;		for(i = 0; i <= 13;i++) stops[i] = -1;		for(i = 0 ; i < num_Obj_max ; i++,thisEntry++){		thisEntry->address 	= (Handle)NUL;		thisEntry->when 	= NUL;		thisEntry->objType 	= 0;		}	HUnlock((Handle)array);}void	InfoObject::TestNumObjects(void){		if(num_Objs != NUL){		char theText[40];		ObjectTitle(theText);		//g_Routine = theText;		strcpy(g_Routine,theText);		if(gShutdown)			return;		D_FlagUser(18);		ShowData();		if(gD_Handle_Debug_Flag){			gD_Handle_Debug_Flag = false;	 			 }}}void	InfoObject::AddObj(void* theInfo){	short		i;	ObjInfoPtr	thisEntry;	ObjInfoPtr	aEntry;/*	if(doBreaks){		for(i = 0 ; i <= 13 ; i++){				if(objectID == stops[i]){					gD_Handle_Debug_Flag = true;			}		}	}*/		if(num_Objs + 2 >= num_Obj_max){		num_Obj_max += 200;		SetHandleSize((Handle)array,num_Obj_max * sizeof(ObjInfo));		HLock((Handle)array);		aEntry	=	*array;		thisEntry = &aEntry[num_Obj_max - 200];		for(i = num_Obj_max - 200 ; i < num_Obj_max ; i++,thisEntry++){			thisEntry->address 	= (Handle)NUL;			thisEntry->when 	= NUL;			thisEntry->objType 	= 0;		}		HUnlock((Handle)array);	}	SetObjInfoValues(theInfo);	num_Objs++;}void	InfoObject::SetObjInfoValues(void* theInfo){	ObjInfo	*thisEntry;	HLock((Handle)array);	thisEntry 					= *array;	thisEntry[num_Objs].address	= (Handle)theInfo;	thisEntry[num_Objs].objType	= *((short*)theInfo);	thisEntry[num_Objs].when	= objectID++;	if(thisEntry[num_Objs].when == 147){		 objectID =  objectID;	}	HUnlock((Handle)array);	return;}void	InfoObject::RemoveObj(void* theInfo){	short		i;	ObjInfoPtr	thisEntry;	Boolean		flag = false;	HLock((Handle)array);	thisEntry = *array;	ValidObject(theInfo);	for(i = 0 ; i < num_Objs; i++,thisEntry++){		if(thisEntry->address == (Handle)theInfo || (flag && i < num_Objs - 1)){			thisEntry->address	= thisEntry[1].address;			thisEntry->objType	= thisEntry[1].objType;			thisEntry->when		= thisEntry[1].when;			flag = true;	}}	HUnlock((Handle)array);	num_Objs--;	if(num_Objs < 0)gD_Handle_Debug_Flag = true;}void	InfoObject::VerifyObjects(void){	short		i;	ObjInfoPtr	thisEntry;	short		*theObjType;//	char		*lastPointer;		return; /* 	this added because object type is no longer correct...				need to figure out how to determine the object type so this can work */	//	lastPointer = g_Routine;	HLock((Handle)array);	thisEntry = *array;	for(i = 0 ; i < num_Objs ; i++,thisEntry++){		if(thisEntry->address != (Handle)NUL){			theObjType	= (short*)thisEntry->address;			if(*theObjType != thisEntry->objType){				ObjectInfo(thisEntry,gTheText);				//g_Routine = gTheText;				strcpy(g_Routine,gTheText);				D_FlagUser(27);				if(gD_Handle_Debug_Flag){				 	gD_Handle_Debug_Flag = false;				 	SysBreak();			}		}	}}	//g_Routine = lastPointer;	HUnlock((Handle)array);}void	InfoObject::ShowData(void){	DialogPtr	theDialog;	short		start = 0,i,j,theSelect;	ObjInfoPtr theEntry;	Boolean		redo,hidden = true;	long		count = 0;		theDialog = GetNewDialog(9999,NUL,IN_FRONT);	SetPort(theDialog);		redo = true;	theSelect = 0;	SetObjWinTitle(theDialog);			GetDItem(theDialog,2,&gType,&gTheHandle,&gTheRect);	HiliteControl((ControlHandle)gTheHandle,255);	if(count < 9){		GetDItem(theDialog,1,&gType,&gTheHandle,&gTheRect);		HiliteControl((ControlHandle)gTheHandle,255);}		while(theSelect != -1){		switch(theSelect){			case 1:				if(start < (num_Objs - 12)){					start += 9;					redo = true;					if((start + 9) > num_Objs){						start = num_Objs - 8;						GetDItem(theDialog,1,&gType,&gTheHandle,&gTheRect);						HiliteControl((ControlHandle)gTheHandle,255);				}					GetDItem(theDialog,2,&gType,&gTheHandle,&gTheRect);					HiliteControl((ControlHandle)gTheHandle,0);			}				break;			case 2:				if(start > 0){					if(start > 9){						start -= 9;				} else {						start = 0;						GetDItem(theDialog,2,&gType,&gTheHandle,&gTheRect);						HiliteControl((ControlHandle)gTheHandle,255);				}					redo = true;					GetDItem(theDialog,1,&gType,&gTheHandle,&gTheRect);					HiliteControl((ControlHandle)gTheHandle,0);			}				break;			default:				break;	}	if(redo){			short k = 0;						redo = false;			HLock((Handle)array);			theEntry = &((*array)[start]);			for(i = start,k = 0, j = 4 ; k <= 9 && i < num_Objs; i++){																GetDItem(theDialog,j,&gType,&gTheHandle,&gTheRect);				sprintf(gTheText,"%ld",theEntry->when);				c2pstr(gTheText);				SetIText(gTheHandle,pTheText);								GetDItem(theDialog,j + 10,&gType,&gTheHandle,&gTheRect);				sprintf(gTheText,"%ld",(long)theEntry->address);				c2pstr(gTheText);				SetIText(gTheHandle,pTheText);				j++;				k++;				theEntry++;		}		HUnlock((Handle)array);	}		if(hidden){			hidden = false;			ShowWindow(theDialog);			DrawDialog(theDialog);	}		ModalDialog(SmallFilterUPP,&theSelect);}	DisposDialog(theDialog);}void	InfoObject::ValidObject(void*	theObject){	short		i;	ObjInfoPtr	thisEntry;//	char		*lastPointer;		//lastPointer = g_Routine;	HLock((Handle)array);	thisEntry = *array;	for(i = 0 ; i < num_Objs ; i++,thisEntry++){		if(thisEntry->address == theObject){			HUnlock((Handle)array);			return ;		}	}	HUnlock((Handle)array);	D_FlagUser(28);//	g_Routine = lastPointer;	if(gD_Handle_Debug_Flag){		gD_Handle_Debug_Flag = false; 		SysBreak(); } return;}void	InfoObject::ObjectTitle(char* theText){	sprintf(theText,"Objects Remaining = %d",(short)num_Objs);}void	InfoObject::SetBreaks(short theItem,short theBreak){	stops[theItem] = theBreak;}void InfoObject::ObjectInfo(ObjInfo* thisEntry,char* theText){	sprintf(theText,"Object number %3d .. type %5d",(short)thisEntry->when,(short)thisEntry->objType);}void InfoObject::SetObjWinTitle(DialogPtr theDialog){		SetWTitle(theDialog,"\pObjects Remaining");	}void InfoObject::DoClose(void){	DisposHandle((Handle)array);	delete(this);}Boolean InfoObject::FoundObj(void* theObj){	ObjInfo 	*theEntry;	short		i = 0;	theEntry = *array;	HLock((Handle)array);	while(i < num_Objs){		if(theEntry->address == (Handle)theObj){			HUnlock((Handle)array);			return true;		}		i++;		theEntry++;	}	HUnlock((Handle)array);	return false;}void	InfoObjectPtr::SetObjInfoValues(void* theInfo){	ObjInfo *thisEntry;	HLock((Handle)array);	thisEntry 					= *array;	thisEntry[num_Objs].address	= (Handle)theInfo;	thisEntry[num_Objs].objType	= 0;	thisEntry[num_Objs].when	= objectID++;	if(thisEntry[num_Objs].when == 147){		thisEntry[num_Objs].when = thisEntry[num_Objs].when;	}	HUnlock((Handle)array);	return;}void	InfoObjectPtr::ObjectTitle(char* theText){	sprintf(theText,"Pointers Remaining = %d",(short)num_Objs);}void InfoObjectPtr::ObjectInfo(ObjInfo* thisEntry,char* theText){	sprintf(theText,"Pointer number %3d",(short)thisEntry->when);}void InfoObjectPtr::SetObjWinTitle(DialogPtr theDialog){		SetWTitle(theDialog,"\pPointers Remaining");	}void	InfoObjectHdn::ObjectTitle(char* theText){	sprintf(theText,"Handles Remaining = %d",(short)num_Objs);}void InfoObjectHdn::ObjectInfo(ObjInfo* thisEntry,char* theText){	sprintf(theText,"Handle number %3d",(short)thisEntry->when);}void InfoObjectHdn::SetObjWinTitle(DialogPtr theDialog){		SetWTitle(theDialog,"\pHandles Remaining");	}void	InfoObjectMnbr::ObjectTitle(char* theText){	sprintf(theText,"Menubars Remaining = %d",(short)num_Objs);}void InfoObjectMnbr::ObjectInfo(ObjInfo* thisEntry,char* theText){	sprintf(theText,"Menubar number %3d",(short)thisEntry->when);}void InfoObjectMnbr::SetObjWinTitle(DialogPtr theDialog){		SetWTitle(theDialog,"\pMenubars Remaining");	}void	InfoObjectPic::ObjectTitle(char* theText){	sprintf(theText,"Pictures Remaining = %d",(short)num_Objs);}void InfoObjectPic::ObjectInfo(ObjInfo* thisEntry,char* theText){	sprintf(theText,"Picture number %3d",(short)thisEntry->when);}void InfoObjectPic::SetObjWinTitle(DialogPtr theDialog){		SetWTitle(theDialog,"\pPictures Remaining");	}void	InfoObjectRsrc::ObjectTitle(char* theText){	sprintf(theText,"Resources Remaining = %d",(short)num_Objs);}void InfoObjectRsrc::ObjectInfo(ObjInfo* thisEntry,char* theText){	sprintf(theText,"Resource number %3d",(short)thisEntry->when);}void InfoObjectRsrc::SetObjWinTitle(DialogPtr theDialog){		SetWTitle(theDialog,"\pResources Remaining");	}void	InfoObjectRgn::ObjectTitle(char* theText){	sprintf(theText,"Regions Remaining = %d",(short)num_Objs);}void InfoObjectRgn::ObjectInfo(ObjInfo* thisEntry,char* theText){	sprintf(theText,"Region number %3d",(short)thisEntry->when);}void InfoObjectRgn::SetObjWinTitle(DialogPtr theDialog){		SetWTitle(theDialog,"\pRegions Remaining");	}void	InfoObject::VerifyPtrs(void){	short		i;	ObjInfoPtr	thisEntry;	//char		*lastPointer;	Ptr			thePtr;	long    size;	short   error;	//lastPointer = g_Routine;	HLock((Handle)array);	thisEntry = *array;	for(i = 0 ; i < num_Objs ; i++,thisEntry++){		if(thisEntry->address != (Handle)NUL){			thePtr	= (Ptr)thisEntry->address;			if(thePtr == (Ptr)NUL){				D_FlagUser(10);		} else {				size = GetPtrSize((Ptr)thePtr);				error = MemError();				if(error != 0){					D_FlagUser(10);			} else if(size == NUL){					D_FlagUser(10);			}		}	}}	//g_Routine = lastPointer;	HUnlock((Handle)array);}void	InfoObject::VerifyHandles(void){	short		i;	ObjInfoPtr	thisEntry;	//char		*lastPointer;	short		error;	char		theHState;	Handle		theHandle;			//lastPointer = g_Routine;	HLock((Handle)array);	thisEntry = *array;	for(i = 0 ; i < num_Objs ; i++,thisEntry++){		if(thisEntry->address != (Handle)NUL){			theHandle = (Handle)thisEntry->address;			theHState = HGetState(theHandle);   /* Not Valid */			error = MemError();			if(error != 0){				D_FlagUser(8);				if(gD_Handle_Debug_Flag){				 	gD_Handle_Debug_Flag = false;				 	SysBreak();				 }						return;		}	}}	//g_Routine = lastPointer;	HUnlock((Handle)array);}