//s.Jim:Event/Memory:EV_NewFilter.c#include	"Diffract_INCs.h"/* pascal Boolean	(*theStdFilterProc)(DialogPtr,EventRecord*,short*); */ModalFilterUPP	theStdFilterProc;Boolean gDlogFilter(DialogPtr,EventRecord*,short*,Rect*);pascal Boolean TheFilter(DialogPtr theDLog,EventRecord* theEvent,short* theItem){	Boolean		retValue;	long			oldA5;	WindowPtr 	theWindow;	short			size;		DiffractObject *thisObject;	oldA5 = SetCurrentA5();	gTheEvent = *theEvent;	if(theEvent->what == updateEvt){						/* Switch on the event 			*/		size = (*((*(GetGDevice()))->gdPMap))->pixelSize;		theWindow = (WindowPtr)gTheEvent.message;		if(theWindow){			thisObject = (DiffractObject*)(((WindowPeek)theWindow)->refCon);			if(thisObject){				if(size != gLastPixelSize){					gLastPixelSize = size;					if(IsValidObj(thisObject))						thisObject->SetObjectDrawTransferMode();					else{						gDefault->SetObjectDrawTransferMode();					}				}								if(IsValidObj(thisObject)){					thisObject->refreshFlag = true;					thisObject->DoRefresh();				}			}			}		SetPort(theDLog);	}	#ifndef _DEMO_VERS_		if(gSecure != 17)			gQuitFlag = true;	#endif	retValue = (Boolean)gDlogFilter(theDLog,theEvent,theItem,&gScreenSize);	oldA5 = SetA5(oldA5);	/*gQuitFlag = false;copy protect*/	/*gShutdown = false;copy protect*/	return(retValue);}/*   The old filter proc   */Boolean gDlogFilter(DialogPtr theDLog,EventRecord* theEvent,short* theItem,Rect* screenSize){	char			theChar;	Rect 			theRect;	long 			menuValue;	unsigned long time;	short 			item,theMenu,type,windowCode;	OSErr			theError;	Point 			thePoint;	Boolean			doneByStd;	WindowPtr 		theWindow;	ControlHandle	whichControl;					thePoint 	= theEvent->where;											/* Save the event Point */	*theItem 	= 0;		if(gAppleEvtsOK){		theError	= GetStdFilterProc(&theStdFilterProc);		doneByStd 	= CallModalFilterProc(theStdFilterProc,theDLog,theEvent,theItem);	} else {		doneByStd = false;	}		if(theEvent->what == keyDown){											/* traps Enter key for list input */		theChar = theEvent->message &  charCodeMask;		if(theChar == 0x03){			*theItem = -20;			return(true);		}		if(doneByStd){			return true;		}		if(theChar == 0x0D){			GetDItem(theDLog,1,&gType,&gTheHandle,&gTheRect);			if((*((ControlHandle)gTheHandle))->contrlHilite == 0){				*theItem = 1;				HiliteControl((ControlHandle)gTheHandle,1);				Delay(8L,&time);				HiliteControl((ControlHandle)gTheHandle,0);				return true;			}		}	}		switch(theEvent->what){													/* Switch on the event 			*/		case updateEvt:							SetPort(theDLog);						//BeginUpdate(theDLog);						//UpdtDialog(theDLog,theDLog->visRgn);			//if(!gAppleEvtsOK){			//	HiliteOK(theDLog);			//}			//EndUpdate(theDLog);			*theItem = -4;			return (true);			break;				case mouseDown:														/* if event was a mousedown 	*/			windowCode = FindWindow(theEvent->where,&theWindow);																switch (windowCode){											/* find out where it occured */				case inGoAway:												/* if in the go away box 	 */					if(TrackGoAway(theWindow,theEvent->where)){				/* And mouse up still in it  */						*theItem = -1;										/* set Go away flag			 */						return (true);										/* return true to bypass     */					}															/* ModalDialog               */					break;				case inZoomIn:		/* volume 4 pg 51 */				case inZoomOut:					if(TrackBox(theWindow,theEvent->where,windowCode)){						ZoomWindow(theWindow,windowCode,true);					}					return (false);					break;				case inContent:												/* if in content region      */					GlobalToLocal(&thePoint);								/* Convert to local coords	 */					*theItem = FindDItem(theDLog,thePoint) + 1;					GetDItem(theDLog,*theItem,&type,(Handle*)&whichControl,&theRect);					switch(type){						case 7:							switch(FindControl(thePoint,theWindow,&whichControl)){	/* Switch on  part   */								case 20: 								case 21:										/* if a scroll bar part  */								case 22:								case 23:									return(true);							/* Bypass ModalDialog    */									break;								default:									gTheEvent.where.h = gTheEvent.where.v = -12345;									return(false);									break;							}							break;						case picItem:										/* pict ... return true */							((WindowPeek)theDLog)->refCon = theEvent->modifiers;							return(true);							break;						default:							if(*theItem == 0){								*theItem = -100;								return(true);							}							return(false);							break;					}					return(false);					break;				case inMenuBar:					menuValue  = MenuSelect(theEvent->where);					((WindowPeek)theDLog)->refCon  = menuValue;					item = LoWord(menuValue);					theMenu = HiWord(menuValue);					HiliteMenu(theMenu);					*theItem = -2;					if(theMenu == EDIT_MENU){						if(SystemEdit(item - 1)){							HiliteMenu(0);							*theItem = 0;							return(true);						}													switch(item){							case 1:								break;							case 3:								DlgCut(theDLog);								break;							case 4:								DlgCopy(theDLog);								break;							case 5:								DlgPaste(theDLog);								break;							case 6:								DlgDelete(theDLog);								break;							default:								break;						}						*theItem = 0;						return (true);					}					return(true);					break;									case inDrag:					theRect = *screenSize;					InsetRect(&theRect,4,4);					DragWindow(theWindow,theEvent->where,&theRect);					SelectWindow(theDLog);					*theItem = -3;					return(true);					break;									case inSysWindow:					SystemClick(theEvent,theWindow);					*theItem = 0;					return(true);					break;				default:					return(false);					break;			}		case keyDown:			theChar = theEvent->message &  charCodeMask;			if(theEvent->modifiers & optionKey){				switch(theChar){					case 'Á':						theEvent->message = (theEvent->message & 0xff00) + 218;						break;					case 'ª':						theEvent->message = (theEvent->message & 0xff00) + 219;						break;					case '£':						theEvent->message = (theEvent->message & 0xff00) + 220;						break;					case '¢':						theEvent->message = (theEvent->message & 0xff00) + 221;						break;					case '°':						theEvent->message = (theEvent->message & 0xff00) + 222;						break;					case '¤':						theEvent->message = (theEvent->message & 0xff00) + 223;						break;					case '¦':						theEvent->message = (theEvent->message & 0xff00) + 224;						break;					case '¥':						theEvent->message = (theEvent->message & 0xff00) + 245;						break;					case '»':						theEvent->message = (theEvent->message & 0xff00) + 225;						break;					default:						break;				}				return false;				break;			}				if(theEvent->modifiers & cmdKey){				menuValue = MenuKey(theChar);				((WindowPeek)theDLog)->refCon  = menuValue;				item = LoWord(menuValue);				theMenu = HiWord(menuValue);				HiliteMenu(theMenu);				*theItem = -2;				if(theMenu == EDIT_MENU){						if(SystemEdit(item - 1)){						*theItem = 0;						HiliteMenu(0);						return(true);					}					switch(item){						case 1:							break;						case 3:							DlgCut(theDLog);							break;						case 4:							DlgCopy(theDLog);							break;						case 5:							DlgPaste(theDLog);							break;						case 6:							DlgDelete(theDLog);							break;						default:							break;					}					HiliteMenu(0);					*theItem = 0;					return (true);				}				return(true);			}			return(false);			break;					case app1Evt:			*theItem = -10;			return(true);			break;		default:			return(false);			break;	}	return(false);}pascal Boolean MLogFilter(DialogPtr theDLog,EventRecord* theEvent,short* theItem){	WindowPtr 		theWindow;	ControlHandle	whichControl;	GrafPtr			thePort;	DiffractObject *thisObject;		char				theChar;	Rect 				theRect;	long 				menuValue,oldA5;	unsigned long	time;	short 			item,theMenu,type,windowCode;	Point 			thePoint;		short				size;				oldA5 			= SetCurrentA5();	gTheEvent 		= *theEvent;	if(theEvent->what == updateEvt){						/* Switch on the event 			*/		//gCurrentObj->refreshFlag = true;		//gCurrentObj->DoRefresh();		size = (*((*(GetGDevice()))->gdPMap))->pixelSize;		theWindow = (WindowPtr)gTheEvent.message;		if(theWindow){			thisObject = (DiffractObject*)(((WindowPeek)theWindow)->refCon);			if(thisObject){				if(size != gLastPixelSize){					gLastPixelSize = size;					if(IsValidObj(thisObject))						thisObject->SetObjectDrawTransferMode();					else{						gDefault->SetObjectDrawTransferMode();					}				}								if(IsValidObj(thisObject)){					thisObject->refreshFlag = true;					thisObject->DoRefresh();				}			}			}	}	SetPort(theDLog);	#ifndef _DEMO_VERS_	if(gSecure != 17)		gQuitFlag = true;	#endif	oldA5 = SetA5(oldA5);																thePoint 	= theEvent->where;											/* Save the event Point */	*theItem 	= 0;			if(theEvent->what == keyDown){											/* traps Enter key for list input */		theChar = theEvent->message &  charCodeMask;		if(theChar == 0x03 || theChar == 0x0D){			*theItem = -20;			oldA5 = SetA5(oldA5);			return(true);		}				if(theChar == 0x0D){			GetDItem(theDLog,1,&gType,&gTheHandle,&gTheRect);			if((*((ControlHandle)gTheHandle))->contrlHilite == 0){				*theItem = 1;				HiliteControl((ControlHandle)gTheHandle,1);				Delay(8L,&time);				HiliteControl((ControlHandle)gTheHandle,0);				oldA5 = SetA5(oldA5);				return true;			}		}	}		switch(theEvent->what){													/* Switch on the event 			*/		case updateEvt:				//SetPort(theDLog);			//BeginUpdate(theDLog);			//UpdtDialog(theDLog,theDLog->visRgn);			//EndUpdate(theDLog);			*theItem = -4;			oldA5 = SetA5(oldA5);			return (true);			break;				case mouseDown:														/* if event was a mousedown 	*/			windowCode = FindWindow(theEvent->where,&theWindow);																switch (windowCode){											/* find out where it occured */				case inGoAway:												/* if in the go away box 	 */					if(TrackGoAway(theWindow,theEvent->where)){				/* And mouse up still in it  */						*theItem = -1;										/* set Go away flag			 */						oldA5 = SetA5(oldA5);						return (true);										/* return true to bypass     */					}															/* ModalDialog               */					break;				case inZoomIn:		/* volume 4 pg 51 */				case inZoomOut:					if(TrackBox(theWindow,theEvent->where,windowCode)){						ZoomWindow(theWindow,windowCode,true);					}					oldA5 = SetA5(oldA5);					return (false);					break;				case inContent:												/* if in content region      */					GlobalToLocal(&thePoint);								/* Convert to local coords	 */					*theItem = FindDItem(theDLog,thePoint) + 1;					GetDItem(theDLog,*theItem,&type,(Handle*)&whichControl,&theRect);					switch(type){						case 7:							switch(FindControl(thePoint,theWindow,&whichControl)){	/* Switch on  part   */								case 20: 								case 21:										/* if a scroll bar part  */								case 22:								case 23:									oldA5 = SetA5(oldA5);									return(true);							/* Bypass ModalDialog    */									break;								default:									gTheEvent.where.h = gTheEvent.where.v = -12345;									oldA5 = SetA5(oldA5);									return(false);									break;							}							break;						case picItem:										/* pict ... return true */							((WindowPeek)theDLog)->refCon = theEvent->modifiers;							oldA5 = SetA5(oldA5);							return(true);							break;						default:							if(*theItem == 0){								*theItem = -100;								oldA5 = SetA5(oldA5);								return(true);							}							oldA5 = SetA5(oldA5);							return(false);							break;					}					oldA5 = SetA5(oldA5);					return(false);					break;				case inMenuBar:					menuValue  = MenuSelect(theEvent->where);					((WindowPeek)theDLog)->refCon  = menuValue;					item = LoWord(menuValue);					theMenu = HiWord(menuValue);					HiliteMenu(theMenu);					*theItem = -2;					if(theMenu == EDIT_MENU){						if(SystemEdit(item - 1)){							HiliteMenu(0);							*theItem = 0;							oldA5 = SetA5(oldA5);							return(true);						}													switch(item){							case 1:								break;							case 3:								DlgCut(theDLog);								break;							case 4:								DlgCopy(theDLog);								break;							case 5:								DlgPaste(theDLog);								break;							case 6:								DlgDelete(theDLog);								break;							default:								break;						}						*theItem = 0;						oldA5 = SetA5(oldA5);						return (true);					}					oldA5 = SetA5(oldA5);					return(true);					break;									case inDrag:					GetWMgrPort(&thePort);					theRect = thePort->portRect;;					InsetRect(&theRect,4,4);					DragWindow(theWindow,theEvent->where,&theRect);					SelectWindow(theDLog);					*theItem = -3;					oldA5 = SetA5(oldA5);					return(true);					break;									case inSysWindow:					SystemClick(theEvent,theWindow);					*theItem = 0;					oldA5 = SetA5(oldA5);					return(true);					break;				default:					oldA5 = SetA5(oldA5);					return(false);					break;			}		case keyDown:			theChar = theEvent->message &  charCodeMask;			if(theEvent->modifiers & optionKey){				switch(theChar){					case 'Á':						theEvent->message = (theEvent->message & 0xff00) + 218;						break;					case 'ª':						theEvent->message = (theEvent->message & 0xff00) + 219;						break;					case '£':						theEvent->message = (theEvent->message & 0xff00) + 220;						break;					case '¢':						theEvent->message = (theEvent->message & 0xff00) + 221;						break;					case '°':						theEvent->message = (theEvent->message & 0xff00) + 222;						break;					case '¤':						theEvent->message = (theEvent->message & 0xff00) + 223;						break;					case '¦':						theEvent->message = (theEvent->message & 0xff00) + 224;						break;					case '¥':						theEvent->message = (theEvent->message & 0xff00) + 245;						break;					case '»':						theEvent->message = (theEvent->message & 0xff00) + 225;						break;					default:						break;				}				oldA5 = SetA5(oldA5);				return false;				break;			}				if(theEvent->modifiers & cmdKey){				menuValue = MenuKey(theChar);				((WindowPeek)theDLog)->refCon  = menuValue;				item = LoWord(menuValue);				theMenu = HiWord(menuValue);				HiliteMenu(theMenu);				*theItem = -2;				if(theMenu == EDIT_MENU){						if(SystemEdit(item - 1)){						*theItem = 0;						HiliteMenu(0);						oldA5 = SetA5(oldA5);						return(true);					}					switch(item){						case 1:							break;						case 3:							DlgCut(theDLog);							break;						case 4:							DlgCopy(theDLog);							break;						case 5:							DlgPaste(theDLog);							break;						case 6:							DlgDelete(theDLog);							break;						default:							break;					}					HiliteMenu(0);					*theItem = 0;					oldA5 = SetA5(oldA5);					return (true);				}				oldA5 = SetA5(oldA5);				return(true);			}			oldA5 = SetA5(oldA5);			return(false);			break;					case app1Evt:			*theItem = -10;			oldA5 = SetA5(oldA5);			return(true);			break;		default:			oldA5 = SetA5(oldA5);			return(false);			break;	}	oldA5 = SetA5(oldA5);	return(false);}