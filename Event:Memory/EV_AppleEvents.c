//s.Jim:Event/Memory:EV_AppleEvents.c/*#include <AppleEvents.h>#include <Controls.h>#include <Desk.h>#include <Devices.h>#include <Dialogs.h>#include <Events.h>#include <Files.h>#include <Fonts.h>#include <Lists.h>#include <Types.h>#include <Memory.h>#include <Menus.h>#include <OSUtils.h>#include <Packages.h>#include <Palettes.h>#include <PrintTraps.h>#include <Quickdraw.h>#include <Resources.h>#include <Scrap.h>#include <SegLoad.h>#include <Serial.h>#include <Slots.h>#include	<shutdown.h>#include	<THINK.h>#include	<Gestalt.h>#include	<oops.h>/*  SoundMgr adds in Sane which kills FP compiles#include <SoundDvr.h>#include <StandardFile.h>#include <TextEdit.h>#include <ToolUtils.h>#include <Retrace.h>#include <Windows.h>#include <asm.h>#include <pascal.h>#include <unix.h>#include <string.h>#include <stdlib.h>#include <math.h>#include	<Sound.h>*/#include	"Diffract_INCs.h"#include	"AppleEvents.h"#include	"MenuDefs.h"OSErr	InstallAppleEvents(void);pascal	OSErr	HandleOApp(AppleEvent *theAppleEvent,AppleEvent* reply,long handlerRefcon);pascal	OSErr	HandleODoc(AppleEvent *theAppleEvent,AppleEvent* reply,long handlerRefcon);pascal	OSErr	HandlePDoc(AppleEvent *theAppleEvent,AppleEvent* reply,long handlerRefcon);pascal	OSErr	HandleQuit(AppleEvent *theAppleEvent,AppleEvent* reply,long handlerRefcon);void	DoFileOpen(FSSpec		*theFss);OSErr	InstallAppleEvents(void){	OSErr	theError,tempError;		tempError = noErr;	HandleOAppUPP	= NewAEEventHandlerProc(HandleOApp);	HandleODocUPP	= NewAEEventHandlerProc(HandleODoc);	HandlePDocUPP	= NewAEEventHandlerProc(HandlePDoc);	HandleQuitUPP	= NewAEEventHandlerProc(HandleQuit);		tempError = AEInstallEventHandler(	kCoreEventClass,										kAEOpenApplication,										HandleOAppUPP,										0,										false);	if(tempError != noErr)		theError = tempError;		tempError = AEInstallEventHandler(	kCoreEventClass,										kAEOpenDocuments,										HandleODocUPP,										0,										false);	if(tempError != noErr)		theError = tempError;		tempError = AEInstallEventHandler(	kCoreEventClass,										kAEPrintDocuments,										HandlePDocUPP,										0,										false);	if(tempError != noErr)		theError = tempError;		tempError = AEInstallEventHandler(	kCoreEventClass,										kAEQuitApplication,										HandleQuitUPP,										0,										false);	if(tempError != noErr){		theError = tempError;	}		return(theError);}pascal	OSErr	HandleOApp(AppleEvent *theAppleEvent,AppleEvent* reply,long handlerRefcon){	OSErr		theError;	AEKeyword	missedKeyword;	DescType	ignoredActualType;	Size		ignoredActualSize;	AppleEvent*	dummy;	long		dummy1;		dummy 	= 	reply; /* this line suppresses a warning */	dummy1	=	handlerRefcon;		theError = AEGetAttributePtr(	theAppleEvent,									keyMissedKeywordAttr,									typeWildCard,									&ignoredActualType,									(Ptr)&missedKeyword,									sizeof(AEKeyword),									&ignoredActualSize);											if(theError != noErr){			/* there is some lost data */		return(errAEParamMissed);	}		return(noErr);}pascal	OSErr	HandleODoc(AppleEvent *theAppleEvent,AppleEvent* reply,long handlerRefcon){	OSErr		theError;	AEKeyword	keyword;	DescType	typeCode;	Size		actualSize;	FSSpec		theFss;	AEDescList	docList;	long		index,itemsInList,oldA5;	AppleEvent*	dummy;	long		dummy1;		dummy 	= 	reply; /* this line suppresses a warning */	dummy1	=	handlerRefcon;			theError = AEGetParamDesc(theAppleEvent,keyDirectObject,typeAEList,&docList);		if(theError != noErr)		return(theError);				theError = AEGetAttributePtr(	theAppleEvent,									'miss',									typeWildCard,									&typeCode,									(Ptr)&keyword,									sizeof(AEKeyword),									&actualSize);		if(theError == noErr){			/* there is some lost data */		return(errAEParamMissed);	}		theError = AECountItems(&docList,&itemsInList);	for(index = 1 ; index <= itemsInList ; index++){		theError = AEGetNthPtr(	&docList,								index,								typeFSS,								&keyword,								&typeCode,								(Ptr)&theFss,								sizeof(FSSpec),								&actualSize);		oldA5 = SetCurrentA5();		DoFileOpen(&theFss);		oldA5 = SetA5(oldA5);	}	theError = AEDisposeDesc(&docList);	return(noErr);}									pascal	OSErr	HandlePDoc(AppleEvent *theAppleEvent,AppleEvent* reply,long handlerRefcon){	OSErr			theError;	AEKeyword		keyword;	DescType		typeCode;	Size			actualSize;	FSSpec			theFss;	AEDescList		docList;	long			index,itemsInList,oldA5;	DiffractObject*	theObject;	AppleEvent*	 	dummyreply;	long 			dummyhandlerRefcon;		dummyreply = reply; 				/* This line suppresses a warning */	dummyhandlerRefcon = handlerRefcon;	/* This line suppresses a warning */		theError = AEGetParamDesc(theAppleEvent,keyDirectObject,typeAEList,&docList);	if(theError != noErr)		return(theError);				theError = AEGetAttributePtr(	theAppleEvent,									'miss',									typeWildCard,									&typeCode,									(Ptr)&keyword,									sizeof(AEKeyword),									&actualSize);		if(theError == noErr){			/* there is some lost data */		return(errAEParamMissed);	}		theError = AECountItems(&docList,&itemsInList);		for(index = 1 ; index <= itemsInList ; index++){		theError = AEGetNthPtr(	&docList,								index,								typeFSS,								&keyword,								&typeCode,								(Ptr)&theFss,								sizeof(FSSpec),								&actualSize);		oldA5 = SetCurrentA5();		if(gCurrentObj->isCalculating){			SysBeep(15);		} else {			WindowPtr	theWindow;			DoFileOpen(&theFss);			theWindow = FrontWindow();			if(theWindow != (WindowPtr)NUL){				theObject = (DiffractObject*)(GetWRefCon(theWindow));				if(IsValidObj(theObject)){					theObject->DoIdle();					theObject->DoPrint();					CloseTheObject(theObject->theWindow);					oldA5 = SetA5(oldA5);				}			}		}	}	theError = AEDisposeDesc(&docList);	return(noErr);}								pascal	OSErr	HandleQuit(AppleEvent *theAppleEvent,AppleEvent* reply,long handlerRefcon){	OSErr		theError;	AEKeyword	missedKeyword;	DescType	ignoredActualType;	Size		ignoredActualSize;	AppleEvent*	dummy;	long		dummy1;		dummy 	= 	reply; /* this line suppresses a warning */	dummy1	=	handlerRefcon;		theError = AEGetAttributePtr(	theAppleEvent,									'miss',									typeWildCard,									&ignoredActualType,									(Ptr)&missedKeyword,									sizeof(AEKeyword),									&ignoredActualSize);		if(theError == noErr){			/* there is some lost data */		return(errAEParamMissed);	}	gCurrentObj->DoMenu((((long)FILE_MENU) << 16) + QUIT);	return(noErr);}void	DoFileOpen(FSSpec		*theFss){	FInfo	theFndrInfo;	short 	theErr;		theErr	= FSpGetFInfo(theFss,&theFndrInfo);	gTheFile->theFileInfo.sfFile = *theFss;	gTheFile->theFileInfo.sfGood = true;	gTheFile->theFileInfo.sfType = theFndrInfo.fdType;	if(theFndrInfo.fdType == 'PICT'){		AlertUser(4);		return;	} else if(theFndrInfo.fdType == 'Phas'){		AlertUser(5);		return;	} else if(theFndrInfo.fdType == 'INIT'){		AlertUser(6);		return;	}	gCurrentObj->DoOpen(true);	return;}