//C_UserDefAtoms.c#include	"Diffract_INCs.h"ListHandle	theFracOcList;enum {	SET_NUM_ATOMS = 3,		THE_CHECK_BOX,		THE_LIST_DATA,		THE_LIST_RECT,		THE_SCROLL_BAR	};void			UserDefAtom::DoInit(void){	lastAtom = 0;	theElements[0].atomicNum	=	104;	theElements[0].percent		=	100.0;		return;}void			UserDefAtom::DoClose(void){	if((long)this == NUL)		return;	D_delete(this);}Boolean		UserDefAtom::CopyUDAtom(UserDefAtom* theUDAtom){	short i;	long theSize;	if(theUDAtom == this)		return true;	theSize = (lastAtom + 1) * sizeof(AtomInfo);	theUDAtom->lastAtom		= lastAtom;		for(i = 0 ; i <= lastAtom ; i++){		theUDAtom->theElements[i] = theElements[i];	}	return true;}	Boolean			UserDefAtom::DoDefine(void){	DialogPtr 		theDialog;	Rect			theRect;	short			type,theSelect,length,i;	Cell			theCell;	unsigned long			time;	Boolean			dblClick;	Handle			theHandle;	Boolean quit=false,changed = false,retValue=false;		theDialog = DM_GetNewDialog(FRAC_OCCUPANCY_DEF,NUL,IN_FRONT);	InitUDList(theDialog);	DisplayUDAtom();	//HiliteOK(theDialog);	sprintf(gTheText,"%4.1f",theElements[0].percent);	c2pstr(gTheText);	GetDItem(theDialog,THE_LIST_DATA,&type,&theHandle,&theRect);	gTheDefMatrix->GetAtomicSymbol(theElements[0].atomicNum,gTheText);	SetIText(theHandle,c2pstr(gTheText));	SelIText(theDialog,THE_LIST_DATA,0,32767);	while(!quit){		ModalDialog(TheFilterUPP,&theSelect);		switch(theSelect){			case	DLOG_GO_AWAY:			case	DLOG_CANCEL:				if(!changed || CANCEL_YOUR_MODS){					quit 		= true;				}				break;			case	DLOG_OK:				retValue	=	quit = true;				for(i = 0 ; i <= lastAtom ; i++){					if(theElements[i].atomicNum >= 104 && theElements[i].atomicNum < 140){						retValue	=	quit = false;						StopAlert(ATOMS_NOT_DEFINED,0L);						i = lastAtom;					}				}				break;			case	SET_NUM_ATOMS:				SetNumAtoms();				KillUDList();				InitUDList(theDialog);				DisplayUDAtom();				changed = true;				break;			case	DLOG_ENTER_KEY:				GetDItem(theDialog,THE_CHECK_BOX,&type,&gTheHandle,&theRect);				HiliteControl((ControlHandle)gTheHandle,1);				Delay(8L,&time);				HiliteControl((ControlHandle)gTheHandle,0);  /*  !!!!  NO BREAK  !!!  */			case	THE_CHECK_BOX:				theCell.h	= theCell.v	= 0;				if(LGetSelect(true,&theCell,theFracOcList))					DoCellUpdate(theDialog,theCell);				break;				changed = true;				break;							case 	THE_LIST_DATA:				break;			case	THE_LIST_RECT:				GlobalToLocal(&(gTheEvent.where));				dblClick = LClick(gTheEvent.where,gTheEvent.modifiers,theFracOcList);				theCell = LLastClick(theFracOcList);				if(theCell.v > lastAtom)					break;								length = 10;				LGetCell(&(gTheText[1]),&length,theCell,theFracOcList);				gTheText[0] = (char)length;				GetDItem(theDialog,THE_LIST_DATA,&type,&gTheHandle,&theRect);				SetIText(gTheHandle,pTheText);				SelIText(theDialog,THE_LIST_DATA,0,length);				break;			case 	THE_SCROLL_BAR:				GlobalToLocal(&(gTheEvent.where));				dblClick = LClick(gTheEvent.where,gTheEvent.modifiers,theFracOcList);				break;			case ML_UPDATE_EVT:					BeginUpdate(theDialog);				UpdtDialog(theDialog,theDialog->visRgn);				if(!gAppleEvtsOK){					HiliteOK(theDialog);				}				EndUpdate(theDialog);				break;				default:				break;		}	}	DM_DisposDialog(&theDialog);	return(retValue);}void			UserDefAtom::SetNumAtoms(void){	DialogPtr		theDialog;	Handle			theHandle;	short 			type,theSelect,num_Elements,i;	Rect				theRect;	Boolean			changed,quit;			changed	= quit	= false;	theDialog = DM_GetNewDialog(DLOG_SET_NUM_ATOMS,NUL,IN_FRONT);	GetDItem	(theDialog,4,&type,&theHandle,&theRect);	sprintf		(gTheText,"Number of atoms occupying this site:");	c2pstr(gTheText);	SetItemText( theDialog,4,pTheText);	SetItemValue( theDialog,3,(double)(lastAtom + 1),0);	SelIText(theDialog,3,0,4);		while(!quit){		ModalDialog(TheFilterUPP,&theSelect);		switch(theSelect){			case	DLOG_GO_AWAY:			case	DLOG_CANCEL:				if(!changed || CANCEL_YOUR_MODS){					quit 		= true;				}				break;							case	DLOG_OK:			case 	DLOG_ENTER_KEY:				num_Elements	= (short)GetItemValue( theDialog,3);				if(num_Elements < 1)					num_Elements = 1;								if(num_Elements > 10)					num_Elements = 10;				num_Elements--;								for(i = lastAtom + 1 ; i <= num_Elements ; i++){					theElements[i] = theElements[lastAtom];				}				lastAtom	= num_Elements;				quit 		= true;				break;							case 3:				changed = true;				break;			case ML_UPDATE_EVT:					BeginUpdate(theDialog);				UpdtDialog(theDialog,theDialog->visRgn);				if(!gAppleEvtsOK){					HiliteOK(theDialog);				}				EndUpdate(theDialog);				break;				default:				break;		}	}	DM_DisposDialog(&theDialog);	return;}void			UserDefAtom::InitUDList(DialogPtr theDialog){	FontInfo 		theFont;	short			textHeight,type;	Point			cellSize;	Rect			theRect,rBounds;		GetFontInfo(&theFont);		textHeight 	= theFont.ascent 						+ theFont.descent 						+ theFont.leading;		GetDItem(theDialog,THE_LIST_RECT,&type,&gTheHandle,&theRect);	dm_EraseRect(&theRect);	SetRect(&rBounds,0,0,5,lastAtom + 1);	cellSize.h = (theRect.right - theRect.left) / 2;	cellSize.v = textHeight;	theFracOcList = LNew(&theRect,&rBounds,cellSize,0,theDialog,true,false,false,true);	(*theFracOcList)->selFlags = 0x80;	InsetRect(&theRect,-1,-1);	type = 40;	theRect.left -= type;	dm_FrameRect(&theRect);	return;}void			UserDefAtom::DisplayUDAtom(void){	short i,j;	Boolean flag;	Cell theCell;		for(i = 0 ; i <= lastAtom ; i++){		theCell.v = i;		for(j = 0 ; j <= 4 ; j++){			theCell.h = j;			switch(j){				case 0:					if(theElements[i].atomicNum == 104) theElements[i].atomicNum = 29;					flag = gTheDefMatrix->GetAtomicSymbol(theElements[i].atomicNum,gTheText);					break;				case 1:					sprintf(gTheText,"%4.1f",theElements[i].percent);					break;			}			c2pstr(gTheText);			LSetCell(&(gTheText[1]),(short)(gTheText[0]),theCell,theFracOcList);		}	}	return;}void			UserDefAtom::KillUDList(void){		LDispose(theFracOcList);	return;}enum { 	ELEMENT,		PERCENT	};void		UserDefAtom::DoCellUpdate(DialogPtr	theDialog,Cell	theCell){	short	length,type;	Rect	theRect;	Boolean flag;		if(theCell.v < 0)		return;	GetDItem(theDialog,THE_LIST_DATA,&type,&gTheHandle,&theRect);	GetIText(gTheHandle,pTheText);	length = (short)gTheText[0];	p2cstr(pTheText);	switch(theCell.h){		case ELEMENT:			theElements[theCell.v].atomicNum = gTheDefMatrix->TheAtomicNum(gTheText);			if(theElements[theCell.v].atomicNum > 104 && theElements[theCell.v].atomicNum < 199)				theElements[theCell.v].atomicNum = 104;			flag = gTheDefMatrix->GetAtomicSymbol(theElements[theCell.v].atomicNum,gTheText);			LSetCell(gTheText,2,theCell,theFracOcList);			LSetSelect(false,theCell,theFracOcList);			if(flag){				theCell.v += 1;				if(theCell.v > lastAtom)					theCell.v = 0;			} else {				SysBeep(30);			}			break;		case PERCENT:			theElements[theCell.v].percent = atof(gTheText);			sprintf(gTheText,"%4.1f",theElements[theCell.v].percent);			LSetCell(gTheText,2,theCell,theFracOcList);			LSetSelect(false,theCell,theFracOcList);			theCell.v += 1;			if(theCell.v > lastAtom)				theCell.v = 0;			break;		default:			break;	}	LSetSelect(true,theCell,theFracOcList);	LAutoScroll(theFracOcList);	length	=	20;	LGetCell(&(gTheText[1]),&length,theCell,theFracOcList);	gTheText[0] = (char)length;	GetDItem(theDialog,THE_LIST_DATA,&type,&gTheHandle,&theRect);	SetIText(gTheHandle,pTheText);	SelIText(theDialog,THE_LIST_DATA,0,length);}void		UserDefAtom::FileReadUserDef(void){	lastAtom = gTheFile->ReadShort();			gTheFile->ReadDataBlock((Ptr)theElements,sizeof(AtomInfo) * 10);	}void		UserDefAtom::FileWriteUserDef(void){	gTheFile->WriteShort(lastAtom);	gTheFile->WriteDataBlock((Ptr)theElements,sizeof(AtomInfo) * 10);}void			UserDefAtom::TextUDAtom(short elementNo,short *theLeft,short *theTop){	short 		i,j;	short 		theHor,theVer;	Boolean 	flag;	char 		*theText;	short 		charHeight12 = 14;	FontInfo 	theFont;		GetFontInfo(&theFont);	charHeight12 = theFont.ascent + theFont.descent + theFont.leading;		theHor = *theLeft;	theVer = *theTop;	MoveTo(theHor,theVer);	theText = (char*)D_NewPtr(255 * sizeof(char));	flag = gTheDefMatrix->GetAtomicSymbol(elementNo,theText);	sprintf(gTheText,"User Defined Atom: ");	strcat(gTheText,theText);	DrawString(c2pstr(gTheText));		theVer += charHeight12;		MoveTo(theHor,theVer);	sprintf(gTheText," Element   Occupancy");	DrawString(c2pstr(gTheText));	theVer += charHeight12;		for(i = 0 ; i <= lastAtom ; i++){		short atomicNum;		for(j = 0 ; j <= 1 ; j++){			switch(j){				case 0:					atomicNum = theElements[i].atomicNum;					if(atomicNum > 104  && atomicNum < 200) atomicNum = 29;					flag = gTheDefMatrix->GetAtomicSymbol(atomicNum,gTheText);					break;				case 1:					MoveTo(theHor,theVer);					sprintf(theText,"  ............  %4.1f",theElements[i].percent);					strcat(gTheText,theText);					DrawString(c2pstr(gTheText));					theVer += charHeight12;					break;			}		}	}	theVer += charHeight12 + 4;	*theTop = theVer;	KillPtr(theText);	return;}