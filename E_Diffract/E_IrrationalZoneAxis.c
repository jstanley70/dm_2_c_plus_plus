//s.Jim:E_Diffract:E_IrrationalZoneAxis.c#include	"Diffract_INCs.h"#include	"ST_StereoMacros.c"#include	"UT_VectorMacros.c"Boolean SpotExists(double theX,double theY,double testIntensity);Boolean SADObj::DoubleDiffractIterative(void)//bloch corrected a bug{	short 		i,j,						DD_Count = 0;	short			DD_CountNew = 0;	short			maxStrongPts = 599;	short			maxNewPts = 599;	double 		theIntensity,testIntensity,						x,y,x1,y1,						spotThreshold,doubleDiffThreshold,						xLimit,yLimit,strengthFactor;					long 			*theStrongSpots,*theSSNew,sizeOf;	SpotInfo 	*thisSpot,*testSpot1,*testSpot2;		SpotInfo	*theSpots;	Crystal		*thisCrystal;			sizeOf 					= 	sizeof(SpotInfo);	D_HLock							(theDataHandle);	theSpots 				= 	(SpotInfoPtr)*theDataHandle;	theStrongSpots 	= 	(long*)D_NewPtr((maxStrongPts + 1) * (long)sizeof(long));	theSSNew 				= 	(long*)D_NewPtr((maxStrongPts + 1) * (long)sizeof(long));	xLimit 					= 	(double)negHeight * .5 / cameraConstant;	yLimit 					= 	(double)negWidth * .5 / cameraConstant;	thisCrystal 		= 	theCrystal[baseCrystal];				spotThreshold = exp(dyRange / -log((double)expoTime + 2));		strengthFactor = 2.0;RESTART: 	DD_Count = 0;		doubleDiffThreshold = strengthFactor * spotThreshold;	testSpot1 = &theSpots[1];	for(i = 1 ; i < data_Count; i++,testSpot1++){		if(doubleDiffThreshold < testSpot1->intensity && testSpot1->flags == baseCrystal){			theStrongSpots[DD_Count] = i;			DD_Count++;			if(DD_Count >= maxStrongPts){				strengthFactor += .5;				goto RESTART;			}		}	}		DD_CountNew = 1;	while(DD_CountNew){		DD_CountNew = 0;		testSpot1 = &theSpots[1];		for(i = 1 ; i < data_Count; i++,testSpot1++){						theIntensity = (double)testSpot1->intensity;			x1 = (double)testSpot1->x;			y1 = (double)testSpot1->y;			if(Quit()){				KillPtr((Ptr)theStrongSpots);				KillPtr((Ptr)theSSNew);				D_HUnlock(theDataHandle);				return true;			}						for(j = 0; j < DD_Count; j++){					testSpot2 = &theSpots[theStrongSpots[j]];					x = x1 + (double)testSpot2->x;					if(fabs(x) > xLimit)						continue;					y = y1 + (double)testSpot2->y;					if(fabs(y) > yLimit)						continue;					testIntensity = theIntensity *  (double)testSpot2->intensity * exp(-sqrt(x * x + y * y));										if(testIntensity < spotThreshold) continue;					if(SpotExists(x,y,testIntensity)) continue; 					if(data_Count >= data_Length)							ExpandMemory();						thisSpot = &theSpots[data_Count++];					numSpots++;										thisSpot->intensity = testIntensity;					thisSpot->x = x;					thisSpot->y = y;					thisSpot->z = 0.0;					thisSpot->h = testSpot2->h + testSpot1->h;					thisSpot->k = testSpot2->k + testSpot1->k;					thisSpot->l = testSpot2->l + testSpot1->l;					thisSpot->direction = 	false;					thisSpot->theCrystal = 	testSpot1->theCrystal;					thisSpot->flags = 		4;					thisSpot->angle = 0.0;					thisSpot->sF = Cadd(testSpot2->sF, testSpot1->sF);										theSpots 	= (SpotInfoPtr)*theDataHandle;				if(thisSpot->intensity > doubleDiffThreshold){					if(maxNewPts > DD_CountNew) 						theSSNew[DD_CountNew] = data_Count - 1;						DD_CountNew++;				}			}		}				if(DD_CountNew){			for(i = 0; i < DD_CountNew;i++)				theStrongSpots[i] = theSSNew[i];			DD_Count = DD_CountNew;		}	}	KillPtr		((Ptr)theStrongSpots);	KillPtr		((Ptr)theSSNew);	D_HUnlock	(theDataHandle);	return true;}Boolean SADObj::SpotExists(double theX,double theY,double testIntensity){	short i;	SpotInfo *thisSpot,*theSpots;	theSpots = (SpotInfoPtr)*theDataHandle;	if( fabs(theX) < .06 && fabs(theY) < .06)		return (true);	thisSpot = &theSpots[1];	for(i = 1 ; i < data_Count; i++,thisSpot++){				if(fabs(theX - thisSpot->x) >= .01)			continue;		if(fabs(theY - thisSpot->y) >= .01)			continue;		if(thisSpot->flags != 4)			return true;		if(testIntensity <= thisSpot->intensity)			return (true);		thisSpot->intensity = testIntensity;		return (true);	}	return(false);}void SADObj::DeleteDoubleDif(void){	short 		i;	SpotInfo 	*thisSpot;	SpotInfo	*theSpots;		for(i = 1 ; i < data_Count && i >= 0; i++){		theSpots = (SpotInfoPtr)*theDataHandle;		thisSpot = &theSpots[i];		if(thisSpot->flags ==  4){			spotLoc = i;			DeleteSpot();			i--;		}	}	newPictReq = true;	return;}void SADObj::DeleteWeakSpots(void){	short 		i;	SpotInfo	*theSpots;	float		spotThreshold;	double 		aMaxSize;		/*MFTemp*/D_HLock(theDataHandle);	theSpots = (SpotInfoPtr)*theDataHandle;	theSpots++;	aMaxSize = expoTime + 2;		spotThreshold = exp(dyRange / -log(aMaxSize)) - .02;	for(i = 1 ; i < data_Count && i >= 0; i++,theSpots++){				if(theSpots->intensity <  spotThreshold){			/*MFTemp*/D_HUnlock(theDataHandle);			spotLoc = i;			DeleteSpot();			/*MFTemp*/D_HLock(theDataHandle);			i--;			theSpots = &THE_CURRENT_SPOT;			theSpots--;		}	}	/*MFTemp*/D_HUnlock(theDataHandle);	newPictReq = true;	return;}void SADObj::DoubleDiffractSimple(void){	short 		i,oldCenterX,oldCenterY,				DD_Count = 0;	long 		*theStrongSpots;	SpotInfo	*theSpots,*testSpot1;	double 		spotThreshold,doubleDiffThreshold,strengthFactor;	short 		maxStrongPts = 599;	//PicHandle  	aPict;	Rect theRect;		theStrongSpots = (long*)D_NewPtr(600 * (long)sizeof(long));	theSpots = (SpotInfoPtr)*theDataHandle;	spotThreshold = exp(dyRange / -log((double)expoTime + 2));		strengthFactor = 2.0;	oldCenterX = centerX; 	oldCenterY = centerY;	//SetPict(false);	newPictReq = true;RESTART:	DD_Count = -1;	doubleDiffThreshold = strengthFactor * spotThreshold;	for(i = 1 ; i < data_Count; i++){		if(doubleDiffThreshold < theSpots[i].intensity && theSpots[i].flags == baseCrystal){			theStrongSpots[++DD_Count] = i;			if(DD_Count >= 49){				strengthFactor += .5;				goto RESTART;			}		}	}	//aPict = OpenPicture(&thePictRect);	for(i = 0 ; i <= DD_Count; i++){		testSpot1 = &theSpots[theStrongSpots[i]];				 centerX = testSpot1->x * scaleFactor;		centerY = testSpot1->y * scaleFactor;		theRect = thePictRect;		OffsetRect(&theRect,centerX,centerY);		//if(screenPict != 0L)DrawPicture(screenPict,&theRect);	}	centerX = oldCenterX;	centerY = oldCenterY;	//SetPict(false);	//if(screenPict != 0L)DrawPicture(screenPict,&theRect);	//ClosePicture();	//DrawPicture(aPict,&thePictRect);	newPictReq = true;	centerX = oldCenterX;	centerY = oldCenterY;	KillPtr((Ptr)theStrongSpots);	objectDrawnFlag = false;	//newPictEnable = false;	return;}void		SADObj::AddSpotSummation(Point thePoint){	static Boolean 	spotHit = false;	static Point 		oldPoint;	static short			delH,delV;	static double 	delX,delY;	double 					x,y;	SpotInfoPtr 			theSpots;	static short 						theSize;	static Crystal 	*aCrystal;		if(!Button()){		if(spotHit)			goto  ADDSPOT;		spotHit = false;		delH = 0;		delV = 0;		delX = 0.0;		delY = 0.0;		return;	}	PenMode(patXor);		if(!spotHit){		if(!FindSpot(thePoint)) return;		delH = THE_CURRENT_SPOT.y * scaleFactor;		delV = THE_CURRENT_SPOT.x * scaleFactor;		oldPoint.h = (THE_CURRENT_SPOT.spotRect.left + THE_CURRENT_SPOT.spotRect.right) / 2;		oldPoint.v = (THE_CURRENT_SPOT.spotRect.top + THE_CURRENT_SPOT.spotRect.bottom) / 2;		theSize = (THE_CURRENT_SPOT.spotRect.bottom - THE_CURRENT_SPOT.spotRect.top) / 2;		SetRect(&gTheRect,-theSize,-theSize,theSize,theSize);		OffsetRect(&gTheRect,oldPoint.h + delH,oldPoint.v + delV);		StdOvalMarquee(&gTheRect);		delY = THE_CURRENT_SPOT.x;		delX = THE_CURRENT_SPOT.y;			aCrystal = THE_CURRENT_SPOT.theCrystal;		aCrystal->SetColor();		spotHit = true;		return;	}	if(spotHit){		StdOvalMarquee(&gTheRect);		if(thePoint.h != oldPoint.h || thePoint.v != oldPoint.v){			SetRect(&gTheRect,-theSize,-theSize,theSize,theSize);			OffsetRect(&gTheRect,oldPoint.h + delH,oldPoint.v + delV);			StdOvalMarquee(&gTheRect);			oldPoint = thePoint;		}		return;	}ADDSPOT:	spotHit = false;		if(!FindSpot(oldPoint)){		return;	}	x = THE_CURRENT_SPOT.x;	y = THE_CURRENT_SPOT.y;					theSpots = (SpotInfoPtr)*theDataHandle;	if(data_Count <= data_Length)		ExpandMemory();	spotLoc = data_Count++;		numSpots++;	THE_CURRENT_SPOT.intensity = .6;	THE_CURRENT_SPOT.x = x + delY;	THE_CURRENT_SPOT.y = y + delX;	THE_CURRENT_SPOT.z =  0.0;	THE_CURRENT_SPOT.h = (short)1;	THE_CURRENT_SPOT.k = (short)0;	THE_CURRENT_SPOT.l = (short)0;	THE_CURRENT_SPOT.direction = false;	THE_CURRENT_SPOT.theCrystal = aCrystal;	THE_CURRENT_SPOT.flags = 0;	theSize 		=  (expoTime + 2) * pow((double)THE_CURRENT_SPOT.intensity,(1. / (double)dyRange));	thePoint.h 	= centerX + THE_CURRENT_SPOT.y *  scaleFactor;	thePoint.v 	= centerY + THE_CURRENT_SPOT.x *  scaleFactor;	SetRect				(&(THE_CURRENT_SPOT.spotRect),-theSize,-theSize,theSize,theSize);	OffsetRect		(&(THE_CURRENT_SPOT.spotRect),thePoint.h,thePoint.v);	gTheRect 		= THE_CURRENT_SPOT.spotRect;	PenMode				(gMode);	dm_PaintOval			(&gTheRect);	newPictReq = true;}