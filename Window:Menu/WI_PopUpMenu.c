//ects:D.M. v2.0:Sources.Jim:Window/Menu:WI_PopUpMenu.c#include	"Diffract_INCs.h"void PopUpMenu::P_ActivateMTitle(void){	FontInfo 	theFont;	short		width;	GetItem(theMenu,0,(unsigned char*)menuTitle);	/*for(i = 0 ; i <= **((short**)theMenu) ; i++){		menuTitle[i] = (*(short**)theMenu)[i];	}*/	TextFont		(systemFont);	GetFontInfo		(&theFont);		width 		= 	StringWidth((unsigned char*)menuTitle);	SetRect			(&titleRect,theMenuRect.left - width,					theMenuRect.top  ,					theMenuRect.left,					theMenuRect.top + theFont.descent + 					theFont.leading + theFont.ascent);	}void PopUpMenu::P_ActivateMTitleDialog(DialogPtr theDialog,short theItem){	short type;	Handle theHandle;		GetDItem(theDialog,theItem,&type,&theHandle,&titleRect);	GetIText(theHandle,(unsigned char*)menuTitle);		}void 	PopUpMenu::InitSizedMenu	(DialogPtr theDialog,short theItem,short resID,short theValue){	short type;	Handle theHandle;	char 	theText[255];	drawFlag	=	true;	menuSize 	= 	true;	if(theValue > 0) /*dec 1992*/		lastResult 	= 	theValue;	else		lastResult	=	1;		theButton 	= 	false;/*July 1992 */	theResID 	= 	resID;	GetDItem		(theDialog,theItem,&type,&theHandle,&theMenuRect);	theText[0]	=	0;	theMenu 	= 	DMJ_GetMenu(resID);	SetRect			(&titleRect,-1,-1,1,1);		InsertMenu		(theMenu,-1);			theResID = (*theMenu)->menuID;		SetPopUp();		if((*theMenu)->menuID != theResID){		D_Debug_Message(21);	}}void PopUpMenu::Init(DialogPtr theDialog,short theItem,short resID,short theValue/*dec 1992*/){	short type;	Handle theHandle;	char   theText[100];		theButton 	= false;/*July 1992 */	menuSize 	= false;	drawFlag	=	true;	if(theValue > 0) /*dec 1992*/		lastResult 	= 	theValue;	else		lastResult	=	1;		GetDItem		(theDialog,theItem,&type,&theHandle,&theMenuRect);	theText[0]	=	0;	theMenu 	= 	DMJ_GetMenu( resID);	SetRect			(&titleRect,-1,-1,1,1);	theResID 	= 	(*theMenu)->menuID;	InsertMenu		(theMenu,-1);		SetPopUp();		if((*theMenu)->menuID != theResID){		D_Debug_Message(21);	}}void 	PopUpMenu::InitAtPoint		(Point thePoint,short theItem,short resID,Boolean button,Boolean dF){	FontInfo	theFont;	char		theText[255];		drawFlag	=	dF;	lastResult 	= 	theItem;	TextFont		(systemFont);	GetFontInfo		(&theFont);		SetRect			(&theMenuRect,thePoint.h - 1,thePoint.v,					thePoint.h + 5,					thePoint.v +  theFont.descent + theFont.ascent + 1);	menuSize 	= 	true;	theText[0]	=	0;	theMenu 	= 	DMJ_GetMenu( resID);			SetRect			(&titleRect,-1,-1,1,1);	theResID 	= 	(*theMenu)->menuID;	InsertMenu		(theMenu,-1);	if(!dF)P_ActivateMTitle();	theButton	=	button; /* added by J.T. July 1992 */	if(button)				{		short width,top,bottom,left,right;		PenState thePenState;		GetPenState		(&thePenState);		TextFont		(monaco);		TextSize		(9);		P_GetItemText	(1,gTheText);		width 		= 	StringWidth(pTheText);		TextFont		(0);		TextSize		(12);				top 		= thePoint.v;		bottom 		= top + 14;		left 		= thePoint.h;		right 		= left + width + 5;				SetRect(&theMenuRect,left,top,right,bottom);				SetPenState(&thePenState);	}	SetPopUp();		if((*theMenu)->menuID != theResID){		D_Debug_Message(21);	}}long	PopUpMenu::HitPopUp		(Point thePoint) /*changed to long by Jim july 1992 */{		if(PtInRect(thePoint,&theMenuRect))	{		return DoPopUp();	}	return 0L;}long PopUpMenu::DoPopUp(void){	short 	item;	Point 	thePoint;	long 	theResult;		thePoint.h = theMenuRect.left;	thePoint.v = theMenuRect.top;	LocalToGlobal(&thePoint);	if(titleRect.left > 0)		InvertRect(&titleRect);			/*  Added the following two lines to re-insert the menu into the current menu list		if it got lost after a crystal def....this is a kludge  */			if(GetMHandle((*theMenu)->menuID) == (MenuHandle)NUL){		InsertMenu(theMenu,-1);	}		theResult = PopUpMenuSelect(theMenu,thePoint.v,thePoint.h,lastResult);		item = LoWord(theResult);	if(item != 0){		lastResult = item;	}	SetPopUp();	if(titleRect.left > 0)		InvertRect(&titleRect);	return (theResult);}void 	PopUpMenu::P_SelectItem(char *theText){	short numItems,i;	char aText[255];	i = 1;	numItems = P_CountMItems();	while(i <= numItems)	{		P_GetItemText(i,aText);		p2cstr(pTheText);		if(strcmp(theText,aText)){			lastResult = i;			SetPopUp();			i = numItems;		}		i++;	}}void	PopUpMenu::SetPopUp(void){	unsigned char 			theText[100];	PenState 				thePenState;	GetPenState			(&thePenState);	if(theButton)	{		GetClip(gTheRgn);		ClipRect(&theMenuRect);		PenNormal			(); /* New 9/11/1992 */		gCurrentObj->DMForeColor(BLACK);		PaintRect			(&theMenuRect);				gCurrentObj->DMForeColor(BLACK);		FrameRect(&theMenuRect);		MoveTo(theMenuRect.left + 1,theMenuRect.bottom);		LineTo(theMenuRect.right,theMenuRect.bottom);		LineTo(theMenuRect.right,theMenuRect.top);		MoveTo(theMenuRect.left + 3,theMenuRect.bottom - 4);				TextFont		(monaco);		TextSize		(9);		P_GetItemText	(1,gTheText);		gCurrentObj->DMForeColor(WHITE);		gCurrentObj->DMBackColor(BLACK);		DrawDiffractString		(pTheText);		TextFont		(0);		TextSize		(12);		gCurrentObj->DMForeColor(BLACK);		gCurrentObj->DMBackColor(WHITE);		SetPenState(&thePenState);		D_SetClip(gTheRgn);		return;	}	if(menuSize){		CalcMenuSize	(theMenu);		SetRect			(&theMenuRect,theMenuRect.left,theMenuRect.top,						theMenuRect.left + (*theMenu)->menuWidth + 4,theMenuRect.bottom);	}						EraseRect	(&theMenuRect);		if(drawFlag){		gCurrentObj->DMForeColor(BLACK);		FrameRect	(&theMenuRect);		MoveTo		(theMenuRect.left + 1,theMenuRect.bottom);		LineTo		(theMenuRect.right,theMenuRect.bottom);		LineTo		(theMenuRect.right,theMenuRect.top + 1);		MoveTo		(theMenuRect.left + 4,theMenuRect.bottom - 2);		GetItem		(theMenu,lastResult,theText);		DrawDiffractString	(theText);	}else{		DrawDiffractString	((unsigned char*)menuTitle);	}		SetPenState(&thePenState);}void PopUpMenu::P_AppendMenu(char *theText){	short n;	AppendMenu		(theMenu,(unsigned char*)theText);	n = P_CountMItems		();	EnableItem		(theMenu,n);}short	PopUpMenu::P_CountMItems		(void){		return CountMItems(theMenu);}void PopUpMenu::DoClose(){	DeleteMenu			((*theMenu)->menuID);	DisposeMenu			(theMenu);	//DrawMenuBar			();	D_delete			(this);}void 	PopUpMenu::P_GetItemText(short theItem,char *theText){		if(theMenu == 0L) return;	GetItem(theMenu,theItem,(unsigned char*)theText);}void	PopUpMenu::P_SetItemText	(short theItem,char *itemString)/* added July 1992 */{		if(theMenu == 0L) return;	SetItem(theMenu,theItem,(unsigned char*)itemString);}void	PopUpMenu::P_SetCItemText	(char *itemString)/* added July 1992 */{		if(theMenu == 0L) return;	GetItem(theMenu,lastResult,(unsigned char*)itemString);	}	void PopUpMenu::P_InsMenuItem(char* itemText,short afterItem){		InsMenuItem		(theMenu,(unsigned char*)itemText,afterItem);}void PopUpMenu::P_InsCMenuItem(char* itemText){		InsMenuItem		(theMenu,(unsigned char*)itemText,lastResult);}void 	PopUpMenu::P_GetCItemText(char *theText){		if(theMenu == 0L) return;	GetItem(theMenu,lastResult,(unsigned char*)theText);	}short 	PopUpMenu::P_GetFirstCheckedItem(void){	Boolean flag = false;	short i,total;	if(theMenu == 0L) return 0;	total = P_CountMItems();	i = 1;	while(!flag && i <= total){		flag = P_GetItemMark		(i);		if(!flag)i++;	}	if(flag)return i;		return 0;}short	PopUpMenu::P_GetItemMark		(short itemNo){	short 			markChar;		GetItemMark		(theMenu,itemNo,&markChar);	return 			markChar;}short	PopUpMenu::P_GetCItemMark		(void){	short 			markChar;			GetItemMark		(theMenu,lastResult,&markChar);	return 			markChar;}void	PopUpMenu::P_SetCItemMark		(short theMark){		SetItemMark		(theMenu,lastResult,theMark);}void	PopUpMenu::P_SetItemMark		(short itemNo,short theMark){		SetItemMark		(theMenu,itemNo,theMark);}void	PopUpMenu::P_DelMenuItem		(short itemNo){	short 	markChar;	short	items;	if(!itemNo)return;	GetItemMark			(theMenu,itemNo,&markChar);	lastResult 		= 	itemNo;		DelMenuItem			(theMenu,lastResult);	items			=	P_CountMItems	();	if(items < lastResult)		lastResult = items;			if(markChar)		P_SetItemMark	(lastResult,markChar);		SetPopUp			();		return ;}void	PopUpMenu::P_DelCMenuItem		(void){	short markChar;	short items;		GetItemMark			(theMenu,lastResult,&markChar);	DelMenuItem			(theMenu,lastResult);	items		=		P_CountMItems	();	if(items < lastResult)		lastResult = items;	if(markChar)		P_SetItemMark	(lastResult,markChar);		SetPopUp			();		return ;}void	PopUpMenu::P_CheckItem		(short itemNo,Boolean onFlag){	CheckItem		(theMenu,itemNo,onFlag);}void	PopUpMenu::P_CheckCItem		(Boolean onFlag){		CheckItem		(theMenu,lastResult,onFlag);}void PopUpMenu::MoveBy(Point thePoint){	OffsetRect			(&theMenuRect,thePoint.h,thePoint.v);	OffsetRect			(&titleRect,thePoint.h,thePoint.v);	}void PopUpMenu::MoveMenuTo(Point thePoint){	short h,v;		h = theMenuRect.right - theMenuRect.left;	v = theMenuRect.bottom - theMenuRect.top;	SetRect			(&theMenuRect,thePoint.h - 1,thePoint.v,					thePoint.h + h,					thePoint.v +  v);}