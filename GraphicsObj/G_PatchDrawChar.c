#include	"Diffract_INCs.h"#define		DrawCharTrap	0xA883#define		JMP				0x4EF9DialogPtr  	GetNewDialog_P(short resID,Ptr storage,WindowPtr position){	DialogPtr	theDialog;		PatchDrawChar(&g_PatchCount);	theDialog = GetNewDialog(resID,storage,position);	return(theDialog);}void		DisposDialog_P(DialogPtr theDialog){	UnpatchDrawChar(&g_PatchCount);	DisposDialog(theDialog);}void		PatchDrawChar(short* count){	if((*count)++ <= 0){		asm{			move 	#DrawCharTrap,D0		; Set trap ID			_GetTrapAddress					; Get Trap Address			lea		@oldDC,A1				; Get storage loc			move.l	A0,(A1)					; Save trap address			lea		g_PatchAddress,A1		; Get storage loc			move.l	A0,(A1)					; Save trap address			lea		@NewDC,A0				; Load patch address			move 	#DrawCharTrap,D0		; Load patch ID			_SetTrapAddress					bra		@out					; Done with Patch setup				@NewDC		lea		@exitPatch,A0			; Get return address loc			move.l	(SP)+,(A0)				; save return address			lea		@theChar,A0				; get char address			move.w	(SP),(A0)				; save the char			pea		@tailPatch				; push tail patch address			dc		JMP						; Jump to trap@oldDC		nop			nop						@tailPatch	MOVE.W		@theChar,D7			CMPI.B		#0xC1,D7		; test chars			BEQ.S		@drawBar 			CMPI.B		#0xAA,D7			BEQ.S		@drawBar			CMPI.B		#0xA3,D7			BEQ.S		@drawBar			CMPI.B		#0xA2,D7			BEQ.S		@drawBar			CMPI.B		#0xB0,D7			BEQ.S		@drawBar			CMPI.B		#0xA4,D7			BEQ.S		@drawBar			CMPI.B		#0xA6,D7			BEQ.S		@drawBar			CMPI.B		#0xA5,D7			BEQ.S		@drawBar			CMPI.B		#0xBB,D7			BNE.S		@noBar@drawBar	MOVE.L    #0xFFF50000,-(A7)		; Draw Overbar			_Move			MOVE.L    #0x0000FFF9,-(A7)			_Line			MOVE.L    #0x000B0007,-(A7)			_Move		@noBar		dc		JMP						; no bar or return to main@exitPatch	nop			nop			@theChar	nop								; storage for char			nop	@out		nop								; exit		}	}	}void		UnpatchDrawChar(short* count){	if(--(*count) <= 0){		SetTrapAddress(g_PatchAddress,DrawCharTrap);	}}