//ces.Jim:GraphicsObj:G_TextObj.c#include	"Diffract_INCs.h"#include	"TextObj.h"void	TextObj::DoInit(Boolean flag,Crystal *aCrystal){	inherited::DoInit(flag,aCrystal);	spotLoc = 0;	next = (TextRoundObj*)NULL;	SetRect(&lineRect,-2,2,-2,2);	return;}void	TextObj::WriteAll(void){		gTheFile->WriteShort(spotLoc);	gTheFile->WriteDataBlock((Ptr)&lineRect,sizeof(Rect));	WriteIndex();	if(next != 0L){		gTheFile->WriteShort(10);		next->WriteAll();		return;	}	gTheFile->WriteShort(0L);	return;	}void	TextObj::ReadAll(Crystal *aCrystal[4]){	short isNext;	spotLoc = gTheFile->ReadShort();	gTheFile->ReadDataBlock((Ptr)&lineRect,sizeof(Rect));	ReadIndex(aCrystal);	isNext = gTheFile->ReadShort();		if(isNext != 0L){		next = (TextRoundObj*)D_new(TextObj);		next->DoInit(true,aCrystal[0]);		next->ReadAll(aCrystal);		return;	}	next = 0L;	return;	}void	TextObj::Move(void){	Point oldPoint;	Point	thePoint;	short delH,delV;	gCurrentObj->DoSetOrigin();		Kill();	GetMouse(&oldPoint);		while(StillDown()){		GetMouse(&thePoint);		Draw(false);		if(!EqualPt(oldPoint,thePoint)) {			delH = -oldPoint.h + thePoint.h;			delV = -oldPoint.v + thePoint.v;			OffsetRect(&theSpotRect,delH,delV);			oldPoint = thePoint;		}	}	PenNormal();	Draw(true);		gCurrentObj->DoResetOrigin();}TextRoundObj* 	TextObj::DoFind(Point thePoint){	if(PtInRect(thePoint,&theSpotRect)){		return (TextRoundObj*)this;	}	if(next != NULL){		return next->DoFind(thePoint);		}	return NULL;}void	TextObj::DrawAll(void){	if(next != NULL) next->DrawAll();	Draw(true);}void	TextObj::Draw(Boolean flag){	Point 		thePoint;	double 		distH1,distV1,distH2,distV2;	double 		length1,length2;	Rect			lRect;	Boolean		redraw = false;	if(gCurrentObj->printing)	{		PenMode(0);	}	thePoint.h = (theSpotRect.left + theSpotRect.right) / 2;	if(thePoint.h == 0){		 return;	}	if(!flag){		SetMarqueePattern(NUL);		PenMode(patXor);		redraw = true;	}	gTheRect = theSpotRect;	lRect	=	lineRect;		thePoint.h = (gTheRect.left + gTheRect.right) / 2;	thePoint.v = (gTheRect.bottom + gTheRect.top) / 2;		distH1 = thePoint.h - lRect.left;	distV1 = thePoint.v - lRect.top;	distH2 = thePoint.h - lRect.right;	distV2 = thePoint.v - lRect.bottom;	length1 = sqrt((double)(distH1 * distH1) + (double)(distV1 * distV1));	length2 = sqrt((double)(distH2 * distH2) + (double)(distV2 * distV2));	if(length2 <= length1)		MoveTo(lRect.right,lRect.bottom);	else		MoveTo(lRect.left,lRect.top);	LineTo(thePoint.h,thePoint.v);	if(!flag && redraw){		dm_FrameRect(&gTheRect);		Delay(2,&gLongScratch);//		InsetRect(&gTheRect,0,-1);				if(length2 <= length1)			MoveTo(lRect.right,lRect.bottom);		else			MoveTo(lRect.left,lRect.top);		LineTo(thePoint.h,thePoint.v);		dm_FrameRect(&gTheRect);	}		thePoint.h = (gTheRect.left + gTheRect.right) / 2;	thePoint.v = gTheRect.bottom - 1;	if(flag)		inherited::DrawIndex(thePoint);	}void TextObj::MoveAll(Point delPoint){	if(next != 0)		next->		MoveAll(delPoint);	InvalRect(&theSpotRect);	InvalRect(&lineRect);	OffsetRect		(&theSpotRect,delPoint.h,delPoint.v);	OffsetRect		(&lineRect,delPoint.h,delPoint.v);	return;}TextRoundObj* TextObj::CreateObject(void){	return (TextRoundObj*)D_new(TextObj);}void TextObj::EraseObject(TextObj *oldObj){	if(oldObj == next){		next = next->next;		((SpotInfoPtr)(*(gCurrentObj->theDataHandle)))[oldObj->spotLoc].flags -= TEXT_MASK;		oldObj->Kill();		D_delete(oldObj);		return;	}else if(next != NULL){		next->EraseObject(oldObj);	}}TextObj*	TextObj::Erase(short count,TextObj* oldTextObj){	TextObj *toBeSentBack;		if(spotLoc == count){		toBeSentBack = next;		((SpotInfoPtr)(*(gCurrentObj->theDataHandle)))[spotLoc].flags -= TEXT_MASK;		Kill();		D_delete(this);		return toBeSentBack;	}	 	if(next){	 next =  (TextRoundObj*)next->Erase(count,oldTextObj);	 return this;	}	return 0L;}void	TextObj::Kill(){		gCurrentObj->DMForeColor/*PMForeColor*/(BACKGROUND_COLOR);	Draw(true);	PenNormal();	gCurrentObj->DMForeColor/*PMForeColor*/(COMPLEMENT_COLOR);	gTheRect = theSpotRect;	//gCurrentObj->ObjRectToLocal(&gTheRect);	dm_EraseRect(&gTheRect);	}void TextObj::KillAll(void){	if(next != NULL){ 		next->KillAll();	}	Kill();	D_delete(this);}