#include	"Diffract_INCs.h"//ces.Jim:GraphicsObj:G_PictureObj.c#include	"PictureObj.h"void		PictureObj::DoInit(void){	rulerHeight		= 0;			low				= 0;	high 			= 255;	xFormThresh		= 128;			inherited::DoInit();	InsertMenu(g_Palette_Menu,-1);	SetPort(theWindow);		/*KillMBHandle*/DisposeHandle(theMenuBar);	theMenuBar = GetMenuBar();	DrawMenuBar();		DisableItem(GetMHandle(EDIT_MENU),PASTE);	DisableItem(GetMHandle(EDIT_MENU),DO_CLEAR);	DisableItem(GetMHandle(EDIT_MENU),SELECT_ALL);	return;}void	PictureObj::SetObjectMenu(void){	theMenuBar 		= GetNewMBar(PICTURE_OBJ_MB);	ClearMenuBar();/* July 1992 */	SetMenuBar			(theMenuBar);}void		PictureObj::DoSetup(PicHandle	thePict,PaletteHandle	thisPalette){	screenPict 	= thePict;	thePictRect	= (*thePict)->picFrame;	thePalette 	= thisPalette;		OffsetRect(&thePictRect,-thePictRect.left,-thePictRect.top);	SizeWindow(theWindow,thePictRect.right,thePictRect.bottom,true);	SetPalette(theWindow,thePalette,true);	SetPort(theWindow);	ActivatePalette(theWindow);	ShowWindow(theWindow);	DrawPicture(screenPict,&thePictRect);	return;}void		PictureObj::DoClose(void){	inherited::DoClose();	return;}void		PictureObj::DoMenu(long theResult){	switch(HiWord(theResult)){		case PICTURE_MENU:			switch(LoWord(theResult)){				case SHARPEN:					break;				case SMOOTH:					break;				case BI_LEVEL:					BiLevelTransform();					break;				default:					break;			}			break;		case PALETTE_MENU:			{				short 			paletteID,theItem;				PaletteHandle	thisPalette,newPalette;								theItem = LoWord(theResult);				if(theItem == 1){					paletteID = 2100;				} else {					paletteID = theItem + 2100;				}				newPalette 	= GetNewPalette(paletteID);				thisPalette = GetPalette(theWindow);				SetPalette(theWindow,newPalette,true);				ActivatePalette(theWindow);												if(screenPict != (PicHandle)NUL){					KillPicture(screenPict);				}				screenPict = OpenPicture(&theWindow->portRect);  /* get new color info */				DMForeColor(1);				DMBackColor(0);								CopyBits(		(BitMap*)(*(((CGrafPtr)theWindow)->portPixMap)),								(BitMap*)(*(((CGrafPtr)theWindow)->portPixMap)),								&theWindow->portRect,&theWindow->portRect,srcCopy,0L);									ClosePicture();															}			break;		default:			inherited::DoMenu(theResult);			break;	}	HiliteMenu(0);	return;}Boolean		PictureObj::DoContent(Point thePoint){	inherited::DoContent(thePoint);	return false;}void		PictureObj::DoIdle(void){	inherited::DoIdle();	return;}void		PictureObj::DoFileRead(void){	PaletteHandle	thisPalette;		if(screenPict == (PicHandle)NUL){		screenPict = (PicHandle)NewHandle(10L);/*dec 1992 I changed to D_NewHandle .. changed bask*/	}		thisPalette = (PaletteHandle)D_NewHandle(10L);	gTheFile->ReadHandle((Handle)screenPict);	gTheFile->ReadHandle((Handle)thisPalette);	DoSetup(screenPict,thisPalette);	return;}void		PictureObj::DoFileWrite(void){	gTheFile->WriteShort(PICTURE_OBJ);	gTheFile->WriteHandle((Handle)screenPict);	gTheFile->WriteHandle((Handle)GetPalette(theWindow));	return;}void		PictureObj::SetThePalette(short thresh){	short			i,j;	RGBColor		highVal,lowVal;	PaletteHandle	thisPalette;		SelectWindow(theWindow);	SetPort(theWindow);		if(thresh < 1 || thresh > 255){		DoMenu((long)(((long)PALETTE_MENU << 16) + 1));		return;	}		thisPalette 	= GetPalette(theWindow);	j = 2110;	thisPalette 	= GetNewPalette(2110);		highVal.red = highVal.green = 65535;	highVal.blue = lowVal.red = lowVal.green = 0;	lowVal.blue = 65535;		for(i = 2 ; i <= 255 ; i++){		if(i >= thresh){			SetEntryColor(thisPalette,i,&highVal);			SetEntryUsage(thisPalette,i,2,j);		} else {			SetEntryColor(thisPalette,i,&lowVal);			SetEntryUsage(thisPalette,i,2,j);		}	}			SetPalette(theWindow,thisPalette,true);	ActivatePalette(theWindow);	if(screenPict != (PicHandle)NUL){					KillPicture(screenPict);	}	screenPict = OpenPicture(&theWindow->portRect);  	DMForeColor(1);	DMBackColor(0);		CopyBits(		(BitMap*)(*(((CGrafPtr)theWindow)->portPixMap)),					(BitMap*)(*(((CGrafPtr)theWindow)->portPixMap)),					&theWindow->portRect,&theWindow->portRect,srcCopy,0L);			ClosePicture();		SelectWindow(theDialog);	SetPort(theDialog);	return;}void		PictureObj::Sharpen(void){	return;}void		PictureObj::Smooth(void){	return;}void		PictureObj::BiLevelTransform(void){	short		theSelect;	Boolean		quitFlag=false;	long		time;		DoMenu((long)(((long)PALETTE_MENU << 16) + 1));		theDialog = DM_GetNewDialog(BI_LEVEL_XFRM,NUL,IN_FRONT);	SetWTitle(theDialog,"\pBi-Level Transformation");	low--;	high--;	GetDItem(theDialog,4,&gType,&gTheHandle,&gTheRect);	SetCtlValue((ControlHandle)gTheHandle,xFormThresh);	GetDItem(theDialog,6,&gType,&gTheHandle,&gTheRect);	SetCtlValue((ControlHandle)gTheHandle,low);	GetDItem(theDialog,8,&gType,&gTheHandle,&gTheRect);	SetCtlValue((ControlHandle)gTheHandle,high);	GetDItem(theDialog,5,&gType,&gTheHandle,&gTheRect);	sprintf(gTheText,"%3d",xFormThresh);	c2pstr(gTheText);	SetIText(gTheHandle,pTheText);	GetDItem(theDialog,7,&gType,&gTheHandle,&gTheRect);	sprintf(gTheText,"%3d",low);	c2pstr(gTheText);	SetIText(gTheHandle,pTheText);	GetDItem(theDialog,9,&gType,&gTheHandle,&gTheRect);	sprintf(gTheText,"%3d",high);	c2pstr(gTheText);	SetIText(gTheHandle,pTheText);		low++;	high++;			/* DoMenu((long)(((long)PALETTE_MENU << 16) + 1)); */			while(!quitFlag){		ModalDialog(TheFilterUPP,&theSelect);		switch(theSelect){			case -3:				SetPort(theWindow);				SetPort(theDialog);				break;							case -1:			case 2:				SetPort(theWindow);				DM_DisposDialog(&theDialog);				SetThePalette(-1);				quitFlag = true;				break;			case DLOG_ENTER_OR_CR:			case 1:				DM_DisposDialog(&theDialog);				quitFlag = true;				break;			case 3:				SetThePalette(-1);				SetPort(theWindow);				DrawDialog(theDialog);				SetPort(theDialog);				break;			case 4:				GlobalToLocal(&(gTheEvent.where));				GetDItem(theDialog,5,&gType,&gTheHandle,&gTheRect);				theSelect = LMGetKeyThresh();				time = 0;				while(StillDown() || time == 0){					xFormThresh = DoTheScroll(theDialog,4,gTheEvent.where);					SetThePalette(xFormThresh);					sprintf(gTheText,"%3d",xFormThresh);					c2pstr(gTheText);					SetIText(gTheHandle,pTheText);					theSelect = 1;					time = 1;				}				GetDItem(theDialog,4,&gType,&gTheHandle,&gTheRect);				HiliteControl((ControlHandle)gTheHandle,0);				SetPort(theDialog);				break;			case 5:				GetDItem(theDialog,5,&gType,&gTheHandle,&gTheRect);				GetIText(gTheHandle,pTheText);				p2cstr(pTheText);				xFormThresh = atoi(gTheText);				if(xFormThresh > 254){					xFormThresh = 254;					sprintf(gTheText,"%3d",xFormThresh);					c2pstr(gTheText);					SetIText(gTheHandle,pTheText);				}				if(xFormThresh < 1){					xFormThresh = 1;					sprintf(gTheText,"%3d",xFormThresh);					c2pstr(gTheText);					SetIText(gTheHandle,pTheText);				}				GetDItem(theDialog,4,&gType,&gTheHandle,&gTheRect);				SetCtlValue((ControlHandle)gTheHandle,xFormThresh);				SetThePalette(xFormThresh);				SetPort(theDialog);				break;			case 6:				GlobalToLocal(&(gTheEvent.where));				GetDItem(theDialog,7,&gType,&gTheHandle,&gTheRect);				SetPort(theWindow);				theSelect = LMGetKeyThresh();				time = 0;				while(StillDown() || time == 0){					low = DoTheScroll(theDialog,6,gTheEvent.where);					sprintf(gTheText,"%3d",low);					c2pstr(gTheText);					SetIText(gTheHandle,pTheText);					low++;					SetThePalette(xFormThresh);					Delay((long)theSelect,&time);					theSelect = 1;				}				GetDItem(theDialog,6,&gType,&gTheHandle,&gTheRect);				HiliteControl((ControlHandle)gTheHandle,0);				SetPort(theDialog);				break;			case 7:				GetDItem(theDialog,7,&gType,&gTheHandle,&gTheRect);				GetIText(gTheHandle,pTheText);				p2cstr(pTheText);				low = atoi(gTheText);				if(low > 255){					theSelect = 255;					sprintf(gTheText,"%3d",low);					c2pstr(gTheText);					SetIText(gTheHandle,pTheText);				}				if(low < 0){					low = 0;					sprintf(gTheText,"%3d",low);					c2pstr(gTheText);					SetIText(gTheHandle,pTheText);				}				low++;				GetDItem(theDialog,6,&gType,&gTheHandle,&gTheRect);				SetCtlValue((ControlHandle)gTheHandle,theSelect);				SetThePalette(xFormThresh);				SetPort(theWindow);				SetPort(theDialog);				break;			case 8:				GlobalToLocal(&(gTheEvent.where));				GetDItem(theDialog,9,&gType,&gTheHandle,&gTheRect);				SetPort(theWindow);				theSelect = LMGetKeyThresh();				time = 0;				while(StillDown() || time == 0){					high = DoTheScroll(theDialog,8,gTheEvent.where);					sprintf(gTheText,"%3d",high);					c2pstr(gTheText);					SetIText(gTheHandle,pTheText);					high++;					SetThePalette(xFormThresh);					Delay((long)theSelect,&time);					theSelect = 1;				}				GetDItem(theDialog,8,&gType,&gTheHandle,&gTheRect);				HiliteControl((ControlHandle)gTheHandle,0);				SetPort(theDialog);				break;			case 9:				GetDItem(theDialog,9,&gType,&gTheHandle,&gTheRect);				GetIText(gTheHandle,pTheText);				p2cstr(pTheText);				high = atoi(gTheText);				if(high > 255){					high = 255;					sprintf(gTheText,"%3d",high);					c2pstr(gTheText);					SetIText(gTheHandle,pTheText);				}				if(high < 0){					high = 0;					sprintf(gTheText,"%3d",high);					c2pstr(gTheText);					SetIText(gTheHandle,pTheText);				}				GetDItem(theDialog,8,&gType,&gTheHandle,&gTheRect);				SetCtlValue((ControlHandle)gTheHandle,high);				high++;				SetThePalette(xFormThresh);				SetPort(theWindow);				SetPort(theDialog);				break;			default:				break;		}	}}void		PictureObj::DoRefresh(void){		SetPort(theWindow);	BeginUpdate(theWindow);			if((long)picObjList != NUL){		PenMode(transparent+addPin);		picObjList->DrawThePicts();		picObjList->DrawSelected();	}	if(gTheSelection->isValid){		gTheSelection->DoFrame();	}	PenMode(gMode);	DrawPicture(screenPict,&thePictRect);			EndUpdate(theWindow);			RestoreTheCursor();}	