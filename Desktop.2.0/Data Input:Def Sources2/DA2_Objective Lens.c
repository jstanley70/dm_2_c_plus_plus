#include	"Diffract_INCs.h"//DA2_ObjectiveLens.c#include	"ObjectiveLens.h"#include	"GraphFunction.h"#include	"GraphSpots.h"#include	"SF_MathLib.h"#define LENS_DEF_DIALOG 600void	ObjectiveLens::DoDefine(void){		DialogPtr 		theDialog;	short			i;	Boolean			quit = false;	PopUpMenu		*thePopMenu;	short			theItem;	float			theValue;	Point			thePoint;	theDialog	= DM_GetNewDialog(LENS_DEF_DIALOG,NUL,IN_FRONT);	thePopMenu = (PopUpMenu*)D_new(PopUpMenu);	thePopMenu->Init(theDialog,17,74,1);	CalculateDefocuSpread();	if(chromeSpread){		GetDItem(theDialog,16,&gType,&gTheHandle,&gTheRect);		sprintf(gTheText,"Chrom. Spread ()");		SetCTitle((ControlHandle)gTheHandle,c2pstr(gTheText));		HideDItem (theDialog,7);		HideDItem (theDialog,20);	}	apperatureRadius	*= owner->cameraConstant;			for(i = 3;i <= 14;i++){		Boolean flag;		flag = true;		switch(i){			case 3:			theValue = sphericalAberration;			break;			case 4:			theValue = chromaticAberration;			break;			case 6:			if(!chromeSpread)				theValue = delVoltage;			else				theValue = defocusSpread;			break;			case 7:			if(!chromeSpread)				theValue = delCurrent;			else				theValue = 0.0;			break;			case 8:			theValue = apperatureRadius;			break;			case 9:			theValue = astigmatism;			break;			case 13:			theValue = stigmaticAngle;			break;			case 14:			theValue = defocus;			break;									default:				flag = false;				break;		}		if(flag){			sprintf(gTheText,"%6.3f",theValue);			GetDItem(theDialog,i,&gType,&gTheHandle,&gTheRect);			SetIText(gTheHandle,c2pstr(gTheText));		}	}	SetItemValue(theDialog,19,spotDiameter,3);	SetItemValue(theDialog,23,lensCurrent,3);	voltage				=	owner->energy * 1000;	apperatureRadius	/= owner->cameraConstant;	CalculateDefocuSpread();	CalculateTransferFunction();	CalculateScherzer();	DrawScherzer(theDialog,21);	GetDItem(theDialog,5,&gType,&gTheHandle,&gTheRect);	DrawTransferFunction(gTheRect);	while(!quit){		ModalDialog(TheFilterUPP,&theItem);		if(IsPressed(48) || IsPressed(76))		{			ReadNewValues( theDialog);			CalculateDefocuSpread();			CalculateTransferFunction();			CalculateScherzer();			DrawScherzer(theDialog,21);			GetDItem(theDialog,5,&gType,&gTheHandle,&gTheRect);			DrawTransferFunction(gTheRect);		}		switch(theItem){			case -1:			case 2:			case 1:				quit = true;				quit = true;				break;			case 11:				GetDItem(theDialog,11,&gType,&gTheHandle,&gTheRect);				sprintf(gTheText,"Click To Stop");				SetCTitle((ControlHandle)gTheHandle,c2pstr(gTheText));				while(!Button() && !IsPressed(48)){					defocus -= 20;					SetItemValue(theDialog,14,defocus,2);					ReadNewValues( theDialog);					CalculateDefocuSpread();					CalculateTransferFunction();					CalculateScherzer();					DrawScherzer(theDialog,21);					GetDItem(theDialog,5,&gType,&gTheHandle,&gTheRect);					DrawTransferFunction(gTheRect);				}				GetDItem(theDialog,11,&gType,&gTheHandle,&gTheRect);				sprintf(gTheText,"Graph f(defocus)");				SetCTitle((ControlHandle)gTheHandle,c2pstr(gTheText));				FlushEvents (everyEvent,0);				break;			case 12:				GetDItem(theDialog,12,&gType,&gTheHandle,&gTheRect);				sprintf(gTheText,"Click To Stop");				SetCTitle((ControlHandle)gTheHandle,c2pstr(gTheText));				while(!Button() && !IsPressed(48)){					stigmaticAngle += 5;					SetItemValue(theDialog,13,stigmaticAngle,2);					ReadNewValues( theDialog);					CalculateDefocuSpread();					CalculateTransferFunction();					CalculateScherzer();					DrawScherzer(theDialog,21);					GetDItem(theDialog,5,&gType,&gTheHandle,&gTheRect);					DrawTransferFunction(gTheRect);					if(stigmaticAngle >= 360) stigmaticAngle = -5;				}				GetDItem(theDialog,12,&gType,&gTheHandle,&gTheRect);				sprintf(gTheText,"Graph f(stig. ¡)");				SetCTitle((ControlHandle)gTheHandle,c2pstr(gTheText));				FlushEvents (everyEvent,0);				break;			case	16:				if(chromeSpread){					CalculateDefocuSpread();					chromeSpread = false;					GetDItem(theDialog,16,&gType,&gTheHandle,&gTheRect);					sprintf(gTheText,"Delta Voltage eV");					SetCTitle((ControlHandle)gTheHandle,c2pstr(gTheText));					ShowDItem (theDialog,7);					ShowDItem (theDialog,20);					SetItemValue( theDialog, 6, delVoltage,4);					SetItemValue( theDialog, 7, delCurrent,2);									}else{					CalculateDefocuSpread();					chromeSpread = true;					GetDItem(theDialog,16,&gType,&gTheHandle,&gTheRect);					sprintf(gTheText,"Chromatic Spread ()");					SetCTitle((ControlHandle)gTheHandle,c2pstr(gTheText));					SetItemValue( theDialog, 6,defocusSpread ,4);					HideDItem (theDialog,7);					HideDItem (theDialog,20);				}				break;			case 17:				{					long theValue;					short item;					theValue = thePopMenu->DoPopUp();					item = LoWord(theValue);					switch(item){							case 1:								SetItemValue(theDialog,3,2.5,2);								SetItemValue(theDialog,4,2.7,2);							break;							case 2:								SetItemValue(theDialog,3,1.0,2);								SetItemValue(theDialog,4,1.2,2);							break;							case 3:								SetItemValue(theDialog,3,.9,2);								SetItemValue(theDialog,4,1.5,2);							break;							case 4:								SetItemValue(theDialog,3,.3,2);								SetItemValue(theDialog,4,.6,2);							break;							case 5:								SetItemValue(theDialog,3,.4,2);								SetItemValue(theDialog,4,.8,2);							break;							case 6:								SetItemValue(theDialog,3,.9,2);								SetItemValue(theDialog,4,1.2,2);							break;							case 7:								SetItemValue(theDialog,3,1.1,2);								SetItemValue(theDialog,4,1.1,2);							break;												}									}					ReadNewValues( theDialog);					CalculateDefocuSpread();					CalculateTransferFunction();					CalculateScherzer();					DrawScherzer(theDialog,21);					GetDItem(theDialog,5,&gType,&gTheHandle,&gTheRect);					DrawTransferFunction(gTheRect);					break;			case 5:				GetMouse(&thePoint);				if(Button())theGraph->DoContent(thePoint);				break;			default:								break;			case ML_UPDATE_EVT:					BeginUpdate(theDialog);				UpdtDialog(theDialog,theDialog->visRgn);				if(!gAppleEvtsOK){					HiliteOK(theDialog);				}				EndUpdate(theDialog);				break;		}	}			thePopMenu	->	DoClose();	DM_DisposDialog(&theDialog);}void	ObjectiveLens::ReadNewValues(DialogPtr theDialog){	sphericalAberration = GetItemValue(theDialog, 3); 	chromaticAberration = GetItemValue(theDialog,4); 	apperatureRadius    = GetItemValue(theDialog,8); 	if(!chromeSpread){ 		delVoltage			= GetItemValue(theDialog,6); 		delCurrent			= GetItemValue(theDialog,7); 	}else{ 		defocusSpread			= GetItemValue(theDialog,6); 	} 	astigmatism			= GetItemValue(theDialog,9);	stigmaticAngle		= GetItemValue(theDialog,13);	defocus				= GetItemValue(theDialog,14);	spotDiameter		= GetItemValue(theDialog,19);	lensCurrent			= GetItemValue(theDialog,23);	apperatureRadius	/= owner->cameraConstant;}void	ObjectiveLens::DrawTransferFunction(Rect graphRect){		char			theText[255];	long			**theValue;	SpotInfoPtr	line;	long				i;	long				j;	double			maxInten;		GraphFunction* aGraph;	if(!theGraph){		aGraph = (GraphFunction*)D_new(GraphFunction);		aGraph	-> 	DoInit(graphRect,owner->theCrystal[0]->crystalColor,false,false);		theGraph = (GraphFunction*)D_new(GraphSpots);		theGraph->DoInit(graphRect,owner->theCrystal[0]->crystalColor,false,false);		theGraph->InitGraphSpace(graphRect);		sprintf(theText,"C. T. F.");		theGraph->SetTitleY(theText);		theGraph->SetTitleGraph(theText);		sprintf(theText,"g-vector -1");		theGraph->SetTitleX(theText);		theGraph->AddGraph(theGraph,aGraph,graphRect);	}	if(!theGraph) return;	theValue	= (long**)D_NewHandle(sizeof(long) * 2);	if(!lines)	lines	= (SpotInfoHandle)D_NewHandle(sizeof(SpotInfo) * MAX_STORE_DSPACE);	i = 1;	D_HLock((Handle)lines);	line = *lines;	maxInten = 0;	while(i < MAX_STORE_DSPACE && gCurrentObj->theCrystal[gCurrentObj->baseCrystal]->dspacings[i].x >= 0){		if(gCurrentObj->baseCrystal < 4)			*line = gCurrentObj->theCrystal[gCurrentObj->baseCrystal]->dspacings[i];		else{			*line = gCurrentObj->theCrystal[0]->dspacings[i];					}		if(fabs(line->intensity) > maxInten && i != 0)maxInten = fabs(line->intensity);		line->y = 1 / line->x;		i++;		line++;	}	line = *lines;	for(j = 0;  j < i; j++,line++){		line->intensity /= maxInten;	}	**theValue = (long)i - 1;	D_HUnlock((Handle)lines);	theGraph->SetValues((Handle)lines,(Handle)theValue);	KillHandle((Handle*)&theValue);				theGraph->next->SetValues((Handle)0L,(Handle)tFValues);	theGraph	->	minX = 0;	theGraph	->	maxX = apperatureRadius;		theGraph	->GetMinMax(theGraph	->yData,&theGraph	->minY,&theGraph	->maxY,theGraph	->noPtsY);	theGraph	->Normalize(theGraph	->yData,theGraph	->maxY,theGraph	->noPtsY);	theGraph	->GetMinMax(theGraph	->yData,&theGraph	->minY,&theGraph	->maxY,theGraph	->noPtsY);	theGraph	->ResetPlotMinMax();	theGraph->next->NormalizeToOwner(theGraph);		theGraph->next->plotGraph = true;	theGraph->PlotGraph();	}void	ObjectiveLens::CalculateScherzer(void){	scherzerDefocus = -sqrt(fabs(sphericalAberration * 1e7) * 1.33333 * wavelength);	ptToptRes		=	.66667 * pow(wavelength,.75) * pow(sphericalAberration * 1e7,.25);	infoLimit		=	 sqrt(PI * fabs(defocusSpread) * wavelength) / 1.8242;		maxDelE 	=	1.060 * voltage / (chromaticAberration * 1e7 * wavelength * infoLimit * infoLimit);	gauseDefocus	=	-.3 * sqrt(fabs(sphericalAberration * 1e7) * wavelength);}void	ObjectiveLens::CalculateTransferFunction(void){	short 	i,k;	double	delR,rValue = 0;	double	theValue;	double	*x;	k = 0;	if(tFValues != 0L) KillHandle((Handle*)&tFValues);	tFValues = (double**)D_NewHandle(sizeof(double) * maxCount);		D_HLock((Handle)tFValues);	x = *tFValues;	theValue = maxCount;	voltage				=	owner->energy * 1000;	wavelength			=	owner->wavelength;		delR = (apperatureRadius) / (theValue);		for(i = 0,k = 0; i < maxCount;i++,rValue += delR,x++, k++)	{		dcomplex value;		 value =  CalculateTransferValue(rValue,0);		*x = value.i;	}	D_HUnlock((Handle)tFValues);}void ObjectiveLens::CalcPlaneTransferFunction(void){	short 	i,k;	double	delR,rValue = 0;	double	theValue;	double	*x;	k = 0;	if(tFValues != 0L) 		KillHandle((Handle*)&tFValues);	tFValues 		= 		(double**)D_NewHandle(sizeof(double) * maxCount);		D_HLock((Handle)tFValues);	x = *tFValues;	theValue = maxCount;	voltage				=	owner->energy * 1000;	wavelength			=	owner->wavelength;	delR = (2 * apperatureRadius + (.02 * apperatureRadius)) / (theValue);	for(i = 0,k = 0; i < maxCount;i++,rValue += delR,x++, k++)	{		dcomplex value;		 value =  CalculateTransferValue(rValue,0);			value.i = *x;	}	D_HUnlock((Handle)tFValues);}void	ObjectiveLens::DrawScherzer(DialogPtr theDialog,short itemNo){	double aValue,bValue;	TextFont(geneva);	TextSize(9);	aValue = infoLimit * infoLimit / (3 * wavelength);	if(aValue < defocusSpread)		aValue = defocusSpread;	sprintf(gTheText,"Scherzer Defocus = %6.1f  \r Pt to Pt Res. = %5.1f\rInfo. Limit = %5.1f \rGauss Defocus = %6.1f\rSug. Step = () %5.1f\rMax. delE = %5.2f",			scherzerDefocus,ptToptRes,infoLimit,gauseDefocus,aValue,delVoltage);							GetDItem(theDialog,itemNo,&gType,&gTheHandle,&gTheRect);	SetIText(gTheHandle,c2pstr(gTheText));	aValue = fabs(sphericalAberration * 1e7 * wavelength);	bValue = fabs(pow(fabs(sphericalAberration * 1e7),.25) * pow(wavelength,.75));	sprintf(gTheText," Broad Contrast Intervals\rDefocus (), Center of Interval ()\r  %5.1f  , %5.1f\r  %5.1f,  %5.1f\r  %5.1f,  %5.1f\r %5.1f ,  %5.1f",			-sqrt(aValue),bValue,-sqrt(3 * aValue),.74 * bValue,			-sqrt(5 * aValue),.65 * bValue,			-sqrt(7 * aValue), .61 * bValue);							GetDItem(theDialog,itemNo + 1,&gType,&gTheHandle,&gTheRect);	SetIText(gTheHandle,c2pstr(gTheText));		TextFont(0);	TextSize(0);}dcomplex	ObjectiveLens::CalculateTransferValue(double rValue,double angle/*,short i*/){		double 	phi;	double	rValueSqr,wavelength3;	double 	chi;	double	astig;	double	aValue;	double 	divergens;	double	chrome;	dcomplex transferValue;	phi = angle - stigmaticAngle;	phi *= PI/180;	rValueSqr = (rValue * rValue);	wavelength3 = wavelength * wavelength * wavelength;	if(rValue < apperatureRadius){		double bValue;				chi = (PI * wavelength * defocus * rValueSqr) + (.5 * PI *				(sphericalAberration * 10000000) * (rValueSqr * rValueSqr) * wavelength3);				astig = (.5 * PI * wavelength * astigmatism * 1e7 * rValueSqr * cos(2 * phi));		aValue = (.5 * PI * PI * wavelength * wavelength * defocusSpread * defocusSpread				* rValueSqr * rValueSqr);		chrome = exp(-aValue);				aValue = ((defocus * fabs(rValue)) + (sphericalAberration * 1e7 * wavelength * wavelength						* fabs(rValueSqr * rValue)));						divergens = exp(-PI * PI * convergenceAngle * convergenceAngle * aValue * aValue);							bValue = sin(astig);		aValue = cos(astig);		transferValue.i = sin(chi) *  chrome * divergens * sqrt(aValue * aValue) - (bValue * bValue);		transferValue.r = cos(chi)  *  chrome * divergens * sqrt(aValue * aValue) - (bValue * bValue);				return transferValue;	}else{		transferValue.r = transferValue.i = 0;		return transferValue; 	}}void	ObjectiveLens::CalculateDefocuSpread(void){	double cameraLength,ratioI,ratioV;		cameraLength 		= 	owner->cameraConstant/ owner->wavelength;	convergenceAngle 	=   spotDiameter / cameraLength;	if(chromeSpread){		delVoltage = voltage * defocusSpread / (chromaticAberration * 1e+7);		delCurrent = 0;	 return;	}	ratioV = (delVoltage / voltage);	ratioI = (delCurrent)/(lensCurrent * 1000000);	defocusSpread = chromaticAberration * 1e+7 * sqrt(ratioV * ratioV + (2 * ratioI * ratioI));}void	ObjectiveLens::DoClose(void){	if(tFValues != 0L)		KillHandle((Handle*)&tFValues);	if(theGraph)theGraph->DoClose(theGraph);	//if(lines)KillHandle((Handle*)&lines);	D_delete(this);	return;}void	ObjectiveLens::DoInit(DiffractObject *theOwner){	 	sphericalAberration = 	1.0; 	chromaticAberration = 	1.2; 	apperatureRadius    = 	1.0; 	delVoltage			= 	1; 	delCurrent			= 	1e-6; 	chromeSpread		=	false;	convergenceAngle	=	0; 	astigmatism			=	0;	stigmaticAngle		=	0;	defocus				=	0;	maxCount			=	200;	defocusSpread		=	100;	voltage				=	theOwner->energy * 1000;	wavelength			=	theOwner->wavelength;	spotDiameter		=	0;	tFValues 			= 	0L;	owner				=	theOwner;	lensCurrent			=	4;	theGraph				=	0L;	lines						=	0L;}