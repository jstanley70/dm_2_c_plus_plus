#include	"Diffract_INCs.h"#include 	"AtomicScatter.h"#include 	"AtomData.h"#include "UextBoxFree.h"Boolean	DblClick(Point thePoint);void AtomData::DoDialog(void){	DialogPtr 		theDialog;	short 			k,i,theItem;	AtomicScatter 	*atomicScatter;	Boolean 		sameSeg;	Rect 			rDataBnds,theRect;	Rect			tRect;	Cell			theCell,cellSize;	TextBoxFree		*textBox;	char*			theText;	char**			theResHnd;	short			j,l,n,p;	GraphFunction	*graph = 0L;	PopUpMenu		*menu1,*menu2;	double			**x,**y;	double			*xx,*yy;	double **xH;	double minX = -.1;	Crystal *theCrystal;	theCrystal = (Crystal*)D_new(Crystal);	theCrystal->InitCrystal(0);		theDialog = DM_GetNewDialog(128, 0L,(WindowPtr)-1L);	textBox				=	(TextBoxFree*)D_new(TextBoxFree);	SetRect(&rDataBnds,0,0,23,31);	GetDItem			(theDialog,6,&gType,&gTheHandle,&gTheRect);	tRect = theRect = gTheRect;	tRect.right += 32;	tRect.bottom += 32;	theRect.right -= 30;	cellSize.h = 65;	cellSize.v = 15;		menu1 	= (PopUpMenu*)D_new(PopUpMenu);	menu1	->	Init(theDialog,3,73,1);	menu1	->	SetPopUp();		menu2 	= (PopUpMenu*)D_new(PopUpMenu);	menu2	->	Init(theDialog,4,73,2);	menu2	->	SetPopUp();		textBox		-> DoInit(&theRect,&rDataBnds,cellSize,0,theDialog,true,false,true,true,false,false,geneva,9,0);	 TMX_SetOptions(tmBorder,textBox		->theList);	 //TMX_SetBorderFont(tmBorder,textBox		->theList);	 TMX_SetBorderSize(16,85,textBox		->theList);	textBox		-> ResetCell();	textBox		-> selected = true;	GetDItem			(theDialog,8,&gType,&gTheHandle,&textBox		->iconBox);	//textBox		-> SetColumnWidth(0,140);	//textBox		-> selected = false;	theResHnd = (char**)GetResource('AtIn',128);	D_HLock((Handle)theResHnd);	theText = (char*)*theResHnd;	 j = 0;	while(*theText != 0){		char text[255];		i = 0;		while(*theText != 'Á' && *theText != 0){text[i] = *theText; theText++;i++;}		text[i] = 0;		textBox->SetRowTitle(text,j);		j++;		theText++;	}	D_HUnlock((Handle)theResHnd);	ReleaseResource((Handle)theResHnd);	theCell.h = 0;	theCell.v = 0;	for(i = 0;i < 27;i++){		sameSeg = true;		k = 0;		theCell.h = 0;		while(sameSeg){			sameSeg = GetTheText(i,k,gTheText);			if(sameSeg) textBox->SetListText(gTheText, 	theCell);			theCell.h++;			k++;		}				textBox->SetListText(gTheText, 	theCell);		theCell.v++;	}	atomicScatter = (AtomicScatter*)D_new(AtomicScatter);	atomicScatter->SetGeneralListing(theCell, true,textBox,1,atomNumber);	theCell.v += 2;	atomicScatter->SetGeneralListing(theCell, true,textBox,2,atomNumber);		atomicScatter->Kill();	textBox->SetDrawFlag(true);	/* DrawDialog(theDialog); */	while(1 != 2){		Point thePoint;		SystemTask();		ModalDialog(MLogFilterUPP/*TheFilterUPP*/,&theItem);		switch(theItem){			case CANCELCLICK:			case 1:			menu1 ->DoClose();			menu2 ->DoClose();			if(graph)graph->	DoClose			(0L);			textBox->DoClose();				theCrystal->DoClose();			DM_DisposDialog(&theDialog);			//OutputTextAllAtoms();			//OutPutAllAtomicScatteringInXml();			return;			case ML_UPDATE_EVT:				BeginUpdate(theDialog);				DrawDialog(theDialog);				if(graph){					EraseRect(&graph->graphRect);					graph->PlotGraph();				}				if(textBox)textBox->DrawList();				EndUpdate(theDialog);				break;			case 2:				atomicScatter = (AtomicScatter*)D_new(AtomicScatter);				atomicScatter->DoDefine(atomNumber,1);				atomicScatter->Kill();				FlushEvents (everyEvent,0);				dm_EraseRect(&theDialog->portRect);				DrawDialog(theDialog);				dm_EraseRect(&tRect);				menu1 ->SetPopUp();				menu2 ->SetPopUp();				if(graph)textBox->SetDrawFlag(false);				else					textBox->SetDrawFlag(true);				textBox->DrawList();				if(graph)graph	->PlotGraph();				break;			case 3:				menu1 ->DoPopUp();				break;			case 4:				menu2-> DoPopUp();				break;			case 5:				dm_EraseRect(&theDialog->portRect);				DrawDialog(theDialog);				dm_EraseRect(&tRect);				textBox->shrunk = true;				if(graph){					graph	->shrunk = false;					textBox->SetDrawFlag(false);					textBox->DrawList();					GetDItem			(theDialog,8,&gType,&gTheHandle,&graph->iconBox);					GetDItem			(theDialog,6,&gType,&gTheHandle,&gTheRect);					SetRect	(&theRect,gTheRect.left + 50,gTheRect.top + 30,gTheRect.right - 10,gTheRect.bottom - 60);					graph->SetFrame		(theRect);				}				j = atomNumber;				if(!graph){					GetDItem			(theDialog,6,&gType,&gTheHandle,&gTheRect);					SetRect	(&theRect,gTheRect.left + 50,gTheRect.top + 30,gTheRect.right - 10,gTheRect.bottom - 60);					graph	= (GraphFunction*)D_new(GraphFunction);					graph	->	DoInit(theRect,gCurrentObj->theCrystal[gCurrentObj->baseCrystal]->crystalColor,true,false);					GetDItem			(theDialog,8,&gType,&gTheHandle,&graph->iconBox);					sprintf(gTheText,"atomic plots");					c2pstr(gTheText);					if(graph->titleMenu)					graph->titleMenu->P_AppendMenu(gTheText);					//AppendMenu	(g_Graph_Select_Menu,c2pstr(gTheText));					graph	->	active = true;					graph	->shrunk = false;				}				for(i = 0; i <=1;i++){					if(i == 0)k = menu1 ->lastResult;					else k = menu2 ->lastResult;					switch(k){						case 1:							l = 2;							sprintf(gTheText,"Atomic Number");						break;						case 2:							l = 3;							sprintf(gTheText,"Atomic Mass");						break;						case 3:							l = 5;							sprintf(gTheText,"Electron Affinity");						break;						case 4:							l = 6;							sprintf(gTheText,"Electron Negativity");						break;						case 5:							sprintf(gTheText,"Work Function");							l = 7;						break;						case 6:							sprintf(gTheText,"density");							l = 9;						break;						case 7:							l = 10;							sprintf(gTheText,"Melting Temperature");						break;						case 8:							l = 11;							sprintf(gTheText,"Boiling Temperature");						break;						case 9:							sprintf(gTheText,"Radii");							l = 13;						break;						case 10:							l = 14;							sprintf(gTheText,"Ionization Energy");						break;						case 14:							l = 15;							sprintf(gTheText,"Debye-Waller");						break;						case 15:							l = 16;							sprintf(gTheText,"Debye Temp");						break;						case 11:							l = 27;							sprintf(gTheText,"Electron Atomic Scatter");						break;						case 12:							l = 28;							sprintf(gTheText,"X-ray Atomic Scatter");						break;						case 13:							l = 29;							sprintf(gTheText,"Atomic Absorption");						break;					}					if(i == 0){						p = l;						 graph	->SetTitleX(gTheText);					}else{						 n = l;						 graph	->SetTitleY(gTheText);					}				}								if(p < 26 && n < 26){					minX = -.1;					x = (double**)D_NewHandle(sizeof(double) * 100);					y = (double**)D_NewHandle(sizeof(double) * 100);					D_HLock((Handle)y);					D_HLock((Handle)x);					xx = *x;					yy = *y;					for(i = 0; i < 100;i++){						atomNumber = i;						if(p == 13){							xx[i]	= ReturnRadius('c');						}else if(p == 15){							xx[i] = GetDebyeWaller(theCrystal);						}else if(p == 16){							xx[i] = GetDebyeTemp(theCrystal);						}else{							sameSeg = GetTheText(p,0,gTheText);							xx[i]	= atof(gTheText);							}						if( n == 13){							yy[i]	= ReturnRadius('c');						}else if(n == 15){							yy[i] = GetDebyeWaller(theCrystal);						}else if(n == 16){							yy[i] = GetDebyeTemp(theCrystal);						}else{							sameSeg = GetTheText(n,0,gTheText);							yy[i]	= atof(gTheText);							}					}					D_HUnlock((Handle)y);					D_HUnlock((Handle)x);				}else if(p < 29 || n < 29){										atomicScatter = (AtomicScatter*)D_new(AtomicScatter);					if(p != n){						if(p == 29 || n == 29){if(minX > 3)minX = 0;else minX += .1;						sprintf(gTheText,"Abs. s|%2.1f",minX);if(p == 29)graph	->SetTitleX(gTheText);						else graph	->SetTitleY(gTheText);}						x = (double**)D_NewHandle(sizeof(double) * 100);						y = (double**)D_NewHandle(sizeof(double) * 100);						D_HLock((Handle)y);						D_HLock((Handle)x);						xx = *x;						yy = *y;						for(i = 0; i < 100;i++){							atomNumber = i;							if(p < 26){								if(p == 13){									xx[i]	= ReturnRadius('c');								}else if(p == 15){									xx[i] = GetDebyeWaller(theCrystal);								}else if(p == 16){									xx[i] = GetDebyeTemp(theCrystal);								}else{									sameSeg = GetTheText(p,0,gTheText);									xx[i]	= atof(gTheText);									}							}else{								if(p > 28){									xH = GetAbsorptionCurve(theCrystal,0,0,0,1,minX,1,gCurrentObj->energy);									xx[i] = **xH;									if(xx[i] > 1)xx[i] = 1;									KillHandle((Handle*)&xH);								}else{									atomicScatter->GetAtomicAmps( i, p - 26);									xx[i]	= atomicScatter->atomicAmps[0];									}							}							if(n < 26){								if( n == 13){									yy[i]	= ReturnRadius('c');								}else if(n == 15){									yy[i] = GetDebyeWaller(theCrystal);								}else if(n == 16){									yy[i] = GetDebyeTemp(theCrystal);								}else{									sameSeg = GetTheText(n,0,gTheText);									yy[i]	= atof(gTheText);									}							}else{								if(n > 28){									xH = GetAbsorptionCurve(theCrystal,0,0,0,1,minX,12,gCurrentObj->energy);									yy[i] = **xH;									if(yy[i] > 3)yy[i] = 0;									KillHandle((Handle*)&xH);								}else{									atomicScatter->GetAtomicAmps( i, n - 26);									yy[i]	= atomicScatter->atomicAmps[0];									}							}						}						D_HUnlock((Handle)y);						D_HUnlock((Handle)x);					}else{						double theSs[23];						sprintf(gTheText,"s");						graph	->SetTitleX(gTheText);						sprintf(gTheText,"Atomic Scatter");						graph	->SetTitleY(gTheText);						y = (double**)D_NewHandle(sizeof(double) * 23);						D_HLock((Handle)y);						yy = *y;						x = (double**)D_NewHandle(sizeof(double) * 23);						D_HLock((Handle)x);						xx = *x;						k = p;						if(k < n)k = n;						atomicScatter->GetAtomicAmps( atomNumber, k - 26);						atomicScatter->sValues(theSs);						for(i = 0; i < 23;i++){							yy[i]	= atomicScatter->atomicAmps[i];								xx[i] 	= theSs[i];						}						D_HUnlock((Handle)y);						D_HUnlock((Handle)x);					}					atomicScatter->Kill();				}else{					double delX;										sprintf(gTheText,"s");					graph	->SetTitleX(gTheText);					sprintf(gTheText,"Atomic Absorption");					graph	->SetTitleY(gTheText);					x = (double**)D_NewHandle(sizeof(double) * 100);					D_HLock((Handle)x);					xx = *x;					delX = 0;					for(i = 0; i < 100;i++,delX += .1,xx++){						*xx 	= delX;					}					y = GetAbsorptionCurve(theCrystal,0,0,0,6,0,100,gCurrentObj->energy);					D_HUnlock((Handle)x);				}													graph	->	SetValues			((Handle)x,(Handle)y);				if(x != 0L)KillHandle((Handle*)&x);				KillHandle((Handle*)&y);				graph	->ResetPlotMinMax	();				graph	->PlotGraph();				menu1 ->SetPopUp();				menu2 ->SetPopUp();								atomNumber = j;				break;			case 6:				GetMouse(&thePoint);				textBox->DoContent(thePoint);				if(graph){					if(graph->DoSelect(thePoint)){								graph->DoContent(thePoint);											}else{						graph->ClearSelects();					}				}								menu1 ->SetPopUp();				menu2 ->SetPopUp();								textBox->DrawList();				break;			case 7:				dm_EraseRect(&theDialog->portRect);				DrawDialog(theDialog);				menu1 ->SetPopUp();				menu2 ->SetPopUp();				textBox->shrunk = false;				if(graph)graph	->shrunk = true;				textBox->SetDrawFlag(true);				textBox->DrawList();								if(graph)graph	->PlotGraph();				break;			case 10:				atomNumber++;				if(atomNumber > 101)atomNumber = 101;				theCell.h = 0;				theCell.v = 0;				for(i = 0;i < 27;i++){					sameSeg = true;					k = 0;					theCell.h = 0;					while(sameSeg){						sameSeg = GetTheText(i,k,gTheText);						if(sameSeg) textBox->SetListText(gTheText, 	theCell);						theCell.h++;						k++;					}										textBox->SetListText(gTheText, 	theCell);					theCell.v++;				}				atomicScatter = (AtomicScatter*)D_new(AtomicScatter);				atomicScatter->SetGeneralListing(theCell, true,textBox,1,atomNumber);				theCell.v += 2;				atomicScatter->SetGeneralListing(theCell, true,textBox,2,atomNumber);								atomicScatter->Kill();				dm_EraseRect(&theDialog->portRect);				DrawDialog(theDialog);				dm_EraseRect(&tRect);				menu1 ->SetPopUp();				menu2 ->SetPopUp();				if(!textBox->shrunk)textBox->SetDrawFlag(true);				textBox->DrawList();				if(graph)graph	->PlotGraph();				break;			case 11:				atomNumber--;				if(atomNumber < 1)atomNumber = 1;				theCell.h = 0;				theCell.v = 0;				for(i = 0;i < 27;i++){					sameSeg = true;					k = 0;					theCell.h = 0;					while(sameSeg){						sameSeg = GetTheText(i,k,gTheText);						if(sameSeg) textBox->SetListText(gTheText, 	theCell);						theCell.h++;						k++;					}										textBox->SetListText(gTheText, 	theCell);					theCell.v++;				}				atomicScatter = (AtomicScatter*)D_new(AtomicScatter);				atomicScatter->SetGeneralListing(theCell, true,textBox,1,atomNumber);				theCell.v += 2;				atomicScatter->SetGeneralListing(theCell, true,textBox,2,atomNumber);								atomicScatter->Kill();				dm_EraseRect(&theDialog->portRect);				DrawDialog(theDialog);				dm_EraseRect(&tRect);				menu1 ->SetPopUp();				menu2 ->SetPopUp();				if(!textBox->shrunk)textBox->SetDrawFlag(true);				textBox->DrawList();				if(graph)graph	->PlotGraph();				break;			 default:				GetMouse(&thePoint);				if(Button() && DblClick( thePoint)){					textBox->DoDblClick(thePoint);					if(graph)graph->DoDblClick(thePoint);				}								if(Button())textBox->DoContent(thePoint);				textBox->DoIdle();				if(graph)graph->DoIdle();				break;					}	}}double**  AtomData::GetAbsorptionCurve(Crystal *theCrystal,double h,double k,double l,double maxX,double minX,short reso,double kV){	long 	i;	Atom  	atomicPosition,*theAtoms;	double 	*theUs,*theVs,*theWs,*theZs,*theBs;	double 	r;	long 	num;	double 	**x,*xx;	double delX;	dcomplex cAb;	Boolean		theFlag;			theFlag = g_absorpFlag;	g_absorpFlag = true;		r	= 2 * ReturnRadius('c');	theCrystal->theUnitCell.a = r;	theCrystal->theUnitCell.b = r;	theCrystal->theUnitCell.c = r;	theAtoms = 	*theCrystal->theAtoms;		theAtoms->atomicNum = atomNumber + 1;	num = theCrystal->atom_Count + 1;		theUs = (double*)D_NewPtr(5L * num * sizeof(double));	if(!PtrIsOK((Ptr)theUs))		return 0L;	theVs = &theUs[num];	theWs = &theVs[num]; 	theZs = &theWs[num];	theBs = &theZs[num];	theAtoms = 	*(theCrystal->theAtoms);		theCrystal->CorrectDWToTemp(gCurrentObj->temperature + 273.15);	for(i = 0; i < num; i++)	{		atomicPosition = theAtoms[i];		theUs[i] = atomicPosition.x;		theVs[i] = atomicPosition.y;		theWs[i] = atomicPosition.z;		theBs[i] = atomicPosition.bi;	}	r = reso;	delX = (maxX - minX) / r;	x = (double**)D_NewHandle(sizeof(double) * reso);	if(!x){		g_absorpFlag = theFlag;		return 0L;	}	D_HLock((Handle)x);	xx = *x;	for(i = 0; i < reso;i++,minX += delX,xx++){		cAb = AbsorptionCoefficient( h, k, l,theUs,theVs,theWs,theCrystal,theBs,kV, minX);		*xx = Cabs(cAb);	}	KillPtr((Ptr)theUs);	D_HUnlock((Handle)x);	g_absorpFlag = theFlag;	return x;}double  AtomData::GetDebyeWaller(Crystal *theCrystal){	Atom  	*theAtoms;	double x;	theAtoms = 	*theCrystal->theAtoms;		theAtoms->atomicNum = atomNumber + 1;	theCrystal->CorrectDWToTemp(gCurrentObj->temperature + 273.15);	theAtoms = 	*theCrystal->theAtoms;		x = theAtoms->bi;	return x;}double AtomData::GetDebyeTemp(Crystal *theCrystal){	Atom  	*theAtoms;	theAtoms = 	*theCrystal->theAtoms;		theAtoms->atomicNum = atomNumber + 1;	return theCrystal->CorrectAtomDWToTemp(theAtoms,gCurrentObj->temperature + 273.15);}Boolean	DblClick(Point thePoint){	static long oldTime = 0;	long newTime;	static Point oldPoint;	long	dblTime;	dblTime = LMGetDoubleTime();		newTime = TickCount();	if(newTime - oldTime < dblTime && fabs((double)(oldPoint.h - thePoint.h)) <= 2  		&& fabs((double)(oldPoint.v - thePoint.v)) <= 2){		return true;	}	oldPoint = thePoint;	oldTime = newTime;	return false;}double AtomData::OutputTextAllAtoms(){	char endTag[40][255];	char startTag[40][255];	char*			theText;	char**			theResHnd;	short j,k,i,l;	char**  		xmlDocument;	Boolean sameSeg;	xmlDocument 	= 	D_NewHandle(1000);	theResHnd = (char**)GetResource('AtIn',128);	D_HLock((Handle)theResHnd);	theText = (char*)*theResHnd;	 j = 0;	 	while(*theText != 0){				i = 1;		l = 2;		startTag[j][0] = '<';		 endTag[j][0] = '<';		 endTag[j][1] = '/';		while(*theText != 'Á' && *theText != 0){endTag[j][l++] = startTag[j][i++] = *theText; theText++;}		startTag[j][i++] = '>';		startTag[j][i] = 0;				endTag[j][l++] = '>';		endTag[j][l] = 0;				j++;		theText++;	}	D_HUnlock((Handle)theResHnd);	ReleaseResource((Handle)theResHnd);	j = 0;	xmlDocument = WriteToXmlString(xmlDocument,"<AtomicInfo>");	for(atomNumber = 1;atomNumber <= 103;atomNumber++){		j = 0;		for(i = 0;i < 27;i++){			xmlDocument = WriteToXmlString(xmlDocument,startTag[j]);			sameSeg = true;			k = 0;						while(sameSeg){				sameSeg = GetTheText(i,k,gTheText);				if(sameSeg)				{										xmlDocument = WriteToXmlString(xmlDocument,"<seg>");					xmlDocument = WriteToXmlString(xmlDocument,gTheText);					xmlDocument = WriteToXmlString(xmlDocument,"</seg>");									}								k++;			}			xmlDocument = WriteToXmlString(xmlDocument,"<seg>");			xmlDocument = WriteToXmlString(xmlDocument,gTheText);			xmlDocument = WriteToXmlString(xmlDocument,"</seg>");			xmlDocument = WriteToXmlString(xmlDocument,endTag[j]);			j++;		}	}	xmlDocument = WriteToXmlString(xmlDocument,"</AtomicInfo>");	gTheFile->SaveFileOpen('TEXT');		gTheFile->WriteHandle((Handle)xmlDocument);			gTheFile->DoFileClose();		KillHandle(&xmlDocument);	return 1;	}double AtomData::OutPutAllAtomicScatteringInXml(void){	double theSs[23];	char**  		xmlDocument;	short k;	short i;	AtomicScatter 	*atomicScatter;	atomicScatter = (AtomicScatter*)D_new(AtomicScatter);		xmlDocument 	= 	D_NewHandle(1000);						sprintf(gTheText,"s");	WriteToXmlString(xmlDocument,"<PeriodicScattering>");		for(atomNumber = -153; atomNumber < 743;atomNumber++){		if(!atomicScatter->GetAtomicAmps( atomNumber,1)) continue;			sprintf(gTheText,"%d",atomNumber);			WriteToXmlString(xmlDocument,"<scatteringfactor>");			WriteToXmlString(xmlDocument,"<Atomic_Number>");		WriteToXmlString(xmlDocument,gTheText);					for(k = 1; k <4;k++){			switch(k){					case 1:						xmlDocument = WriteToXmlString(xmlDocument,"<electron>");					break;					case 2:						xmlDocument = WriteToXmlString(xmlDocument,"<x_ray>");					break;					case 3:						xmlDocument = WriteToXmlString(xmlDocument,"<nuetron>");					break;				}			if(atomicScatter->GetAtomicAmps( atomNumber,k)){				atomicScatter->sValues(theSs);				for(i = 0; i < 23;i++){					sprintf(gTheText,"%6.4f",theSs[i]);						xmlDocument = WriteToXmlString(xmlDocument,"<s_angle>");					xmlDocument = WriteToXmlString(xmlDocument,gTheText);					xmlDocument = WriteToXmlString(xmlDocument,"</s_angle>");										sprintf(gTheText,"%6.4f",atomicScatter->atomicAmps[i]);						xmlDocument = WriteToXmlString(xmlDocument,"<scatterFactor>");					xmlDocument = WriteToXmlString(xmlDocument,gTheText);					xmlDocument = WriteToXmlString(xmlDocument,"</scatterFactor>");																		}							}			switch(k){					case 1:						xmlDocument = WriteToXmlString(xmlDocument,"</electron>");					break;					case 2:						xmlDocument = WriteToXmlString(xmlDocument,"</x_ray>");					break;					case 3:						xmlDocument = WriteToXmlString(xmlDocument,"</nuetron>");					break;				}		}		WriteToXmlString(xmlDocument,"</Atomic_Number>");		WriteToXmlString(xmlDocument,"</scatteringfactor>");		}	atomicScatter->Kill();	WriteToXmlString(xmlDocument,"</PeriodicScattering>");		gTheFile->SaveFileOpen('TEXT');		gTheFile->WriteHandle((Handle)xmlDocument);			gTheFile->DoFileClose();		KillHandle(&xmlDocument);	return 1;}