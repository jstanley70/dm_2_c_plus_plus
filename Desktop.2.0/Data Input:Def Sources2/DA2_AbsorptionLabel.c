#include "AbsorptionLabels.h"#include	"Diffract_INCs.h"void AbsorptionLabel::DoInit(void){	element = 0;	lineID = 0;	lineEV = 0;	intensity = 0;			next = 0L;	}Ptr AbsorptionLabel::GetTextualInfo(long *handleSize){	long size;	AbsorpLine *theLine;	long	i;	char *startText;	Handle	theHandle;	theHandle = GetInfoPtr(&size);	size += 96;	 HLock(theHandle);	theLine =  (AbsorpLine*)*theHandle;	startText	=  D_NewPtr(size * 22);	startText[0] = 0;	for(i = 0; i < size;i++,theLine++){		sprintf(gTheText,"%8.3f\t%8.3f\r",theLine->lineEV,theLine->intensity);		strcat(startText,gTheText);	}		*handleSize = strlen(startText);	return startText;}void AbsorptionLabel::DoClose(void){	if(next != 0L)next -> DoClose();	D_delete(this);}Handle AbsorptionLabel::GetInfoPtr(long *handleSize){	Handle aHandle;	aHandle = (Handle)GetResource('info',500);	*handleSize = GetHandleSize(aHandle);	*handleSize /= sizeof(AbsorpLine);	*handleSize -= 96;	return aHandle;}AbsorptionLabel* AbsorptionLabel::FindLines(double eV){	Handle theHandle;	float		*theFloat;	AbsorpLine	*thePtr;	short		i,j = 0,k = 0;	long		handleSize;	AbsorptionLabel	*workingLine,*incrementPtr;	short		lineMatrix[134] = {3,3,10,28,13,36,19,/*k lines*/									72,72,71,70,67,70,73,85,31,72,									70,72,88,72,72,63,79,20,20,20,46,63,21,39,									21,21,57,80,37,78,39,39,31,49,72,21,57,37,									16,16,72,70,58,58,60,37,35,41,32,35,68,73,									73,73,73,40,48,57,57,51,41,39,39,68,68,10,									11,14,16,11,11,11,11,6,14,11,28,29,28,32,31,									13,15,12,11,11,71,42,31,26,27,37,37,41,58,66,									73,75,62,73,58,26,42,40,40,73,74,75,75,44,40,									42,77,76,55,41,40,73,58,71,71,91,70,72,64,70,									81};	short		numOfLines[134] = {92,92,85,67,82,59,76,/*k lines*/									11,23,24,25,28,25,22,10,64,23,									25,23,7,23,23,32,16,75,75,75,49,32,74,56,									74,74,38,15,58,17,56,56,64,46,23,74,38,									58,79,79,23,25,37,37,35,14,60,54,20,60,									27,22,22,22,22,55,34,38,38,44,54,56,56,									27,27,26,27,32,12,35,5,5,6,26,15,19,4,									18,23,15,16,19,29,35,6,10,24,6,49,27,29,									19,19,15,37,29,22,20,33,9,12,24,6,55,55,									22,21,20,20,16,16,8,11,12,7,42,43,9,12,									24,24,4,25,23,31,25,14};	theHandle	= GetInfoPtr(&handleSize);	D_HLock(theHandle);	theFloat 	= (float*)*theHandle;	thePtr		= (AbsorpLine*)&theFloat[191];	workingLine = this;	for(i = 0;i < handleSize && j < 133; i++,thePtr++){		if(fabs(thePtr->lineEV - eV) < 100){			k = 0;			j = -1;			do{				j++;				k += numOfLines[j] + 1;			}while(k < i && j < 133);			workingLine->element 	= 	i - (k -  numOfLines[j]) + lineMatrix[j] + 1;			workingLine->lineID		=	j;			workingLine->lineEV 	= 	thePtr->lineEV;			workingLine->intensity 	= 	thePtr->intensity;			workingLine->next	=		(AbsorptionLabel*)D_new(AbsorptionLabel);			workingLine->next	->			DoInit();			incrementPtr		=		workingLine->next;			workingLine			=		incrementPtr;		}	}	D_HUnlock(theHandle);	ReleaseResource(theHandle);		return 0L;}void AbsorptionLabel::DrawLines(GraphFunction *graph){		if(next != 0L)next->DrawLines(graph);	graph->DrawSingleValue((double)lineEV/1000,(double)intensity + .05);	return ;}AbsorptionLabel*  AbsorptionLabel::DoPopUp(Point thePoint,double eV){	PopUpMenu *theMenu;	short		items;	short		i,theShort;	long		theResult;		FindLines(eV);	theMenu	=	(PopUpMenu*)D_new(PopUpMenu);		theMenu->InitAtPoint		( thePoint,1,114,false,true);		sprintf(gTheText,"Channel eV %6.2f",eV);	theMenu->P_AppendMenu	((char*)c2pstr(gTheText));	this->FillMenu(theMenu);	theResult = theMenu->HitPopUp(thePoint);	theShort = theMenu->lastResult;	items = theMenu->P_CountMItems();	for(i = items; i > 0;i--)theMenu->P_DelMenuItem(i);	theMenu->DoClose();	if(theResult){		return FindLineFromMenu(theShort,1);	}else	return 0L;}void AbsorptionLabel::DrawLabel(void){}AbsorptionLabel* AbsorptionLabel::FindLineFromMenu(short itemNo,short objectNo){	objectNo++;	if(itemNo == objectNo)return this;	if(next != 0L)return next->FindLineFromMenu(itemNo,objectNo);	return 0L;}void	AbsorptionLabel::FillMenu(PopUpMenu *theMenu){	if(element == 0)return;	sprintf(gTheText,"%d,%d,%5.3f,%6.1f",element,lineID,intensity,lineEV);	theMenu->P_AppendMenu((char*)c2pstr(gTheText));	if(next != 0L)next->FillMenu(theMenu);}void AbsorptionLabel::DoCopy(AbsorptionLabel *copyInto){	copyInto->lineEV 	= lineEV;	copyInto->intensity = intensity;	copyInto->element 	= element;	copyInto->lineID 	= lineID;	copyInto->next	 	= 0L;}void AbsorptionLabel::FindElementLines(short elNum){	Handle theHandle;	AbsorpLine	*thePtr,*foundPtr;	float		*theFloat;	AbsorptionLabel	*workingLine,*incrementPtr;	long			handleSize;	short		i;	short		lineMatrix[134] = {3,3,10,28,13,36,19,/*k lines*/									72,72,71,70,67,70,73,85,31,72,									70,72,88,72,72,63,79,20,20,20,46,63,21,39,									21,21,57,80,37,78,39,39,31,49,72,21,57,37,									16,16,72,70,58,58,60,37,35,41,32,35,68,73,									73,73,73,40,48,57,57,51,41,39,39,68,68,10,									11,14,16,11,11,11,11,6,14,11,28,29,28,32,31,									13,15,12,11,11,71,42,31,26,27,37,37,41,58,66,									73,75,62,73,58,26,42,40,40,73,74,75,75,44,40,									42,77,76,55,41,40,73,58,71,71,91,70,72,64,70,									81};	short		numOfLines[134] = {92,92,85,67,82,59,76,/*k lines*/									11,23,24,25,28,25,22,10,64,23,									25,23,7,23,23,32,16,75,75,75,49,32,74,56,									74,74,38,15,58,17,56,56,64,46,23,74,38,									58,79,79,23,25,37,37,35,14,60,54,20,60,									27,22,22,22,22,55,34,38,38,44,54,56,56,									27,27,26,27,32,12,35,5,5,6,26,15,19,4,									18,23,15,16,19,29,35,6,10,24,6,49,27,29,									19,19,15,37,29,22,20,33,9,12,24,6,55,55,									22,21,20,20,16,16,8,11,12,7,42,43,9,12,									24,24,4,25,23,31,25,14};		short		theX = 60,theY = 60;	Rect		eraseRect;	SetRect(&eraseRect,40,40,300,300);	theHandle	= GetInfoPtr(&handleSize);	D_HLock(theHandle);	theFloat 	= (float*)*theHandle;	thePtr		= (AbsorpLine*)&theFloat[191];	workingLine = this;	//dm_EraseRect(&eraseRect);	for(i = 0; i < 133;i++){		if(elNum > lineMatrix[i] && elNum <= numOfLines[i] + lineMatrix[i]){			foundPtr	=	&thePtr[elNum - lineMatrix[i]];			workingLine->lineEV = 		foundPtr->lineEV;			workingLine->intensity = 	foundPtr->intensity;			workingLine->element = 		elNum;			workingLine->lineID = 		i;			sprintf(gTheText,"%d,%d,%5.3f,%6.1f",workingLine->element,workingLine->lineID,workingLine->intensity,workingLine->lineEV);			workingLine->next	=	(AbsorptionLabel*)D_new(AbsorptionLabel);			workingLine->next	->	DoInit();			incrementPtr		=	workingLine->next;			workingLine			=	incrementPtr;			/*MoveTo(theX,theY);			DrawString(c2pstr(gTheText));			theY += 16;*/		}		thePtr = &thePtr[numOfLines[i] + 1];	}	D_HUnlock(theHandle);}