#include	"Diffract_INCs.h"#include	"ST_StereoMacros.c"#include	"UT_VectorMacros.c"#include 	"OneDisObj.h" #include	"SADObj.h" 			//Macintosh HD:CodeWarriorª DR/3 Gold Ä:Metrowerks  C/C++ Ä:Projects:D.M. v2.0:Sources.Jim:Desktop.2.0:Defects 2:DE2_OneDisObjOld.cvoid OneDisObj::DoInit(){	inherited::DoInit();	data_Length			=	100;	data_Expand			=	100;	data_Count			=	0;	data_Size			=	sizeof(float);	toggleDraw					=		true;	nEW = 6;	NP[0] 	= 1;NP[1] 	= 2;NP[2] 	= 0;	NQ[0] 	= 2;NQ[1] 	= 0;NQ[2] 	= 1;	MM[0] 	= 0;MM[1] 	= 5;MM[2] 	= 4;	NN[0] 	= 5;NN[1] 	= 1;NN[2] 	= 3;	L1[0] 	= 0;L1[1] 	= 1;L1[2] 	= 2;L1[3] 	= 1;L1[4] 	= 2;L1[5] 	= 0;	L2[0] 	= 0;L2[1] 	= 1;L2[2] 	= 2;L2[3] 	= 2;L2[4] 	= 0;L2[5] 	= 1;	L3[0][0] = 0;L3[0][1] = 5;L3[0][2] = 4;	L3[1][0] = 5;L3[1][1] = 1;L3[1][2] = 3;	L3[2][0] = 4;L3[2][1] = 3;L3[2][2] = 2;	}void OneDisObj::StackingFaultShifts(void){}void	OneDisObj::SetObjectWindowTitle(void){		theBeamFlag = 1;	energy =  theEBeam->energy;	wavelength = theEBeam->wavelength;	theEBeam->negWidth 		= 30;	theEBeam->negHeight 	= 15.;	theRuler->SetBeamButton(theBeamFlag);		interval				=	50;	numberOfSteps		=	3;	data_Length			=	100;	data_Expand			=	100;	data_Count			=	0;	data_Size			=	sizeof(float);	if(theDataHandle != 0L)		/*Temp*/KillHandle				(&theDataHandle);	theDataHandle		= 	/*Temp*/D_NewHandle(data_Length * data_Size);//,&gTheOSError		lineDirection = (Index*)D_new(Index);	lineDirection->DoInit(true,theCrystal[0]);	lineDirection->h = -3; lineDirection->k = 5; lineDirection->l = 5;	burgersVector = (Index*)D_new(Index);	burgersVector->DoInit(false,theCrystal[0]);	burgersVector->intensity = 1;		burgersVector->h = burgersVector->k = burgersVector->l = 1;			g_Vector->h = -1; g_Vector->k = -2; g_Vector->l = 1;	theFoilNormal->h = 0;theFoilNormal->k = 1; theFoilNormal->l = 3;	theFoilNormal->x = 0;theFoilNormal->y = 1; theFoilNormal->z = 3;	theFoilBragg->h = 1;theFoilBragg->k = 0;theFoilBragg->l = 0;	theFoilBragg->x = 1;theFoilBragg->y = 0;theFoilBragg->z = 0;	theFoilBragg->direction = false;	theZoneAxis->h = 1; theZoneAxis->k = 1; theZoneAxis->l = 3;	theZoneAxis->x = 1; theZoneAxis->y = 1; theZoneAxis->z = 3;		theRotationAxis->h = 1;theRotationAxis->k = 0;theRotationAxis->l = 1;	burgersVectors = (DislocIndex*)D_new(DislocIndex);	burgersVectors->DoInit(false,theCrystal[0]);	burgersVector->DoCopy((Index*)burgersVectors);		lineDirections = (DislocIndex*)D_new(DislocIndex);	lineDirections->DoInit(false,theCrystal[0]);	lineDirection->DoCopy((Index*)lineDirections);		g_Vectors = (DislocIndex*)D_new(DislocIndex);	g_Vectors->DoInit(false,theCrystal[0]);	g_Vector->DoCopy((Index*)g_Vectors);		theZoneAxes = (DislocIndex*)D_new(DislocIndex);	theZoneAxes->DoInit(false,theCrystal[0]);	theZoneAxis->DoCopy((Index*)theZoneAxes);		theRotationAxes = (DislocIndex*)D_new(DislocIndex);	theRotationAxes->DoInit(false,theCrystal[0]);	theRotationAxis->DoCopy((Index*)theRotationAxes);	calcIrrational				=	6;/*about G at bragg*/	offLaueDistance				=	2;	anomAbsorbCoeff 			= .015;	w_Off_Bragg 					= .7;	anomFlag							= false;	theFoilThickness			=	2000;	theFNRotationAngle 		= 10;	theFNOffLaueDistance 	= 10;	darkFieldFlag 	= 	false;	maxIntensity 		= 	500; 	minIntensity 		= 	0;	magnification		=	1.0;	redraw					=	false;	delugeFlag			=	false;	macroFlag				=	false;	foilParallel				=	false;	GetSpikingFactor(theFoilNormal,theFNRotationAxis,theFoilBragg,theFNRotationAngle,theFNOffLaueDistance,theFoilThickness,calcFoil,theCrystal[0]);		negWidth		=	30;	negHeight		=	15;		numberDefect_Sets = 1;	number_Beams      = 1;	pictID			=	(DislocImageCond*)D_new(DislocImageCond);	pictID->DoInit(0L);	CheckBeamsMem(0);	if(gTheFile->file_is_Open){		SetWTitle(theWindow,fileInfo.sfFile.name);		return;	}	sprintf(gTheText,"Microstructure %d",g_Window_Number);	SetWTitle(theWindow,c2pstr(gTheText));	g_Window_Number++;	}void OneDisObj::SetObjectMenu(void){	theMenuBar = GetNewMBar(ONE_DIS_MB);	ClearMenuBar();/* July 1992 */	if(g_Monitor) {		EnableItem(GetMenu(PALETTE_MENU_1),0);	}else DisableItem(GetMenu(PALETTE_MENU_1),0);		CheckItem		(GetMenu(PALETTE_MENU_1),1,true);	SetMenuBar	(theMenuBar);}void OneDisObj::DoClose(void){	lineDirection->DoClose();	burgersVector->DoClose();	burgersVectors->CloseAll();	lineDirections->CloseAll();	g_Vectors->CloseAll();	theZoneAxes->CloseAll();	theRotationAxes->CloseAll();		burgersVectors	->	DoClose();	lineDirections	->	DoClose();	g_Vectors		->	DoClose();	theZoneAxes		->	DoClose();	theRotationAxes	->	DoClose();	pictID			->	KillAll();	CheckBeamsMem			(-1);	inherited::DoClose();}void OneDisObj::GetCurrentBeamValues(DialogPtr theDialog){	anomFlag 		= GetBoolean(theDialog,_8_);	if(fabs(anomAbsorbCoeff 		- GetBoolean(theDialog,_7_)) > .01)changedFlag = true;	anomAbsorbCoeff = 	(float)GetItemValue( theDialog,_7_);	if(darkFieldFlag 	!= GetBoolean(theDialog,_9_))changedFlag = true;		darkFieldFlag 	= GetBoolean(theDialog,_9_);		macroFlag 		= GetBoolean(theDialog,_13_);	GetVectors();}void OneDisObj::AddBeams(DialogPtr theDialog,Boolean theFlag){		if(!theFlag){			theZoneAxes->SubtractIndex() ;			g_Vectors->SubtractIndex() ;			theRotationAxes->SubtractIndex() ;			return;		}			theZoneAxes->AddIndex(theZoneAxis) ;		g_Vectors->AddIndex(g_Vector);		theRotationAxes ->	AddIndex(theRotationAxis); 		((float*)(*anomAbsorbCoeffs))[number_Beams - 1] = 	(float)GetItemValue( theDialog,_7_);		((float*)(*rotationAngles))[number_Beams - 1] = 	(float)rotationAngle;		((float*)(*offLaueDistances))[number_Beams - 1] = 	(float)offLaueDistance;		((short*)(*orTypes))[number_Beams - 1] = 	(float)calcIrrational;		}void OneDisObj::DefineSetUp(DialogPtr theDialog){	GetDItem(theDialog,_3_ + baseCrystal,&gType,&gTheHandle,&gTheRect);	SetCtlValue((ControlHandle)gTheHandle,true);		SetItemValue(theDialog,_7_,anomAbsorbCoeff,4);	anomFlag 		= SwitchBoolean(theDialog,_8_,!anomFlag);	darkFieldFlag 	= SwitchBoolean(theDialog,_9_,!darkFieldFlag);	SwitchBoolean(theDialog,_13_,!macroFlag);	SetItemValue(theDialog,_12_,(double)number_Beams,0);}float OneDisObj::AnomalGuess(void){	double g,Z,eMRatio;	dcomplex cAb;	g 		= 	1.0 / g_Vector->TheDSpacing();	eMRatio = 	1. + ( (double)energy / 511.);	Z 		= 	g_Vector->IndexStructureFactor(g,eMRatio,theBeamFlag,&cAb);		return (float)((-.002534 + .005295 * Z) * g) - .009629 + .021 * Z;}void OneDisObj::DrawTheText(void){}void OneDisObj::DoAddTwoDisCN(double VR[3][3],double UR[3][3],short j){	VR[0][0] = UR[0][0] = 0;	j = 0;}void OneDisObj::CalcShift(double *shift,double delta_Y_Dir_Extinct,double extra,double divisor,double dotProd_Foil_N_Beam){	*shift = delta_Y_Dir_Extinct = extra = divisor = dotProd_Foil_N_Beam;	*shift = 0;	STARTA = 0.0;	}void OneDisObj::CalculateMove(double *MOVE,double shift){	shift = *MOVE;	*MOVE = 0;}void OneDisObj::AdditionalIterations(void){}void  OneDisObj::AdditionalStartAndPositionValues(double EXTRA){	X = -PI * FINISH / dotProd_Foil_N_Beam - (*ptrCN15 * proj_Foil_Norm_X[0] / proj_Foil_Norm_X[1]);	EXTRA = 0;	}void OneDisObj::AddedOneDisCalc(void){	SURFAC = X + true_Foil_Thick_Extinct;}void OneDisObj::AddedOneDis2(void){	double XX1;	if(X1 >= SURFAC && iFlag == 0){								XX1 = X1;				X1 = SURFAC;				iFlag = 1;				RungeKuttaIntegration8Eq();				BlockMove(howie_Whelan_Eq,TEMPY,eightElements);				X1 = XX1;	}}void OneDisObj::AddedOneDis3(void){		RungeKuttaIntegration8Eq();	BlockMove(howie_Whelan_Eq,TEMPY,eightElements);	}void OneDisObj::CalculateIntensityMap(void){	double n_Thickness,extDist,electronMassRation,			proj_G_Vect[3],			proj_Foil_Norm[3];								double	DCX[3][3],d_Real[3],d_Image[3],UR[3][3],UI[3][3],VR[3][3],VI[3][3];		double  b_Vector_Cart[3],			line_Dir_Cart[3],			beam_Cart[3],			foil_Norm_Cart[3],proj_b_Vector[3];				double	W = 0,TT = 0,theValue2 = 0;		double	EXTRA = 0,DIVISOR = 0,shift = 0,MOVE = 0,			delta_Y_Dir_Extinct = 0,			BACK = 0,DNR = 0,DNI = 0,DNN = 0,part1 = 0,part2 = 0;	double  z = 0,sum = 0,x = 0,tempValue = 0,pixelsWide = 0;	double  totalX = 0,black = 0,white = 0,span = 0;	short 	hRes = 0,vRes = 0;	long 	j = 0,k = 0,l = 0,ja = 0,jk = 0,jc = 0,jt = 0,jm = 0,jz = 0,			ival = 0,theValue = 0;				double	m1[3][3],m2[3][3];	float	*theData;	long	longValue = 0;		long	max_Data_Count = 0,max_FX = 0;	Boolean	testFlag,theRunTotal;	float		*TB_Ptr;	long		result;			Identity_Matrix(m1);	Identity_Matrix(m2);	InitCalc();	ScreenRes(&hRes, &vRes);	xCount 		= (negWidth / 50.8) * (double )hRes;	yCount 		= (negHeight / 25.4) * (double )vRes;		if((yCount % 2) == 0)		yCount++;	/*Temp*/KillHandle(&theDataHandle);	data_Size = max_Data_Count =  2 * xCount * yCount;	data_Count = 0;	if(Gestalt(gestaltFPUType,&result) == 0){			if(result != gestaltNoFPU){				theRunTotal = true;			}	}	data_Size++;	data_Length = sizeof(float);	theDataHandle		= 	/*Temp*/D_NewHandle((long)(data_Length * data_Size));//,&gTheOSError	if(MemError() != 0 || gTheOSError != 0){		StopAlert(609,0L);		redraw = false;		delugeFlag = false;		return;	}		pixelsWide = 2.0 * xCount;	theSlice = 0.0;		redraw = true;	if(delugeFlag){		longValue = ((5 * xCount * yCount) + 21 + xCount) * (long)sizeof(float );		TB = (float*)D_NewPtr((long)longValue );		if(MemError() != 0){			KillPtr(TB);			StopAlert(609,0L);			redraw = false;			delugeFlag = false;			return;		}		longValue = ((xCount * yCount) + 1) * (long)sizeof(float );		FY1 = (float*)D_NewPtr((long)longValue);		if(MemError() != 0){			KillPtr(TB);			StopAlert(609,0L);			redraw = false;			delugeFlag = false;			return;		}		FY2 = (float*)D_NewPtr((long)longValue);		if(MemError() != 0){			KillPtr((Ptr)TB);			KillPtr((Ptr)FY1);			StopAlert(609,0L);			redraw = false;			delugeFlag = false;			return;		}		FY3 = (float*)D_NewPtr((long)longValue);		if(MemError() != 0){			KillPtr((Ptr)TB);			KillPtr((Ptr)FY1);			KillPtr((Ptr)FY2);			StopAlert(609,0L);			redraw = false;			delugeFlag = false;			return;		}		FY4 = (float*)D_NewPtr((long)longValue);		if(MemError() != 0){			KillPtr((Ptr)TB);			KillPtr((Ptr)FY1);			KillPtr((Ptr)FY2);			KillPtr((Ptr)FY3);			StopAlert(609,0L);			redraw = false;			delugeFlag = false;			return;		}	}else{		longValue = (6 * xCount + 21) * (long)sizeof(float );		TB = (float*)D_NewPtr((long)longValue );		if(MemError() != 0){			StopAlert(609,0L);			redraw = false;			delugeFlag = false;			return;		}	}	max_Deluge 	= -1;	max_FX		= -1;		if(delugeFlag){		theValue  = (pixelsWide) + 4;		FX1 = &TB[theValue];		theValue = (short)(xCount * yCount) + 4;		FX2 = &FX1[theValue];		FX3 = &FX2[theValue];		FX4 = &FX3[theValue];	}else{		theValue = (short)pixelsWide + 4;		FX1 =  &TB[theValue];		theValue = (short)xCount + 4;		FX2 = &FX1[theValue];		FX3 = &FX2[theValue];		FX4 = &FX3[theValue];	}	eightElements = 8 * sizeof(double );	/*MFTemp*/D_HLock(theDataHandle);		theData = (float*)*theDataHandle;		SetupPointers();	GetVectors();		if(anomFlag)		AnomalGuess();	if(anomAbsorbCoeff == 0.0){		anomAbsorbCoeff = -.1;	}else if(anomAbsorbCoeff > 0.0){		anomAbsorbCoeff *= -1.0;	}	electronMassRation 	= 	1. + ( (double)energy / 511.);		extDist 			= 	g_Vector->TheExtinctionDist(1./ wavelength,electronMassRation,theBeamFlag);	if(extDist == 100000){Message(NO_EXTINCTION_DISTANCE);}	n_Thickness 		= theFoilThickness / extDist;	FINISH 				= n_Thickness;		*ptrCN14 = 2.0 * w_Off_Bragg;		b_Vector_Cart[0] = burgersVector->x;	b_Vector_Cart[1] = burgersVector->y;	b_Vector_Cart[2] = burgersVector->z;		line_Dir_Cart[0] = cos_Cry_Dis[2][0] = lineDirection->x;				/* OK */	line_Dir_Cart[1] = cos_Cry_Dis[2][1] = lineDirection->y;	line_Dir_Cart[2] = cos_Cry_Dis[2][2] = lineDirection->z;		gVector_Cart[0] = g_Vector->x;	gVector_Cart[1] = g_Vector->y;	gVector_Cart[2] = g_Vector->z;		beam_Cart[0] = theZoneAxis->x;						/* OK */	beam_Cart[1] = theZoneAxis->y;	beam_Cart[2] = theZoneAxis->z;		foil_Norm_Cart[0] = theFoilNormal->x; 	foil_Norm_Cart[1] = theFoilNormal->y; 	foil_Norm_Cart[2] = theFoilNormal->z; 	for(j = 0; j < 3;j++){		gVector_Cart[j] *= theZoneAxis->theCrystal->theUnitCell.a;		b_Vector_Cart[j] /= theZoneAxis->theCrystal->theUnitCell.a;	}			VectorCrossProduct(beam_Cart,line_Dir_Cart,cos_Cry_Dis[0]);	VectorCrossProduct(cos_Cry_Dis[2],cos_Cry_Dis[0],cos_Cry_Dis[1]);			NormalizeMatrixRows(cos_Cry_Dis); 	SetVector1EqualTo2(DCX[0],cos_Cry_Dis[0],3,true);	SetVector1EqualTo2(DCX[1],beam_Cart,3,true);	VectorCrossProduct(DCX[0],DCX[1],DCX[2]);		NormalizeMatrixRows(DCX);	MatrixVectorMultiply(cos_Cry_Dis,	b_Vector_Cart	,proj_b_Vector);	MatrixVectorMultiply(cos_Cry_Dis,	beam_Cart		,proj_Beam);	MatrixVectorMultiply(cos_Cry_Dis,	foil_Norm_Cart	,proj_Foil_Norm);	MatrixVectorMultiply(DCX,			foil_Norm_Cart	,proj_Foil_Norm_X);	MatrixVectorMultiply(cos_Cry_Dis,	gVector_Cart	,proj_G_Vect);		AdditionMatrixMults(DCX);		NormalizeVector				(&proj_Beam[0],&proj_Beam[1],&proj_Beam[2]);	NormalizeVector				(&proj_Foil_Norm[0],&proj_Foil_Norm[1],&proj_Foil_Norm[2]);	dotProd_Foil_N_Beam		=  	VectorDotProduct(proj_Beam,proj_Foil_Norm,3);	true_Foil_Thick_Extinct = 	PI * n_Thickness / dotProd_Foil_N_Beam;	/* thickness along beam in extinction dists */		testFlag = false;	if(fabs(theZoneAxis->GetTheXYZAngle(g_Vector)) < 1.22 && Question(BEAM_G_NOT_90)){		testFlag = true;	}	if(fabs(theZoneAxis->GetTheXYZAngle(lineDirection)) > 1.396 && Question(BEAM_LINE_GT_80)){		testFlag = true;	}	if(fabs(theZoneAxis->GetTheXYZAngle(theFoilNormal)) > .69813 && Question(BEAM_FOIL_NOT_0)){		testFlag = true;	}	if(burgersVector->intensity  < .1 && Question(DISLOC_SHORT)){		testFlag = true;	}	if(w_Off_Bragg > 10 && Question(NOT_CONVERGE)){		testFlag = true;	}	if(testFlag){		KillPtr(TB);		/*MFTemp*/D_HUnlock(theDataHandle);		if(delugeFlag){			KillPtr((Ptr)FY1);			KillPtr((Ptr)FY2);			KillPtr((Ptr)FY3);			KillPtr((Ptr)FY4);		}			redraw = false;		delugeFlag = false;		return;	}			data_Count = 0;			StackingFaultShifts();			ElasticField();			if(KRASH != 0){		Message(NOT_CONVERGE);		KillPtr(TB);		/*MFTemp*/D_HUnlock(theDataHandle);		if(delugeFlag){			KillPtr((Ptr)FY1);			KillPtr((Ptr)FY2);			KillPtr((Ptr)FY3);			KillPtr((Ptr)FY4);		}				redraw = false;		delugeFlag = false;		return;	}	SetVectorToOrigin(d_Real,3);	SetVectorToOrigin(d_Image,3);					/*  NOTE   Not a dot product   ....  Line   430 - 440*/			for(j = 0; j <= 2 ; j++){				/*  NOTE   Not a dot product   ....  Line   430 - 440*/		for(k = 0; k <= 2 ; k++){			d_Real[j] += (proj_G_Vect[k] * AR[k][j]);			d_Image[j] += (proj_G_Vect[k] * AI[k][j]);		}	}			for(j = 0; j <= 2 ; j++){		z = d_Real[j];		d_Real[j] = z * p_Real[j] - d_Image[j] * p_Image[j];		d_Image[j] = z * p_Image[j] + d_Image[j] * p_Real[j];	}		for(ja = 0; ja <= 2 ; ja++){		for(l = 0; l <= 2 ; l++){			UR[ja][l] = UI[ja][l] = 0.0;			for(j = 0; j <= 2 ; j++){				UR[ja][l] += (eMReal[ja][j] * H[j][l]);				UI[ja][l] += (eMImage[ja][j] * H[j][l]);			}		}	}	for(ja = 0; ja <= 2 ; ja++){		for(l = 0; l <= 2 ; l++){			VR[ja][l] = d_Real[ja] * UR[ja][l] - d_Image[ja] * UI[ja][l];			VI[ja][l] = d_Real[ja] * UI[ja][l] + d_Image[ja] * UR[ja][l];		}	}		for(ja = 0; ja <= 2 ; ja++){		for(l = 0; l <= 2 ; l++){			UR[ja][l] = VR[ja][l] * p_Real[ja] + VI[ja][l] * p_Image[ja];		}	}		for(j = 0; j <= 2 ; j++){		CN[j + 9] = p_Image[j] * p_Image[j];		CN[j + 6] = p_Real[j];		CN[j] 	= 	VectorDotProduct(&VR[j][0],proj_b_Vector,3);		CN[j + 3] = VectorDotProduct(&UR[j][0],proj_b_Vector,3);		DoAddTwoDisCN(VR,UR,j);	}				ADDCN(&EXTRA,&DIVISOR);	delta_Y_Dir_Extinct = delta_X_Dir_Extinct =  (true_Foil_Thick_Extinct + EXTRA) / (xCount + 1);			/* Step size */			{		double WL = 0,WW = 0;		WL = (n_Thickness * proj_Beam[1] / proj_Foil_Norm[2]) + (EXTRA / DIVISOR);		/* picture Width in extinction dists */		WW = WL * yCount / pixelsWide;				/* picture Width in extinction dists */		delta_Y_Dir_Extinct = PI * WW / yCount;	}	CalcShift(&shift, delta_Y_Dir_Extinct,EXTRA,DIVISOR,dotProd_Foil_N_Beam);			*ptrCN29 = 1000.0;	X = Q = 0.0;	eRROR = 0.0001;		for(jk = 0 ; jk <= 7 ; jk++)howie_Whelan_Eq[jk] = 0.0;				*ptrY1 = 1.0;		X1 = delta_X_Dir_Extinct;	RungeKuttaIntegration8Eq();	X1 = true_Foil_Thick_Extinct;	RungeKuttaIntegration8Eq();	if(darkFieldFlag){		BACK = *ptrY3 * *ptrY3 + *ptrY4 * *ptrY4;	} else {		BACK = *ptrY1 * *ptrY1 + *ptrY2 * *ptrY2;	}		if(fabs(proj_Foil_Norm_X[1]) < .00000001){		/*MFTemp*/D_HUnlock(theDataHandle);		KillPtr(TB);		if(delugeFlag){				KillPtr((Ptr)FY1);				KillPtr((Ptr)FY2);				KillPtr((Ptr)FY3);				KillPtr((Ptr)FY4);		}			delugeFlag = false;		return;	}	redraw = true;	theValue2 = 0.0;	for(jc = 0 ; jc < yCount ; jc++,theValue2++){			double theValue;					/************* Calculation Loop **************/		double	*thePtr;		AllowBackground();		SetupPointers();		if(Quit()){			/*MFTemp*/D_HUnlock(theDataHandle);			KillPtr(TB);			if(delugeFlag){				KillPtr((Ptr)FY1);				KillPtr((Ptr)FY2);				KillPtr((Ptr)FY3);				KillPtr((Ptr)FY4);			}				delugeFlag = false;			return;		}		theValue = yCount;/*yCount + 1.*/						*ptrCN15 = (theValue2  -.5 - (theValue)/ 2.0) * delta_Y_Dir_Extinct;					/* dist from disloc line */				CalculateMove(&MOVE, shift);				*ptrCN29 = *ptrCN15 / proj_Beam[1] ;									/* divided by cos psi */				AdditionalStartAndPositionValues( EXTRA);		AddedOneDisCalc();		X1 = X;				iFlag = 0;				thePtr = howie_Whelan_Eq;		for(jk = 0 ; jk <= 7 ; jk++,thePtr++) *thePtr = 0.0;					*ptrY1 = *ptrY7 = 1.0;				KOUNTF = 0;		N = 0;		for(jt = 0 ; jt < xCount ; jt++){						X1 += delta_X_Dir_Extinct;						AddedOneDis2();			AdditionalIterations();			RungeKuttaIntegration8Eq();			if(Quit()){				/*MFTemp*/D_HUnlock(theDataHandle);				KillPtr(TB);				if(delugeFlag){					KillPtr((Ptr)FY1);					KillPtr((Ptr)FY2);					KillPtr((Ptr)FY3);					KillPtr((Ptr)FY4);				}					delugeFlag = false;				return;			}			DNR = *ptrY1 * *ptrY7 - *ptrY2 * *ptrY8 - *ptrY3 * *ptrY5 + *ptrY4 * *ptrY6;			DNI = *ptrY1 * *ptrY8 + *ptrY2 * *ptrY7 - *ptrY3 * *ptrY6 - *ptrY4 * *ptrY5;						DNN = 1.0 / (DNR * DNR + DNI * DNI);			if(delugeFlag){				max_FX++;			}else{				max_FX = jt;			}			FX1[max_FX] = DNN * (*ptrY7 * DNR + *ptrY8 * DNI);			FX2[max_FX] = DNN * (*ptrY8 * DNR - *ptrY7 * DNI);			FX3[max_FX] = -DNN * (*ptrY3 * DNR + *ptrY4 * DNI);			FX4[max_FX] = DNN * (*ptrY3 * DNI - *ptrY4 * DNR);		}				if(iFlag == 0){			X1 = SURFAC;			AddedOneDis3();					}				X = SURFAC;		X1 = X;				BlockMove(TEMPY,howie_Whelan_Eq,eightElements);						KOUNTF = 0;		N = 1;		max_FX -= xCount;		if(Quit()){			/*MFTemp*/D_HUnlock(theDataHandle);			KillPtr(TB);			if(delugeFlag){				KillPtr((Ptr)FY1);				KillPtr((Ptr)FY2);				KillPtr((Ptr)FY3);				KillPtr((Ptr)FY4);			}			delugeFlag = false;				return;		}		TB_Ptr = TB;		for(jm = 0 ; jm < xCount ; jm++, TB_Ptr += 2){			max_FX++;			if(delugeFlag){				max_Deluge++;				if(darkFieldFlag){					FY1[max_Deluge] = *ptrY3;					FY2[max_Deluge] = *ptrY4;					FY3[max_Deluge] = *ptrY7;					FY4[max_Deluge] = *ptrY8;				}else{					FY1[max_Deluge] = *ptrY1;					FY2[max_Deluge] = *ptrY2;					FY3[max_Deluge] = *ptrY5;					FY4[max_Deluge] = *ptrY6;				}			}			X1 += delta_X_Dir_Extinct;			AdditionalIterations();			RungeKuttaIntegration8Eq();			if(Quit()){				/*MFTemp*/D_HUnlock(theDataHandle);				KillPtr(TB);				if(delugeFlag){					KillPtr((Ptr)FY1);					KillPtr((Ptr)FY2);					KillPtr((Ptr)FY3);					KillPtr((Ptr)FY4);				}					delugeFlag = false;				return;			}			if(darkFieldFlag){				part1 = FX1[max_FX] * *ptrY3 - FX2[max_FX] * *ptrY4 + FX3[max_FX] * *ptrY7 - FX4[max_FX] * *ptrY8;				part2 = FX1[max_FX] * *ptrY4 + FX2[max_FX] * *ptrY3 + FX3[max_FX] * *ptrY8 + FX4[max_FX] * *ptrY7;			} else {				part1 = FX1[max_FX] * *ptrY1 - FX2[max_FX] * *ptrY2 + FX3[max_FX] * *ptrY5 - FX4[max_FX] * *ptrY6;				part2 = FX1[max_FX] * *ptrY2 + FX2[max_FX] * *ptrY1 + FX3[max_FX] * *ptrY6 + FX4[max_FX] * *ptrY5;			}			TT = part1 * part1 + part2 * part2;						//TB[2 * jm] = TT / BACK;			*TB_Ptr = TT / BACK;					}				TB_Ptr = TB;		if(darkFieldFlag){			TB[0] = (TEMPY[2] * TEMPY[2] + TEMPY[3] * TEMPY[3]) / BACK;		} else {			TB[0] = (TEMPY[0] * TEMPY[0] + TEMPY[1] * TEMPY[1]) / BACK;		}		TB_Ptr++;		for(jz = 1,jm = 0 ; jm < xCount; jz += 2,jm++,TB_Ptr += 2){			*TB_Ptr = .5 * (TB_Ptr[-1] + TB_Ptr[1]);		}		TB_Ptr = (float*)*theDataHandle;		theData = &(TB_Ptr[data_Count]);						TB_Ptr = TB;		for(jz = 0; jz < ((2 * xCount)) - 2; jz++,TB_Ptr++){			if(max_Data_Count < data_Count) continue;			*theData = *TB_Ptr;			theData++;			data_Count++;		}		if(theRunTotal){			MoveTo(100,100);			{				double value1 = 0,value2 = 0;				value1 = (double)jc + 1;				value2 = (double)yCount;				sprintf(gTheText,"per. comp. = %6.4f",((double)100 * value1)/((double)value2));			}			SetRect(&gTheRect,80,80,280,110);			dm_EraseRect(&gTheRect);			DrawDiffractString(c2pstr(gTheText));		}	}		/*MFTemp*/D_HUnlock(theDataHandle);	if(!delugeFlag)KillPtr(TB);	data_Count--;	redraw = true;		return;		}