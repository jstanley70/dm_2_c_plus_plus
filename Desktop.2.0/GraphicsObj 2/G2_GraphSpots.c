//ces.Jim:Desktop.2.0:GraphicsObj 2:G2_GraphSpots.c#include	"Diffract_INCs.h"#include	"GraphFunction.h"#include	"GraphSpots.h"#include	"SpotObject.h"void	GraphSpots::AdditionalPointers(void){		Boolean flag = false;		if(yData == gCurrentObj->theDataHandle)flag = true;		if(yData != 0L){			if(!flag) KillHandle((Handle*)&yData);			else{				 KillHandle((Handle*)&gCurrentObj->theDataHandle);				 gCurrentObj->data_Count = -1;				 gCurrentObj->theDataHandle		=	0L;			}			yData = 0L;		}}void	GraphSpots::DoInit(Rect frameRect,RGBColor theColor,Boolean addMenu,Boolean doGrow){	inherited::DoInit( frameRect,theColor,addMenu,doGrow);	graphType	=	2;	objectType = 1;}void GraphSpots::SetValues(Handle xD,Handle yD){	long		theValue;	theValue = **(long**)yD;		if(xD != 0L){		yData = xD;		noPtsY =  theValue;	}else{		yData = 0L;	}	minY 	= 	0;	maxY 	=	1;	ResetPlotMinMax();}void GraphSpots::GetMinMax(Handle theData,double *minV,double *maxV,short noPts){	if(noPts == 0 || !theData) return;	*minV 	= 	0;	*maxV 	=	1;}GraphFunction* GraphSpots::GetDerivative(void){	if(objectType == 1)return 0L;	return inherited::GetDerivative();}void	GraphSpots::PlotGraph(void){	double 	*data;	short 	i;	short	theX,theY;	SpotInfoPtr	theSpot;	if(yData == 0L &&  xData == 0L ) {		if(next != 0)next->PlotGraph();		return;	}	SetToOwner();	SetPlotScales();	PenNormal();	RGBForeColor(&color);	DrawGraphBox();	if(shrunk){		if(next != 0)next->PlotGraph();	 	return;	}	PenNormal();	RGBForeColor(&color);		if(noPtsY > 1)	data 	= 	(double*)*yData;	else {		if(next != 0)next->PlotGraph();		return;	}		if(!plotGraph)	{		if( next != 0L){next->PlotGraph();			return;		}else			return;	}				theSpot = (SpotInfoPtr)*yData;	RGBForeColor(&color);	for(i = 0;i < noPtsY;i++,theSpot++)	{		RGBForeColor(&theSpot->theCrystal->crystalColor);		theX = Round(((double)(theSpot->y - pMinX) * scaleX) + originX);		theY = Round((double)originY - ((theSpot->intensity - pMinY) * scaleY));		SetRect(&theSpot->spotRect,theX - 1,theY,theX + 1,originY);		if(theX < frame.left || theX > frame.right){			continue;		}		if(theY < frame.top)theY = frame.top;		if(theY > frame.bottom)theY = frame.bottom - 2;		GraphType(theX,theY);	}	DrawSpotText();	if(next != 0)next->PlotGraph();}void  GraphSpots::DrawSpotText(void){	SpotInfoPtr 	thisSpot;	short		i,theIdent;	Index *obj_Index;	if(shrunk)return;	thisSpot		= &((SpotInfoPtr)*yData)[0];	obj_Index  = (Index*)D_new(Index);	for(i = 0 ; i < noPtsY ; i++,thisSpot++){		if(objectType == DIFFRACT_METER || objectType == 1){			if(thisSpot->spotRect.right > frame.right) continue;			if(thisSpot->spotRect.left < frame.left) continue;			if(thisSpot->spotRect.top < frame.top) continue;		}		if(thisSpot->flags & TEXT_MASK){									 			Point		thePoint;					theIdent 				= thisSpot->flags & CRYSTAL_MASK;				thePoint.h 			= (thisSpot->spotRect.left + thisSpot->spotRect.right) / 2;	 				thePoint.v 			= thisSpot->spotRect.top;							 				obj_Index->theCrystal	= thisSpot->theCrystal;				 				obj_Index->h 			= thisSpot->h;						 				obj_Index->k 			= thisSpot->k;						 				obj_Index->l 			= thisSpot->l;						 				obj_Index->direction 		= thisSpot->direction;					if(gInColor){					gCurrentObj->DMForeColor(10 + theIdent);				}else{					PenNormal();					gCurrentObj->DMForeColor(BLACK);				} 				obj_Index->DrawIndex(thePoint);			}	}	obj_Index->DoClose();}Boolean	GraphSpots::SaveText(void){	char			**theText;	long			i;	SpotInfoPtr 	one;	char			aText[255];	if(graphTitle == 0L)		sprintf((char*)gTheFile->theFileInfo.sfFile.name,"fileName");	else		strcpy((char*)gTheFile->theFileInfo.sfFile.name,*graphTitle);	c2pstr((char*)gTheFile->theFileInfo.sfFile.name);	gTheFile->SaveFileOpen('TEXT');	if(!gTheFile->file_is_Open) return false;	one		=	(SpotInfoPtr)*yData;	theText	=	(char**)D_NewHandle((sizeof(char) * 100 * noPtsY) + (1 * sizeof(char)));	D_HLock((Handle)theText);	for(i = 0; i < noPtsY;i++,one++)	{		sprintf(aText,"(%d%d%d)\t%6.3f\t%6.3f\t%6.3f\t%6.3f\t%6.3f\r",one->h,one->k,one->l,one->x,one->y,one->sF.r,one->sF.r,one->intensity);		strcat(*theText,aText);	}	sprintf(aText,"\r");	strcat(*theText,aText);		gTheFile->WriteTextPtr((Ptr)*theText);	gTheFile->DoFileClose();	D_HUnlock((Handle)theText);	KillHandle((Handle*)&theText); 	return false;}GraphFunction* GraphSpots::ConvertToSpectra(long noPts,float minium,float maximum,SADObj *theOwner){	double stepSize,pts2,p;	GraphFunction *aGraph;	double			*one,eta;	short			i,k;	double			**convertData,etaStep;	double			targetZ,targetDensity;	double			targetAtWt;	/*This is absolutely a disaster!!!!*/	SpotInfoPtr		theSpot;	if(objectType != 1)return 0L;	pts2	=	noPts * 2;	convertData = (double**)D_NewHandle(sizeof(double) * pts2);		D_HLock(convertData);	stepSize = (maximum - minium) / noPts;	etaStep	=	stepSize / 10;	one			=	*convertData;	targetDensity = CalcExpDenZA(theOwner->baseCrystal,theOwner->theCrystal,theOwner->the_PPT_Info,								theOwner->plotFlags,&targetZ,&targetAtWt);	for(i = 0; i < pts2;i += 2,one++){		*one = 0;//targetZ * ((12.398/theOwner->energy * asin(eta)) - 1);		*one++;		*one = 0;	}	one			=	*convertData;			D_HLock(yData);	theSpot = (SpotInfoPtr)*yData;	p = .25 / etaStep;	Round(p);	p *= 8;	for(i = 0; i < noPtsY;i++,theSpot++)	{		long value,n,j;		double	crystalSize;		value	=	2 * (theSpot->y - minium) / (double)(stepSize);		j = 1 / (	theOwner->GetSpikingFactor(theOwner->theFoilNormal,theOwner->theFNRotationAxis,theOwner->theFoilBragg,theOwner->theFNRotationAngle,					theOwner->theFNOffLaueDistance,theOwner->theFoilThickness,theOwner->calcFoil,theSpot->theCrystal) 					* theSpot->theCrystal->dspacings[0].x);		crystalSize = j + 1;		n = -p;		k = p;		eta = -((etaStep * k/2) + (etaStep * .01));				if(value + n < 0){n = 0;eta = (etaStep * .01);}		if(value + k >= pts2 - 2){k = pts2 - 2 - value;}		for(j = n;j < k; j++,eta += etaStep){			double sin2;			sin2 = sin(crystalSize * eta * PI)/(PI * eta);			sin2 *= sin2;			one[value + j] 		+= theSpot->sF.r * sin2;			j++;			one[value + j] 		+= theSpot->sF.i * sin2;		}	}	D_HUnlock(yData);	D_HUnlock(convertData);	aGraph	 = (GraphFunction*)D_new(GraphFunction);	aGraph	-> 	DoInit(frame,color,false,grow);	aGraph	->objectType = 2;	aGraph	->	SetValues(0L,(Handle)convertData);	KillHandle		((Handle*)&convertData);	aGraph->SetDescendantTitle(".Spotspec.");	aGraph	->NormalizeToOwner(this);	return aGraph;}