//ces.Jim:Desktop.2.0:GraphicsObj 2:G2_GraphObject.c#include	"Diffract_INCs.h"#include	"GraphObject.h"Ptr AllocGraphObj(void){	GraphObject		*theObj;		theObj =  (GraphObject*)D_new(GraphObject);	if(HandleIsOK((Handle)theObj)){		theObj->objectType  =		GRAPH_OBJ;		theObj->DoInit();		return((Ptr)theObj);	} else {		return(NUL_PTR);	}}void GraphObject::DoInit(void){	initFlag = true;	inherited::DoInit();	SizeWindow(theWindow,300,200,false);	ResizeGraphBox();	next	 		= 	0L;	initFlag = false;}void	GraphObject::SetObjectWindowTitle(void){	inherited::SetObjectWindowTitle();	if(gTheFile->file_is_Open){		SetWTitle(theWindow,fileInfo.sfFile.name);		return;	}	sprintf(gTheText,"Graph Window %d",g_Window_Number);	SetWTitle(theWindow,c2pstr(gTheText));}void GraphObject::SetOwner(Handle *theOwner){	short k;	owner	= theOwner;	sprintf(gTheText,"g in mm");	k = strlen(gTheText);	graph->SetTitleX(gTheText);	sprintf(gTheText,"Intensity");	graph->SetTitleY(gTheText);		theBeamFlag = ((DiffractObject*)*owner)->theBeamFlag;	energy =   ((DiffractObject*)*owner)->energy;	wavelength =  ((DiffractObject*)*owner)->wavelength;	maxEnergy =  ((DiffractObject*)*owner)->energy;	HideGraph();	}void 	GraphObject::DoClose(void){	inherited::DoClose();}void	GraphObject::SetXY(long *theX,long *theY,SpotInfoPtr theSpot){	*theX	= centerX + (short)(graph->scaleX * ((cameraConstant * theSpot->x) - graph->pMinX));	*theY	= centerY - (short)(graph->scaleY * ((theSpot->intensity * graph->pMaxY) - graph->pMinY));}void	GraphObject::KillGraph(void){	inherited::DoClose();}void	GraphObject::DoDefine(void){	if(initFlag) return;	inherited::DoDefine();}void	GraphObject::DoCalculate(void){	if(initFlag) return;	inherited::DoCalculate();}double GraphObject::SetRecpSize(void){	return graph->maxX/(double)cameraConstant;	}void	GraphObject::ShowGraph(void){	ShowWindow(theWindow);	SelectWindow(theWindow);	SetPort(theWindow);}void	GraphObject::HideGraph(void){	HideWindow(theWindow);	SetPort( ((DiffractObject*)*owner)->theWindow);}void		GraphObject::DoCourser(Point thePoint){	double 		theValue,dspace;	static Point 	oldPoint;	GetMouse(&thePoint);	if(!PtInRect(thePoint,&graphBox))		return;	if(oldPoint.h == thePoint.h)		return;	theRuler->SetPrompt("Cursor Info:"); 	theValue = ((double)(thePoint.h - graph->originX)/graph->scaleX) + graph->pMinX;	if(theValue <= .005)dspace = 0.0;	else dspace = cameraConstant / theValue;		sprintf(gTheText,"radius = %6.2f mm,D-Spacing = %7.3f ",theValue,dspace);		theRuler			->SetInfo(gTheText);	oldPoint 		= 	thePoint;			}double*	GraphObject::FindPeaks(short	*noOfPeaks){	*noOfPeaks = *noOfPeaks;/*	double		*dataPtr;	double 		**convertData;	short 		i,k,p,maxPeaks;	SpotInfoPtr thisSpot,theSpots;	double		*peakLocations;	short		n;	double		*intensities;		maxPeaks = 15;	peakLocations = (double*)D_NewPtr(sizeof(double) * maxPeaks);	convertData = GetDerivative();		SetMinMax(minX,maxX - delXperChannel);	dataPtr = *convertData;	D_HLock((Handle)convertData);	p = 0;	n = 0;	for(i = n; i < channels;i++,dataPtr++){		while(*dataPtr >= 0 && i < channels){			dataPtr++;			i++;		}		if(i != channels){			k = i;						if(maxPeaks < p){				maxPeaks += 10;				D_SetPtrSize((Ptr*)&peakLocations,(long)(sizeof(double) * maxPeaks));			}			peakLocations[p++] = k;			while(*dataPtr < 0 && i < channels){				dataPtr++;				i++;			}		}	}	maxPeaks = p;	theSpots = thisSpot = (SpotInfoPtr)*theDataHandle;	D_HLock(theDataHandle);	thisSpot->intensity = (float)/*(short double)//0;	thisSpot->x =  0;	thisSpot->y = 0;	thisSpot->z =  0.0;	thisSpot->angle = 0.0;	thisSpot->h = i;	thisSpot->k = 0;	thisSpot->l = 0;	thisSpot->direction = true;	thisSpot->theCrystal = theCrystal[baseCrystal];	thisSpot->flags = baseCrystal;	data_Count = 1;	intensities = (double*)(*spectralDataHdn);	for(i = 1; i <= maxPeaks;i++)	{		if(data_Count >= data_Length){			ExpandMemory();			theSpots = (SpotInfoPtr)*theDataHandle;			intensities = (double*)(*spectralDataHdn);		}		thisSpot 	= &(theSpots[data_Count++]);		thisSpot->intensity = (float)intensities[(short)peakLocations[i - 1] + 2];		thisSpot->y = thisSpot->x =  (((peakLocations[i - 1] + 2) * delXperChannel) + minX);		/*thisSpot->y = asin(wavelength * (thisSpot->x/cameraConstant) * .5);//		thisSpot->z =  0.0;		thisSpot->angle = 0.0;		thisSpot->h = i;		thisSpot->k = 0;		thisSpot->l = 0;		thisSpot->direction = false;		thisSpot->theCrystal = theCrystal[baseCrystal];		thisSpot->flags = baseCrystal;	}	D_HUnlock(theDataHandle);	*noOfPeaks = p;	KillHandle((Handle*)&convertData);	return peakLocations;	*/	return 0;}