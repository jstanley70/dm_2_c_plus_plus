#include	"Diffract_INCs.h"#include "ML_BeamE.h"#include	"a_DiffractObject.h"void	ML_DoBeamESetup(Ptr	owner,DialogPtr theDialog,Ptr *theParams){	DiffractObject*			theOwner;	ML_BeamEParamsPtr    thePtr;		theOwner				= (DiffractObject*)owner;		*theParams = D_NewPtr(sizeof(ML_BeamEParams));	thePtr = (ML_BeamEParamsPtr)*theParams;		thePtr->theMenu  = (PopUpMenu*)D_new(PopUpMenu);	thePtr->theMenu->Init(theDialog,BEAMTYPEMENU,72,theOwner->theBeamFlag);	thePtr->theBeamFlag = theOwner->theBeamFlag;		theOwner->DoBeamESetUp( theDialog,thePtr,theOwner->theBeamFlag);}void	ML_DoBeamEHit(Ptr	owner,DialogPtr theDialog, short theSelect,Ptr theParams){	DiffractObject*		theOwner;	Boolean		saveData;	theOwner		= (DiffractObject*)owner;	theOwner->DoBeamESwitch( theDialog, theSelect,theParams,&saveData);}void	ML_DoBeamERead(Ptr owner,DialogPtr theDialog,Ptr thePtr,Boolean saveData){	DiffractObject*		theOwner;	ML_BeamEParamsPtr    theParams;	theParams = (ML_BeamEParamsPtr)thePtr;	theOwner		= (DiffractObject*)owner;	theParams->theMenu->DoClose();	if(theOwner->theBeamFlag != theParams->theBeamFlag) theOwner->changedFlag = true;	theOwner->theBeamFlag = theParams->theBeamFlag;	theOwner->DoBeamERead( theDialog,thePtr, saveData);	KillPtr(theParams);}//************************************************************************//void	DiffractObject::DoBeamESetUp(DialogPtr theDialog,ML_BeamEParamsPtr  theParams,short beamFlag){	theParams->theBeamFlag = beamFlag;	switch(beamFlag)	{		case 1:			theEBeam->DoSetUp(theDialog,theParams);			break;		case 2:			theXRay->DoSetUp(theDialog,theParams);			break;		case 3:			theIon->DoSetUp(theDialog,theParams);			break;	}	}Boolean DiffractObject::DoBeamESwitch(DialogPtr theDialog,short theSelect,Ptr  thePtr,Boolean* saveData){	short theValue;		ML_BeamEParamsPtr    theParams;	theParams = (ML_BeamEParamsPtr)thePtr;	switch(theSelect)	{		case BEAMTYPEMENU:			theValue = theParams->theMenu->DoPopUp();			if(theParams->theMenu->lastResult != theParams->theBeamFlag){								switch(theParams->theBeamFlag){					case 1:						theEBeam->DoRead( theDialog,thePtr,true,false);						break;					case 2:						theXRay->DoRead(theDialog,thePtr,true,false);						break;					case 3:						theIon->DoRead(theDialog,thePtr,true,false);						break;				}				theValue = theParams->theMenu->lastResult;				DoBeamESetUp( theDialog,theParams, theValue);			}			break;		default:		switch(theParams->theBeamFlag){			case 1:				return theEBeam->DoBeamESwitch(theDialog, theSelect,thePtr,saveData);				break;			case 2:				return theXRay->DoBeamESwitch(theDialog, theSelect,thePtr,saveData);				break;			case 3:				return theIon->DoBeamESwitch(theDialog, theSelect,thePtr,saveData);				break;		}		break;	}	return false;}void  DiffractObject::DoBeamERead(DialogPtr theDialog,Ptr thePtr,Boolean saveData){	ML_BeamEParamsPtr    theParams;		theParams = (ML_BeamEParamsPtr)thePtr;	theBeamFlag = theParams->theBeamFlag;	switch(theParams->theBeamFlag){		case 1:			theEBeam->DoRead(theDialog, thePtr, saveData,true);			break;		case 2:			theXRay->DoRead(theDialog, thePtr, saveData,true);			break;		case 3:			theIon->DoRead(theDialog, thePtr, saveData,true);			break;	}	SetScaleFactor();		if(this->rulerHeight > 0 && this->theRuler != NUL) {	 	theRuler->SetBeamButton(theBeamFlag);	}	}void  DiffractObject::DefineBeamE(void){	short 			theSelect;	DialogPtr		theDialog;	Boolean 		quit = false;	Boolean			saveData;	Ptr				theParams;	short			theBeam;		theDialog = DM_GetNewDialog(E_DEF_DLOG,0L,(WindowPtr)-1L);	ML_DoBeamESetup((Ptr)this, theDialog,&theParams);	changedFlag = false;	theBeam = theBeamFlag;	while(!quit){		SystemTask();		ModalDialog(TheFilterUPP,&theSelect);		switch(theSelect){			case ML_UPDATE_EVT:				BeginUpdate(theDialog);			UpdtDialog(theDialog,theDialog->visRgn);			if(!gAppleEvtsOK){				HiliteOK(theDialog);			}			quit = DoBeamESwitch(theDialog, theSelect,theParams,&saveData);			EndUpdate(theDialog);			break;			default:			quit = DoBeamESwitch(theDialog, theSelect,theParams,&saveData);			break;			}			}	ML_DoBeamERead((Ptr)this, theDialog, theParams, saveData);	if(theBeam != theBeamFlag){		changedFlag = true;	}	if(changedFlag){		SetScaleFactor();		newPictReq = true;	}	if(this->rulerHeight > 0 && theRuler != NUL) {		 theRuler->SetBeamButton(theBeamFlag);	}	DM_DisposDialog(&theDialog);	return ;}