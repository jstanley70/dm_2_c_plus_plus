#include "ML_StructFactor.h"#include	"Diffract_INCs.h"void ML_DoSFSetup(Ptr owner,DialogPtr theDialog,Ptr	*thePtr){	ML_StructFacParamsPtr theParams;	DiffractObject *theOwner;	theParams		=	(ML_StructFacParamsPtr)D_NewPtr(sizeof(ML_StructFacParams));	*thePtr = (Ptr)theParams;	theOwner = (DiffractObject*)owner;	theOwner->SFSetUp( theDialog, theParams);}void ML_DoSFHit(Ptr	owner,DialogPtr theDialog, short theSelect,	Ptr	thePtr){	ML_StructFacParamsPtr theParams;	DiffractObject *theOwner;	Boolean saveData;	theParams = (ML_StructFacParamsPtr)thePtr;	theOwner = (DiffractObject*)owner;	theOwner->SFHit( theDialog, theSelect, theParams, &saveData);}void ML_DoSFRead(Ptr owner,DialogPtr theDialog,Ptr	thePtr,Boolean saveData){	ML_StructFacParamsPtr theParams;	DiffractObject *theOwner;	theParams = (ML_StructFacParamsPtr)thePtr;	theOwner = (DiffractObject*)owner;	theOwner->SFRead( theDialog, theParams, saveData);	}double ConvertTemps(double temp,short newScale,short oldScale);//blochvoid DiffractObject::SFSetUp(DialogPtr theDialog,ML_StructFacParamsPtr thePr){	thePr->structure		=	(PopUpMenu*)D_new(PopUpMenu);	thePr->structure			->Init(theDialog,_3_,150,g_StructureEV + 1);	thePr->flag3	=	false;	thePr->temp		=	(PopUpMenu*)D_new(PopUpMenu);	thePr->temp			->Init(theDialog,_9_,151,1);	SetItemValue( theDialog,_6_,absorpMean,3);	thePr->flag3 = 0;	thePr->flag2 = SwitchBoolean(theDialog,_5_,!g_absorpFlag);	thePr->flag3 = SwitchBoolean(theDialog,_7_,!thePr->flag3);	thePr->flag1 = SwitchBoolean(theDialog,_4_,!g_DebyeWaller);	thePr->flag1 = SwitchBoolean(theDialog,_10_,!dynamic_Calc);	thePr->oldScale = 0;	SetItemValue( theDialog,_8_,temperature,2);	SetItemValue(theDialog,_11_,kLineMult,2);	SetItemValue(theDialog,_12_,spotMult,2);}void DiffractObject::SFRead(DialogPtr theDialog,ML_StructFacParamsPtr thePr,Boolean saveData){	short i;	if(saveData){		absorpMean 		= GetItemValue( theDialog,_6_);				if(g_absorpFlag 	!= GetBoolean( theDialog,_5_))changedFlag = true;		g_absorpFlag 	= GetBoolean( theDialog,_5_);				if(g_StructureEV 	!= thePr->structure->lastResult - 1)changedFlag = true;		g_StructureEV 	= thePr->structure->lastResult - 1;				if(g_DebyeWaller 	!= GetBoolean( theDialog,_4_))changedFlag = true;		g_DebyeWaller 	= GetBoolean( theDialog,_4_);				if(calcDW  	!= GetBoolean(theDialog,_7_))changedFlag = true;		calcDW	  		= GetBoolean( theDialog,_7_);				if(dynamic_Calc  	!= GetBoolean(theDialog,_10_))changedFlag = true;		dynamic_Calc  	= GetBoolean(theDialog,_10_);				if(temperature 	!= ConvertTemps(GetItemValue( theDialog,_8_),0,thePr->temp->lastResult - 1) && calcDW)changedFlag = true;		temperature 	= ConvertTemps(GetItemValue( theDialog,_8_),0,thePr->temp->lastResult - 1);		if(kLineMult != GetItemValue(theDialog,_11_))changedFlag = true;			kLineMult = GetItemValue(theDialog,_11_);		if(spotMult	!= GetItemValue(theDialog,_12_))changedFlag = true;			spotMult = GetItemValue(theDialog,_12_);		if(calcDW){			for(i = 0; i < 4;i++)				theCrystal[i]->CorrectDWToTemp(temperature + 273.15);		}	}	thePr->temp->DoClose();	thePr->structure->DoClose();	KillPtr((Ptr)thePr);	}Boolean DiffractObject::SFHit(DialogPtr theDialog,short theSelect,ML_StructFacParamsPtr thePr,Boolean *saveData){	short newScale;	switch(theSelect){				case -1:				case 2:					*saveData = false;					return true;				case 1:					*saveData = true;										return true;					break;				case _4_:					thePr->flag1 = SwitchBoolean(theDialog,_4_,thePr->flag1);					break;				case _5_:					thePr->flag2 = SwitchBoolean(theDialog,_5_,thePr->flag2);					break;				case _7_:					thePr->flag3 = SwitchBoolean(theDialog,_7_,thePr->flag3);					break;				case _3_:					thePr->structure->DoPopUp();					break;				case _9_:					thePr->temp->DoPopUp();					newScale = thePr->temp->lastResult - 1;					if(newScale != thePr->oldScale)					{						SetItemValue( theDialog,_8_,ConvertTemps(GetItemValue( theDialog,_8_),newScale, thePr->oldScale),2);						thePr->oldScale = newScale;					}					break;				case _10_:					SwitchBoolean(theDialog,_10_,GetBoolean(theDialog,_10_));					break;				default:					break;				case ML_UPDATE_EVT:			DrawDialog(theDialog);			break;		}		*saveData = false;		return false;}void DiffractObject::StructureFactorSetUp(void)//bloch{	DialogPtr 	theDialog;	short				theSelect;	Boolean			quit = false;	Boolean			change = false; 	Boolean		saveData;	ML_StructFacParamsPtr thePr;		theDialog	= DM_GetNewDialog(1112,NUL,IN_FRONT);	SetPort(theDialog);	thePr = (ML_StructFacParamsPtr)D_NewPtr(sizeof(ML_StructFacParams));	SFSetUp( theDialog,thePr);	while(!quit){		ModalDialog(TheFilterUPP,&theSelect);				switch(theSelect){			case ML_UPDATE_EVT:				BeginUpdate(theDialog);			UpdtDialog(theDialog,theDialog->visRgn);			if(!gAppleEvtsOK){				HiliteOK(theDialog);			}			quit =  SFHit( theDialog, theSelect, thePr, &saveData);			EndUpdate(theDialog);			break;			default:			quit =  SFHit( theDialog, theSelect, thePr, &saveData);			break;			}	}	SFRead( theDialog,	thePr, saveData);	DM_DisposDialog(&theDialog);	}double ConvertTemps(double temp,short newScale,short oldScale)//bloch{	if(oldScale == newScale)return temp;	switch(oldScale){		case 0:		break;		case 1:			temp -= 273.15;		break;		case 2:			temp -= 32;			temp /= 1.8;		break;	}	switch(newScale){		case 0:		break;		case 1:			temp += 273.15;		break;		case 2:			temp *= 1.8;			temp += 32;		break;	}	return temp;}