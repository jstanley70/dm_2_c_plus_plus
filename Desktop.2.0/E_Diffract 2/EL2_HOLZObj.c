//s.Jim:Desktop.2.0:E_Diffract 2:EL2_HOLZObj.c#include	"Diffract_INCs.h"#include	"ST_StereoMacros.c"#include	"UT_VectorMacros.c"#include	"SF_MathLib.h"#include	"HOLZObj.h"#include	"COMPLEX.h"#include	"D_Handles.h"float	HOLZObj::RotateSpotsAroundZ(Point thePoint){	float rotAngle;	rotAngle	=	inherited::RotateSpotsAroundZ( thePoint);	if(rotAngle == 0.0) return 0.0;		ResetCurvedLabels();	return 0.0;	}short	AngleHOLZCompare(SpotInfo* spot1,SpotInfo* spot2);short	AngleHOLZCurveCompare(SpotInfo* spot1,SpotInfo* spot2);Boolean	HOLZObj::LabelAllLines(Boolean label){	double 				x,y;	Point 				thePoint,aPoint;	short 				i,displacement,j;	long 					data_Count_v;	SpotInfoPtr 	thisLine;	Rect					centerRect;	TextRoundObj* newLine;	TextObj			*line;		if(!IsPressed((unsigned short )58))return false;	D_HLock(theDataHandle);	thisLine 		= 	((SpotInfoPtr)*theDataHandle);	centerRect = thisLine->spotRect;	thisLine++;	ResetCurvedLabels();	newPictReq = true;	if(!label){		for(i = 1 ; i < data_Count; i++,thisLine++){			thisLine->flags -= TEXT_MASK;		} 		D_HUnlock(theDataHandle);		return true;	}				data_Count_v = data_Count - 1;	if(curvedLines){		qsort((Ptr)thisLine,(long)(data_Count_v),sizeof(SpotInfo),(_compare_function/*__cmp_func_Cmpfun**/)AngleHOLZCurveCompare);	}else{		qsort((Ptr)thisLine,(long)(data_Count_v),sizeof(SpotInfo),(_compare_function/*__cmp_func_Cmpfun**/)AngleHOLZCompare);	}x = 0;y = 2 * PI / (double)(data_Count - 1); for(i = 1 ; i < data_Count; i++,thisLine++, x += y){		thisLine->flags |= TEXT_MASK;		j = 1;		if(i % 2)j = -1;		if(!curvedLines){			thePoint.h = thisLine->spotRect.right;			thePoint.v = thisLine->spotRect.bottom;						displacement = 40 + 5 * (fabs((double)(thisLine->h + thisLine->k + thisLine->l))) +  j * 3;			if(displacement > 150)displacement = 150;			aPoint.h = thePoint.h + (displacement * sin(x));			aPoint.v = thePoint.v - (displacement * cos(x));			ObjToLocal(&aPoint);			if(!theLabels){				line = theLabels = (TextObj*)D_new(TextObj);				theLabels->DoInit(false,thisLine->theCrystal);				theLabels->InsertNewLoc(i,thisLine,aPoint);			}else{				line = theLabels->Add(i,thisLine,aPoint);			}			line->lineRect = thisLine->spotRect;			line->Draw(true);		}else{			thePoint =  IntersectionOvals(thisLine->spotRect,centerRect);			displacement = 40 + 5 * (fabs((double)(thisLine->h + thisLine->k + thisLine->l)))  +  j * 3;			if(displacement > 150)displacement = 150;			aPoint.h = thePoint.h + (displacement * sin(x));			aPoint.v = thePoint.v - (displacement * cos(x));			ObjToLocal(&aPoint);//necessary because labels are expecting local coordinates for point			if(!theCurvedLabels){				theCurvedLabels = (TextRoundObj*)D_new(TextRoundObj);					theCurvedLabels->DoInit(false,theCrystal[0]);					theCurvedLabels->InsertNewLoc(i,thisLine,aPoint);					newLine = theCurvedLabels;			}else{				newLine = theCurvedLabels->Add(i,thisLine,aPoint);			}			newLine->lineRect = thisLine->spotRect;			newLine->Draw(true);			theCurvedLabels->Draw(true);		}	}	D_HUnlock(theDataHandle);	return true;}short	AngleHOLZCompare(SpotInfo* spot1,SpotInfo* spot2){	Point aPoint,bPoint;	SpotInfoPtr theSpot;	short z1,z2;	theSpot = (SpotInfoPtr)*(gCurrentObj->theDataHandle);	aPoint.h = spot1->spotRect.right;	aPoint.v = spot1->spotRect.bottom;		bPoint.h = spot2->spotRect.right;	bPoint.v = spot2->spotRect.bottom;	PtToAngle(&theSpot->spotRect,aPoint,&z2);	PtToAngle(&theSpot->spotRect,bPoint,&z1);		return((short)((z1 > z2) ? -1 : ((z1 == z2) ? 0 : 1)));}short	AngleHOLZCurveCompare(SpotInfo* spot1,SpotInfo* spot2){	Point aPoint,bPoint;	SpotInfoPtr theSpot;	short z1,z2;	theSpot = (SpotInfoPtr)*(gCurrentObj->theDataHandle);	aPoint =  IntersectionOvals(spot1->spotRect,theSpot->spotRect);	bPoint =  IntersectionOvals(spot2->spotRect,theSpot->spotRect);	PtToAngle(&theSpot->spotRect,aPoint,&z2);	PtToAngle(&theSpot->spotRect,bPoint,&z1);		return((short)((z1 > z2) ? -1 : ((z1 == z2) ? 0 : 1)));}