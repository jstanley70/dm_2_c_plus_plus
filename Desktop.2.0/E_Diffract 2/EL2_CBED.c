//s.Jim:Desktop.2.0:E_Diffract 2:EL2_CBED.c#include	"Diffract_INCs.h"#include	"ST_StereoMacros.c"#include	"UT_VectorMacros.c"#include	"CBEDObj.h"#include 	"JCPDFCrystal.h"void  CBEDObj::DoPlace(void){	PicHandle	theNewPicture;	PictObj		*thePictObj;	short 		picType;	DialogPtr 	theDialog;	short 		theSelect;	PopUpMenu  *fileTypeMenu;	Boolean		quit;	long		theResult;	picType = 1;	if(!gCurrentObj->objectType || gCurrentObj->variSize == 0)		return;			theDialog	= DM_GetNewDialog(109,NUL,IN_FRONT);	fileTypeMenu 	= 	(PopUpMenu*)D_new(PopUpMenu);	picType = 1;	fileTypeMenu	->	Init(theDialog,4,35,picType);		while(!quit){		ModalDialog(TheFilterUPP,&theSelect);		switch(theSelect){			case -1:			case 2:				fileTypeMenu	->DoClose();				DM_DisposDialog(&theDialog);								quit = true;				return;			case 1:				fileTypeMenu	->DoClose();				DM_DisposDialog(&theDialog);				quit = true;				break;			case 4:				theResult = fileTypeMenu->DoPopUp();				picType = fileTypeMenu->lastResult;				break;						default:				break;		}	}	switch(picType)	{		case 1:			gTheFile->ReadFileOpen('PICT');			theNewPicture = gTheFile->ReadPICT();			gTheFile->DoFileClose();						if(theNewPicture != (PicHandle)NUL){				thePictObj = (PictObj*)D_new(PictObj);				thePictObj->DoInit((Handle)this);				CenterRects(theWindow->portRect,&(*theNewPicture)->picFrame);				thePictObj->AddPictObj(theNewPicture,&(*theNewPicture)->picFrame);				thePictObj->selected = true;			}			break;		case 2:			OpenTIFF();			break;		case 3:			OpenMCID();			break;		case 4:			OpenGeneral();			break;		}}void	CBEDObj::DoPictDraw(void){	Rect 		theOval,oldOval;	long 		theX,theY,				count=0;					SpotInfoPtr thisSpot;	short 		theIdent;	short		theSize;	double		intensityRange,x,y;	short		i;	short		theValue;	short		maxOrder[200];	double		thePeriod;	double 		diameter;	short		j,k;	Boolean		flag;	short		oldVal;		SetDrawEnviron();	if(!kikuchiLines)ResetCurvedLabels();	theSize 		= 	(double)scaleFactor * (double)theEBeam->convergenceAngle;	intensityRange 	= 	1. / (double)dyRange;	SetRect				(&oldOval,-theSize,-theSize,theSize,theSize);	thisSpot 		= 	(SpotInfoPtr)*theDataHandle;	PenMode			(gMode);	PlotKLines(thisSpot);//bloch	obj_Index->h 	=	thisSpot->h;	obj_Index->k 	=	thisSpot->k;	obj_Index->l 	=	thisSpot->l;	obj_Index->theCrystal = thisSpot->theCrystal;	obj_Index->reduceFlag = true;	obj_Index->direction	=	true;	thePeriod = (1/theZoneAxis->Periodicity( 1,cameraLength,wavelength,&diameter)) - (double)convergenceAngle;	j = -1;	for(i = 0 ; i < numSpots; i++,thisSpot++){		short zoneOrder;		theIdent = thisSpot->flags & CRYSTAL_MASK;		if(theIdent != 4 && !plotFlags[theIdent] && i > 1) continue;		if(showPeriods)PlotPeriods(0);		if(thisSpot->z > thePeriod && j < 200 && showPeriods && theIdent == baseCrystal){			zoneOrder = thisSpot->h * theZoneAxis->h + thisSpot->k * theZoneAxis->k + thisSpot->l * theZoneAxis->l;			flag = false;			k = 0;			while(k <= j)			{				if(zoneOrder == maxOrder[k])					flag = true;					k++;			}			j++;		 	maxOrder[j] = zoneOrder;		 	if(!flag)PlotPeriods(zoneOrder);					}				CalculateSpotLocation(&theX,&theY,thisSpot);			theOval = oldOval;		OffsetRect(&theOval,(short)theX,(short)theY);		theValue = theIdent;		if(greyFlag){			theValue = (short)(150 *  pow((double)thisSpot->intensity,intensityRange));		}		if(!calcIntensities || thisSpot->flags & BETH_PERTURB || (i != spotLoc && nOut == 1)){//Bloch				oldVal = theCrysSymbols_P[theIdent];//Bloch				if(thisSpot->flags & BETH_PERTURB){//Bloch					oldVal = theCrysSymbols_P[theIdent];//Bloch					DMForeColor(theIdent + 10);					dm_FrameOval(&theOval);				}else{					if(thisSpot->intensity < .001){						DMForeColor(theIdent + 10);						dm_FrameOval(&theOval);					}else{						if((thisSpot->flags & PRIME_MASK) && functionID == THRU_TILT_DY){							if(i == 0){								if(!acrossCenter){x = 1;y = 0;}								else {x = 0;y = 1;}							}else{									y = thisSpot->x / sqrt(thisSpot->x * thisSpot->x + thisSpot->y * thisSpot->y);									x = thisSpot->y / sqrt(thisSpot->x * thisSpot->x + thisSpot->y * thisSpot->y);							}							DMForeColor(theIdent + 10);							dm_FrameOval(&theOval);													MoveTo(theX - x * theSize,theY - y * theSize);							LineTo(theX + x * theSize,theY + y * theSize);						}else{							DM_DrawRect(theOval,theIdent,theValue,thisSpot->direction);//Bloch								theCrysSymbols_P[theIdent] = oldVal;//Bloch						}					}				}		}							thisSpot->spotRect = theOval;	}	thisSpot			= 				((SpotInfoPtr)*theDataHandle);//bloch		theSearchObj->PlotRings(scaleFactor,scaleFactor,centerX,centerY,0,500);	//if(graph)graph	->PlotGraph();	if(calcIntensities){		FullPlot(nOut,thisSpot);		FullPlot_MS(nOut,thisSpot);		return;	}//Bloch	ClearDrawEnviron();	}SpotInfoPtr		CBEDObj::InsertData(double H,double K, double L, double intens,double x2,double y2,double z2,double angle, Crystal *thisCrystal,short plotCrystal,dcomplex sF,SpotInfoPtr aSpot){	SpotInfoPtr thisSpot =   0L;	double theD,dummy;	dummy = angle;//warning;	thisSpot = inherited::InsertData( H, K,  L,  intens, x2, y2, z2,0, thisCrystal, plotCrystal, sF,thisSpot);	if(!thisSpot)return 0L;	--thisSpot;	aSpot = aSpot;	theD =  2 / (sqrt(x2 * x2 + y2 * y2 + thisSpot->z * thisSpot->z));	if(theD <  .000001) return thisSpot;	dummy = wavelength / theD;	if(fabs(dummy) > 1){		dummy = 1;	}	thisSpot->angle = (PI / 2.0) - asin(dummy);	return thisSpot;}